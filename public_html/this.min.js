// ThisJS version 1.0.0 (http://thisjs.com) | License (http://thisjs.com/#license) | (c) 2016 Ezra Obiwale
(function(){var Ajax=function(config,__){var __this=__||this;function parseData(data){if(!__this.isObject(data))
return data;var str='';__this.forEach(data,function(i,v){if(str)
str+='&';if(__this.isObject(v,true)){var isArray=__this.isArray(v);__this.forEach(v,function(j,w){if(j)
str+='&';if(isArray)
j=null;if(__this.isObject(w,true))
str+=i+'['+j+']='+parseData(w);else
str+=i+'['+j+']='+encodeURIComponent(w);});}
else
str+=i+'='+encodeURIComponent(v);});return str;}
config=__this.extend({type:'get',url:location.href,data:null,dataType:'json',success:function(){},error:function(){},complete:function(){},progress:function(e,loaded,total){},crossDomain:true,async:true,clearCache:false},config);var httpRequest=new XMLHttpRequest();httpRequest.onreadystatechange=function(){if(httpRequest.readyState===XMLHttpRequest.DONE){if(httpRequest.status>=200&&httpRequest.status<400){__this.callable(config.success).call(httpRequest,httpRequest.response);}
else{__this.callable(config.error).call(httpRequest);}
__this.callable(config.complete).call(httpRequest);}};if(config.clearCache){config.url+=((/\?/).test(config.url)?"&":"?")+(new Date()).getTime();}
if(config.type.toLowerCase()==='get'&&config.data&&__this.isObject(config.data)){config.url+=((/\?/).test(config.url)?"&":"?")+parseData(config.data);config.data=null;}
httpRequest.open(config.type.toUpperCase(),config.url,config.async);httpRequest.responseType=config.dataType;httpRequest.withCredentials=config.crossDomain;httpRequest.setRequestHeader('X-Requested-With','XMLHttpRequest');httpRequest.setRequestHeader('Requested-With','XMLHttpRequest');if(config.data)
httpRequest.setRequestHeader('Content-Type','application/x-www-form-urlencoded');__this.tryCatch(function(){httpRequest.upload.onprogress=function(e){if(e.lengthComputable){__this.callable(config.progress).call(httpRequest,e,e.loaded,e.total);}};});httpRequest.send(__this.isObject(config.data)?JSON.stringify(config.data):config.data);return httpRequest;},__=Object.create({items:[],debug:true,contains:function(item,str,all){var _this=this;return this.tryCatch(function(){if(_this.isObject(item,true)){var found=false;_this.forEach(item,function(i,v){if(_this.contains(v,str,all)){found=true;return false;}});return found;}
if(this.isString(str))
return _this.isString(item)&&item.indexOf(str)!==-1;else if(this.isArray(str)){var found=true;this.forEach(str,function(i,v){found=_this.contains(item,v,all);if(!all&&found){return false;}
else if(all){return found;}});return found;}});},callable:function(callback,nullable){if(this.isFunction(callback)){return callback;}
else if(this.isString(callback)){var split=callback.split('.'),func=window;for(var i=0;i<split.length;i++){if(!func[split[i]]){return this.callable(null,true);}
func=func[split[i]];}
return func===window?this.callable(null,true):this.callable(func);}
else if(!nullable){return function(){};}},each:function(callback){return this.forEach(this.items,callback);},forEach:function(items,callback){return this.tryCatch(function(){if(this.isObject(items)&&items instanceof _)
items=items.items;if(this.isArray(items))
items.every(function(v,i){return false!==this.callable(callback).call(v,i,v);}.bind(this));else{for(var a in items){if(!items.hasOwnProperty(a))
continue;if(false===this.callable(callback).call(items[a],a,items[a]))
break;}}
return this;});return this;},isObject:function(item,allowArray){return typeof item==='object'&&(allowArray||!Array.isArray(item));},isArray:function(item){return typeof item==='object'&&Array.isArray(item);},isString:function(item){return typeof item==='string';},isBoolean:function(item){return item===true||item===false;},isFunction:function(item){return typeof item==='function';},arrayRemoveValue:function(array,item,all){return this.tryCatch(function(){var index=array.indexOf(item);if(index<0){index=array.indexOf(parseInt(item));}
if(!all){return index>-1?[this.arrayRemove(array,index)]:[];}
else{while(index>-1){this.arrayRemove(array,index);index=array.indexOf(item);if(index<0)
index=array.indexOf(parseInt(item));}}
return array;});},arrayRemove:function(array,index){return this.tryCatch(function(){return array.splice(index,1)[0];});},show:function(){return this.each(function(){if(this.style.display==='none')
this.style.display='inherit';});},hide:function(){return this.each(function(){this.style.display='none';});},toggle:function(){var _this=this;this.each(function(){if(this.style.display==='none'){_(this,_this.debug).show();}
else{_(this,_this.debug).hide();}});return this;},hasAttr:function(attr){return this.tryCatch(function(){return this.attr(attr)!==null;});},attr:function(attr,val){return this.tryCatch(function(){if(val!==undefined){this.each(function(){this.setAttribute(attr,val);});return this;}
if(!this.items.length)
return null;return attr?this.items[0].getAttribute(attr):Array.from(this.items[0].attributes);});},removeAttr:function(attr){return this.each(function(){this.removeAttribute(attr);});},data:function(key,value){if(value){this.each(function(){if(this.dataset)
this.dataset[key]=value;});return this;}
if(!this.items.length||!this.items[0].dataset)
return null;value=this.items[0].dataset[key];return this.tryCatch(function(){return eval(value);},function(){return value;});},extend:function(object,_){var args=Array.from(arguments),newObject={},newArray=[],_this=this;this.forEach(args,function(){if(_this.isArray(this))
newArray.concat(this);else if(_this.isObject(this)){_this.forEach(this,function(i,v){newObject[i]=v;});}});return newArray.length?newArray:newObject;},ajax:function(config){config=this.extend({type:'get',url:location.href,data:{},success:function(data){},error:function(){},complete:function(){}},config);return Ajax(config,this);},on:function(event,selector,callback){if(arguments.length===2){callback=selector;selector=null;}
var _this=this;return this.each(function(){var target=this;_this.forEach(event.split(','),function(i,v){target.addEventListener(v.trim(),function(e){if(selector&&e.target&&!e.target.matches(selector)){return;}
_this.callable(callback).apply(e.target,Array.from(arguments));},false);});});return this;},trigger:function(event,detail){var data={detail:detail,cancelable:true,bubbles:true},ev=new CustomEvent(event,data);return this.each(function(){this.dispatchEvent(ev);});},children:function(selector){var result=[];this.each(function(){if(selector){var id=false;if(!this.id){this.id='rANd'+Math.ceil(Math.random()*100);id=true;}
result=result.concat(Array.from(document.querySelectorAll('#'
+this.id+'>'+selector)));if(id)
this.removeAttribute('id');return;}
result=result.concat(Array.from(this.children));});return _(result,this.debug);},innerWrap:function(elem){var _this=this;return this.each(function(){var __this=_(this);__this.html(_this.createElement(elem).html(__this.html()));});},outerHtml:function(){return this.tryCatch(function(){return this.items.length?this.items[0].outerHTML:'';});},html:function(content){if(content===undefined){return this.tryCatch(function(){return this.items.length?this.items[0].innerHTML:'';});}
var _this=this;return this.each(function(){if(content instanceof _){content=content.outerHtml();}
else if(_this.isObject(this.content)&&this.content['outerHTML']){content=this.content.outerHTML;}
this.innerHTML=content;});},prepend:function(content){var _this=this;return this.each(function(){var __this=this,doc=document.createElement(this.tagName);if(content instanceof _){content.each(function(){doc.appendChild(this);});}
else if(_this.isObject(content)&&content['outerHTML']){doc.appendChild(content);}
else{doc.innerHTML=content;}
if(doc.childElementCount){_this.forEach(Array.from(doc.children),function(){__this.prepend(this);});}
else{this.innerHTML=doc.innerHTML+this.innerHTML;}});},append:function(content){var _this=this;return this.each(function(){var __this=this,doc=document.createElement(this.tagName);if(content instanceof _){content.each(function(){doc.appendChild(this);});}
else if(_this.isObject(content)&&content['outerHTML']){doc.appendChild(content);}
else{doc.innerHTML=content;}
if(doc.childElementCount){_this.forEach(Array.from(doc.children),function(){__this.appendChild(this);});}
else{this.innerHTML+=doc.innerHTML;}});},remove:function(){var removed=[];this.each(function(){if(this.parentElement)
removed.push(this.parentElement.removeChild(this));});return _(removed,this.debug);},clone:function(){return this.tryCatch(function(){return _(this.items.length?this.items[0].cloneNode(true):[],this.debug);});},find:function(selector){var result=[],_this=this;this.each(function(){if(_this.items.length>1){result=result.concat(Array.from(this.querySelectorAll(selector)));}
else
result=Array.from(this.querySelectorAll(selector));});return _(result,this.debug);},filter:function(func){var _this=this,filtered=this.items.filter(function(v,i){func=_this.callable(func);return func?func.call(v,i,v):true;});return _(filtered,this.debug);},closest:function(selector){return this.tryCatch(function(){return _(this.items.length?this.items[0].closest(selector):[],this.debug);});},parent:function(){var parents=[];this.each(function(){parents.push(this.parentElement);});return _(parents,this.debug);},get:function(index){return this.items[index];},replaceWith:function(content){var replaced=[];content=_(content,this.debug);this.each(function(){var _content=content.items[0];if(!_content)
return;this.replaceWith(_content);replaced.push(_content);});return _(replaced,this.debug);},error:function(message){if(this.debug)
console.error(message);return this;},toObject:function(string){return this.tryCatch(function(){return JSON.parse(string);});},toJSON:function(object){return this.tryCatch(function(){return JSON.stringify(object);});},createElement:function(str){var d=document.createElement('div');d.innerHTML=str;return _(Array.from(d.children),this.debug);},is:function(selector){if(!this.items.length)
return false;var el=this.items[0];return(el.matches||el.matchesSelector||el.msMatchesSelector||el.mozMatchesSelector||el.webkitMatchesSelector||el.oMatchesSelector).call(el,selector);},val:function(value){var val;this.each(function(){if(value){this.value=value;return;}
val=this.value;});return value?this:val;},prop:function(prop,value){return this.tryCatch(function(){if(value){this.each(function(i,v){v[prop]=value;});return this;}
return prop&&this.items.length?this.items[0][prop]:null;});},addClass:function(className){var _this=this;return this.each(function(){var __this=this;_this.forEach(className.split(' '),function(i,v){__this.classList.add(v);});});},removeClass:function(className){return this.each(function(){this.classList.remove(className);});},hasClass:function(className){var has=true,_this=this;this.each(function(){if(!this.classList.length||!_this.contains(Array.from(this.classList),className)){has=false;return false;}});return has;},toggleClass:function(className){return this.each(function(){var _this=_(this);if(_this.hasClass(className))
_this.removeClass(className);else
_this.addClass(className);});return this;},siblings:function(selector){var siblings=[];this.each(function(){var rId=false;if(!this.id){this.id='rANd'+Math.ceil(Math.random()*100);rId=true;}
siblings=siblings.concat(_(this.parentElement,this.debug).children((selector||'')+':not(#'+this.id+')').items);if(rId)
this.removeAttribute('id');});return _(siblings,this.debug);},tryCatch:function(tryCallback,catchCallback){try{return this.callable(tryCallback).call(this);}
catch(e){if(!catchCallback)
this.error(e.message);else
return this.callable(catchCallback).call(this,e);}}}),_=function(selector,debug){if(!(this instanceof _)){return new _(selector,debug);}
else if(selector instanceof _){return selector;}
else if(!selector){this.items=[];}
else if(this.isObject(selector)){this.items=selector instanceof HTMLCollection?Array.from(selector):[selector];}
else if(this.isArray(selector)){this.items=selector;}
else if(this.isString(selector)){var _this=this.createElement(selector);if(_this.length)
return _this;this.items=Array.from(document.querySelectorAll(selector));}
else{this.error('Invalid selector');}
this.__proto__.debug=debug!==false?true:false;this.length=this.items.length;return this;},internal=Object.create({call:function(_this,method,param){var args=Array.from(arguments);__.arrayRemove(args,0);__.arrayRemove(args,0);return this[method].apply(_this,args);},setup:function(){this.tryCatch(function(){var _this=this;this.__.__proto__.debug=this.config.debug;if(this.config.paths){this.__.forEach(this.config.paths,function(i,v){if(!v.endsWith('/')&&i!=='ext')
_this.config.paths[i]=v+'/';});}
if(!this.notFound)
this.notFound=function(){if(_this.firstPage){if(_this.store('last_page')){var last_page=_this.store('last_page');_this.store('last_page',null);_this.loadPage(last_page);}
else if(_this.config.startWith){if(this._('page[this-id="'+_this.config.startWith
+'"]:not([this-current]):not([this-dead]),'
+'[this-type="pages"]>[this-id="'
+_this.config.startWith+'"]').length)
_this.loadPage(_this.config.startWith);}
else{var startWith=_this._('[this-default-page]');if(startWith.length)
_this.loadPage(startWith.attr('this-id'));}}};this.container.find('page,model,collection,layout,component,[this-type]').attr('this-loaded','');if(!this._('[this-type="pages"]').length){this._('body').append('<div this-type="pages" style="display:none"/>').find('[this-type="pages"]').append(this._('[this-type="page"]:not([this-loaded])').hide());}
if(this._('[this-type="component"]').length&&!this._('[this-type="components"]').length){this._('body').append('<div this-type="components" style="display:none"/>').find('[this-type="components"]').append(this._('[this-type="component"]').hide());}
if(this._('[this-type="layout"]').length&&!this._('[this-type="layouts"]').length){this._('body').append('<div this-type="layouts" style="display:none"/>').find('[this-type="layouts"]').append(this._('[this-type="layout"]:not([this-loaded])').hide());}
this._('page:not([this-loaded]),model:not([this-loaded]),'
+'collection:not([this-loaded]),layout:not([this-loaded]),'
+'component:not([this-loaded]),[this-type]:not([this-loaded])').hide();if(this.config.titleContainer)
this.config.titleContainer=this._(this.config.titleContainer,this.config.debug);this.container.on('click','[this-reload]',function(e){e.preventDefault();var __this=_this._(this);if(!__this.attr('this-reload')){_this.error('What to reload isn\'t specified.');return;}
var reload=__this.attr('this-reload'),toReload=_this._(internal.selector.call(_this,reload,':not([this-loaded])')),_reload=_this.page.find(internal.selector.call(_this,reload,'[this-loaded]'));if(!toReload.length){_this.error('Reload target not found');return;}
if(__this.attr('this-attributes'))
_this.__.forEach(__this.attr('this-attributes').split(';'),function(i,v){var attr=v.split(':'),name=_this.__.arrayRemove(attr,0);attr=attr.join(':');toReload.attr(name,attr);});_reload.replaceWith(toReload.clone().removeAttr('this-cache'));internal.loadCollections.call(_this,true);}).on('click','[this-go-home]',function(e){_this.home();e.stop=true;}).on('click','[this-go-back]',function(e){_this.back(e);e.stop=true;}).on('click','[this-go-forward]',function(e){_this.forward(e);e.stop=true;}).on('click','[this-goto][this-read]',function(e){var __this=_this._(this),_model=__this.closest('model,[this-type="model"]'),_collection=__this.closest('collection,[this-type="collection"]'),model_name=__this.attr('this-model')||_model.attr('this-id')||_collection.attr('this-model'),model_id=_model.attr('this-mid'),url=__this.attr('this-read')||_model.attr('this-url')||'#',goto=__this.attr('this-goto').split('#')[0],page_template=_this._('page[this-id="'+goto
+'"]:not([this-current]):not([this-dead]),[this-type="pages"]'
+' [this-id="'+goto+'"]'),page_template_model=page_template.find('model[this-id="'
+model_name+'"],[this-type="model"][this-id="'
+model_name+'"]'),page_template_model_template=page_template.find('[this-component="'+model_name+'"]');page_template.attr('this-tar','reading:true');if(page_template_model.length)
page_template_model.attr('this-url',url).attr('this-mid',model_id);else if(page_template_model_template.length)
page_template_model_template.attr('this-tar','url:'+url
+';mid:'+model_id);}).on('click','[this-goto][this-update]',function(){var __this=_this._(this),model=__this.closest('model,[this-type="model"]'),model_id=model.attr('this-mid'),model_name=__this.attr('this-model')||model.attr('this-id'),url=__this.attr('this-update')||model.attr('this-url')||'#',tar='do:update;mid:'+model_id+';action:'+url
+';model:'+model_name,goto=__this.attr('this-goto').split('#')[0],_target=_this._('page[this-id="'+goto
+'"]:not([this-current]):not([this-dead]),[this-type="pages"] [this-id="'
+goto+'"]');if(model.attr('this-uid'))
tar+=';model-uid:'+model.attr('this-uid');if(!_target.is('form'))
_target=_target.find('form');_target.attr('this-tar',tar);}).on('click','[this-goto][this-create]',function(){var __this=_this._(this),url=__this.attr('this-create')||'#',tar='do:create;action:'+url,goto=__this.attr('this-goto').split('#')[0],_target=_this._('[this-id="'+goto+'"]');if(__this.attr('this-model'))
tar+=';model:'+__this.attr('this-model');if(__this.attr('this-model-uid'))
tar+=';model-uid:'+__this.attr('this-model-uid');if(!_target.is('form'))
_target=_target.find('form');_target.attr('this-tar',tar);}).on('click','[this-goto][this-delete]',function(){var __this=_this._(this),model=__this.closest('model,[this-type="model"]'),url=__this.attr('this-delete')||model.attr('this-url')||'#',model_name=__this.attr('this-model')||model.attr('this-id'),uid=model.attr('this-uid'),goto=__this.attr('this-goto').split('#')[0],tar='do:delete;uri:'+url+';uid:'+uid;if(model)
tar+=';model:'+model_name;_this._('[this-id="'+goto+'"]').attr('this-tar',tar);}).on('click','[this-goto]',function(e){e.preventDefault();var __this=_this._(this);if(!__this.attr('this-goto'))
return;_this.page.trigger('page.leave');var goto=internal.pageIDFromLink.call(this,__this.attr('this-goto')),page=_this._('page[this-id="'+goto
+'"]:not([this-current]):not([this-dead]),[this-type="pages"]'
+' [this-id="'+goto+'"]'),tar=page.attr('this-tar')||'';if(__this.attr('this-page-title'))
tar=tar?tar+';title:'+
__this.attr('this-page-title'):'title:'+__this.attr('this-page-title');if(__this.attr('this-ignore-cache'))
tar=tar?tar+';ignore-cache:'+
__this.attr('this-ignore-cache'):'ignore-cache:'+
__this.attr('this-ignore-cache');if(tar)
page.attr('this-tar',tar);_this.loadPage(goto);e.stop=true;}).on('click','[this-delete]',function(e){if(e.stop)
return;e.preventDefault();var __this=_this._(this);var _model=__this.closest('model,[this-type="model"]'),_do=__this.closest('[this-do="delete"]'),__model=new Model({id:_model.attr('this-mid')},{app:_this,name:__this.attr('this-model')||_model.attr('this-id')||_do.attr('this-model'),uid:_model.attr('this-uid')||_do.attr('this-uid')||'id',url:__this.attr('this-delete')||_model.attr('this-url')||_do.attr('this-uri'),method:'delete'});if(false===this.__.callable(this.beforeDelete).call(this,__model,_model.items[0])){_model.trigger('delete.canceled');return;}
__model.remove(false,function(data){var model=_this.config.dataKey?data[_this.config.dataKey]:data;if(model){if(_this.page.attr('this-do')==='delete')
_this.back();else{_this.page.find('[this-binding]').hide();}
__this.trigger('delete.success',{response:this,responseData:data});}
else
__this.trigger('delete.failed',{response:this,responseData:data});},function(){__this.trigger('delete.error',{response:this});},function(){__this.trigger('delete.complete',{response:this});});}).on('click','[this-bind]',function(e){e.preventDefault();var __this=_this._(this),bind=__this.attr('this-bind'),_model=__this.closest('model,[this-type="model"],[this-model]');if(!bind)
return;var _target=_this.page.find(internal.selector.call(_this,bind,':not([this-in-collection])'));if(!_target.length)
return;_target.attr('this-model',(_model.attr('this-model')||_model.attr('this-id'))).attr('this-binding','');if(__this.hasAttr('this-read'))
_this.page.find('[this-model="'+(_model.attr('this-model')||_model.attr('this-id'))+'"][this-binding]').hide();if(__this.hasAttr('this-update'))
_target.attr('this-tar','do:update');if(__this.hasAttr('this-create'))
_target.attr('this-tar','do:create');internal.bindToModel.call(_this,_target,_model,__this.attr('this-cache'));}).on('click','[this-toggle]',function(e){e.preventDefault();_this.container.find(internal.selector.call(_this,_this._(this).attr('this-toggle'))).toggle();internal.saveState.call(_this,true);}).on('click','[this-hide]',function(e){e.preventDefault();_this.container.find(internal.selector.call(_this,_this._(this).attr('this-hide'))).hide();internal.saveState.call(_this,true);}).on('click','[this-show]',function(e){e.preventDefault();var __this=_this._(this),_target=_this.container.find(internal.selector.call(_this,__this.attr('this-show')));if(__this.attr('this-create')){_this.page.find('[this-binding]').hide();var form=_target.is('form[this-model="'
+__this.attr('this-model')+'"]')?_target:_target.find('form[this-model="'
+__this.attr('this-model')+'"]');form.attr('this-do','create').attr('this-url',__this.attr('this-create')).attr('this-binding','');if(__this.attr('this-model-uid'))
form.attr('this-model-uid',__this.attr('this-model-uid'));form.removeAttr('this-mid');form.get(0).reset();}
_target.show();internal.saveState.call(_this,true);}).on('submit','form[this-do="create"]:not([this-ignore-submit]),'
+' form[this-do="update"]:not([this-ignore-submit])',function(e){e.preventDefault();var data={},__this=_this._(this),creating=__this.attr('this-do')==='create',method=creating?'post':'put';if(!this.reportValidity()){__this.trigger('form.invalid.submission');return;}
__this.trigger('form.valid.submission');_this.__.forEach(Array.from(this.elements),function(){if(!this.name)
return;if(this.name.indexOf('[]')!==-1){var name=this.name.replace('[]','');if(!data[name]){data[name]=[];}
data[name].push(this.value);}
else if(this.name.indexOf('[')!==-1){var exp=this.name.replace(']','').split('['),_data=data,lastKey=exp.pop();_this.__.forEach(exp,function(i,v){if(!_data[v])
_data[v]={};_data=_data[v];});_data[lastKey]=this.value;}
else{data[this.name]=this.value;}});if(__this.attr('this-mid'))
data['id']=__this.attr('this-mid');var _model=new Model(data,{app:_this,name:__this.attr('this-model'),uid:__this.attr('this-uid'),url:__this.attr('this-action')||__this.attr('this-url'),method:method});_model.save(_model.url===null,function(data){var model=_this.config.dataKey?data[_this.config.dataKey]:data;if(model){if(creating)
__this.items[0].reset();if(!__this.hasAttr('this-binding')&&!__this.closest('[this-binding]').length&&creating)
_this.back();__this.trigger('form.submission.success',{response:this,responseData:data,method:method.toUpperCase()});}
else{__this.trigger('form.submission.failed',{response:this,responseData:data,method:method.toUpperCase()});}},function(){__this.trigger('form.submission.error',{response:this,method:method.toUpperCase()});},function(){__this.trigger('form.submission.complete',{response:this,method:method.toUpperCase()});});}).on('submit','form[this-do="search"]',function(e){e.preventDefault();var _form=_this._(this),_search=_form.find('[this-search]');if(!_search.attr('this-search')){_this.error('Invalid search target');return;}
var exp=_search.attr('this-search').split(':'),selector='collection[this-id="'+exp[0]
+'"],[this-type="collection"][this-id="'+exp[0]+'"]',keys=exp[1],goto=_form.attr('goto')||_form.closest('page,[this-type="page"]').attr('this-id'),_page=_this._('page[this-id="'+goto
+'"]:not([this-current]):not([this-dead]),[this-type="page"][this-id="'
+goto+'"]:not([this-current]):not([this-dead])'),_collection=_page.find(selector),_component=_page.find('[this-component="'+exp[0]+'"]'),filter='',tar='query:'+_search.val().trim();if(_search.attr('this-ignore-cache'))
tar+=';ignore-cache:'+_search.attr('this-ignore-cache');if(keys)
keys=keys.split(',');_this.__.forEach(keys,function(i,key){if(filter)
filter+=' || ';filter+='_this.__.contains(filters.lcase(model#'+key
+'),filters.lcase("'+_search.val()+'"))';});_page.attr('this-tar',tar);_collection.attr('this-filter',filter).attr('this-search',keys.join(','));_component.attr('this-filter','collection#'+exp[0]+':'+filter).attr('this-search','collection#'+exp[0]+':'
+keys.join(','));var replaceState=_this.page.attr('this-id')===goto&&_this.page.attr('this-query')===_search.val().trim();_this.loadPage(goto,replaceState);});this._('[this-go-home]').on('click',function(e){_this.home();});this._('[this-go-back]').on('click',function(e){if(!e.stop)
_this.back(e);});this._('[this-go-forward]').on('click',function(e){if(!e.stop)
_this.forward(e);});this._(window).on('popstate',function(e){if(e.state)
internal.restoreState.call(_this,e.state);});this.__.forEach(this.events,function(){_this.container.on(this.event,this.selector,this.callback);});});this.__proto__.running=true;return this;},pageIDFromLink:function(link){if(link.startsWith('#'))
link=link.substr(1);var parts=link.split('&');if(parts.length>1)
this.target_on_page=parts[1];return parts[0];},resolveTargetOnPage:function(){delete this.target_on_page;},bindToModel:function(_target,_model,ignoreCache){this.binding=true;var _this=this,model_name=_model.is('model')||_model.attr('this-type')==='model'?_model.attr('this-id'):_model.attr('this-model'),model;if(!_model.attr('this-mid')){this.error('Model to bind to does not have an id');return;}
_target.attr('this-mid',_model.attr('this-mid')).attr('this-uid',_model.attr('this-uid')).attr('this-url',_model.attr('this-url'));if(!ignoreCache){model=internal.modelFromStore.call(_this,_model.attr('mid'),model_name);}
if(model){internal.bindData.call(_this,model,_target);_target.trigger('variables.binded',{data:model});}
else{this.request(_model.attr('this-url'),function(data){data=_this.config.dataKey?data[_this.config.dataKey]:data;internal.bindData.call(_this,data,_target);_target.trigger('variables.binded',{data:data});});}
return this;},bindData:function(data,_target){internal.loadModel.call(this,_target,data,true);internal.loadForms.call(this,_target.is('form')?_target:_target.find('form'),data);return this;},doTar:function(__this,noShow){if(__this.attr('this-tar')){var tar=__this.attr('this-tar').split(';');this.__.forEach(tar,function(i,v){var split=v.split(':');if(split.length<2)
return;__this.attr('this-'+split[0],split[1]);});}
if(!noShow)
__this.show();return __this.removeAttr('this-tar');},loadForms:function(forms,model){var _this=this,isPage=false;if(!forms){isPage=this.page.is('form');forms=isPage?this.page:this.page.find('form');}
forms.each(function(i){var __this=_this._(this),elements=Array.from(this.elements);if(__this.attr('this-do')==='search'&&_this.page.attr('this-query')){__this.find('[this-search]').val(_this.page.attr('this-query'));return;}
if(!isPage){_this._('page[this-id="'+_this.page.attr('this-id')
+'"]:not([this-current]):not([this-dead]) form:nth-child('+(i+1)
+'),[this-type="page"][this-id="'
+_this.page.attr('this-id')
+'"]:not([this-current]):not([this-dead]) form:nth-child('+(i+1)+')').removeAttr('this-tar');}
internal.doTar.call(_this,__this,true);if(!__this.attr('this-mid'))
return;if(!model)
model=internal.modelFromStore.call(_this,__this.attr('this-mid'),__this.attr('this-model')||__this.attr('this-id'));if(model)
internal.loadFormElements.call(_this,elements,model);__this.attr('this-loaded','').trigger('form.loaded');});return this;},loadFormElements:function(elements,model){if(!model)
return;var _this=this;this.__.forEach(elements,function(){var ___this=_this._(this),key=___this.attr('this-is');if(!key)
return;var data=_this.__.extend({},model),keys=_this.__.contains(key,'.')?keys=key.split('.'):keys=[key];_this.__.forEach(keys,function(i,v){data=data[v];});if(___this.attr('type')==='radio'||___this.attr('type')==='checkbox'){___this.prop('checked',___this.prop('value')==data);return;}
___this.val(data);});return this;},loadComponents:function(){var _this=this,components=this.page.find('[this-component]');this.__proto__.components+=components.length;components.each(function(){var __this=_this._(this);if(__this.attr('this-url')){_this.request(__this.attr('this-url'),function(data){internal.loadComponent.call(_this,__this,_this._(data),true);},function(){},{},'text');}
else{var component=_this._('component[this-id="'
+__this.attr('this-component')
+'"]:not([this-loaded]),[this-type="component"][this-id="'
+__this.attr('this-component')
+'"]:not([this-loaded]),[this-type="components"]>[this-id="'
+__this.attr('this-component')+'"]').clone();internal.loadComponent.call(_this,__this,component);}});return this;},loadComponent:function(__this,component){var _this=this,collection_id;if(__this.attr('this-tar'))
internal.doTar.call(this,component.attr('this-tar',__this.attr('this-tar'))).attr('this-loaded','');this.__.forEach(__this.attr(),function(i,attr){if(attr.name==='this-component'||attr.name==='this-url')
return;if((attr.name==='this-filter'||attr.name==='this-search')&&_this.__.contains(attr.value,':')){var split=attr.value.split(':'),target=_this.__.arrayRemove(split,0),value=split.join(':'),selector='[this-id="'+target+'"]';if(_this.__.contains(target,'#')){split=target.split('#');selector=split[0]+'[this-id="'+split[1]
+'"],[this-type="'+split[0]
+'"][this-id="'+split[1]+'"]';collection_id=split[1];}
component.find(selector).attr(attr.name,value);return;}
component.attr(attr.name,attr.value);});if(!component.attr('this-type'))
component.attr('this-type','component');if(component.attr('this-type')==='component'||component.is('component')){component.attr('this-loaded','').show();}
else{component.hide();}
__this.replaceWith(component).trigger('component.loaded');this.__proto__.components--;},loadCollections:function(replaceState){var _this=this;if(this.components){setTimeout(function(){internal.loadCollections.call(_this,replaceState);},300);return;}
var ignore=_this.page.attr('this-ignore-cache')||'',collections=this.page.find('collection:not([this-loaded])'
+':not([this-cache]),'
+'[this-type="collection"]:not([this-loaded]):not([this-cache])');this.__proto__.collections+=collections.length;collections.each(function(){var __this=_this._(this).addClass('loading'),content=__this.html(),cached=internal.cache.call(_this,'model',__this.attr('this-id')),model_name=__this.attr('this-model');if(!_this._('collection[this-id="'+__this.attr('this-id')+'"]:not(.loading),[this-type="collection"][this-id="'
+__this.attr('this-id')+'"]:not(.loading)').length){_this.page.append(__this.clone().removeAttr('this-loaded').removeClass('loading').attr('this-cache','').hide());}
__this.removeClass('loading');__this.children().attr('this-cache',__this.attr('this-model')||'').hide();if(model_name&&_this.page.find('model[this-id="'+model_name
+'"],[this-type="model"][this-id="'+model_name
+'"]').length){_this.page.find('model[this-id="'+model_name
+'"],[this-type="model"][this-id="'+model_name+'"]').attr('this-bind',true);}
if(!_this.__.contains(ignore,'collection#'+__this.attr('this-id'))&&cached&&cached.length&&((cached.expires&&cached.expires<Date.now())||!cached.expires)){_this.__proto__.collections--;var data={};if(_this.config.dataKey)
data[_this.config.dataKey]=cached.data;else
data=cached.data;internal.loadData.call(_this,this,data,content,false,false);__this.attr('this-loaded','').trigger('collection.cache.loaded');internal.pageLoaded.call(_this,replaceState);}
else{var data={},save=true;if(_this.page.attr('this-query')){data['query']=_this.page.attr('this-query');save=false;}
if(__this.attr('this-search')){data['keys']=__this.attr('this-search');}
_this.request(this,function(data){_this.__proto__.collections--;internal.loadData.call(_this,this,data,content,false,save);__this.attr('this-loaded','').trigger('collection.loaded');internal.pageLoaded.call(_this,replaceState);},function(){},data);}});return this;},loadModel:function(_model,data,replaceState){var __this=this._(_model),ignore=this.page.attr('this-ignore-cache')||'',content=__this.html(),_this=this;if(!data&&!__this.attr('this-url')){this.__proto__.models--;return;}
if(__this.attr('this-tar'))
internal.doTar.call(this,__this);if(__this.siblings('[this-cache="'+__this.attr('this-id')+'"]').length){content=__this.siblings('[this-cache="'+__this.attr('this-id')+'"]').html();}
else
__this.parent().append('<div this-cache="'+__this.attr('this-id')
+'" style="display:none">'+content+'</div>');if(!data&&!_this.__.contains(ignore,'model#'+__this.attr('this-id'))){data=internal.modelFromStore.call(this,__this.attr('this-mid'),__this.attr('this-id'));if(data)
--this.__proto__.models;}
if(data){if(this.config.dataKey){var _m={};_m[this.config.dataKey]=data;data=_m;}
internal.loadData.call(this,__this,data,content,true,false);__this.attr('this-loaded','').trigger('model.cache.loaded');internal.pageLoaded.call(this,replaceState);return;}
this.request(this,function(data){--_this.__proto__.models;internal.loadData.call(_this,this,data,content,true,true);__this.attr('this-loaded','').trigger('model.loaded');internal.pageLoaded.call(_this,replaceState);});},loadModels:function(replaceState){var _this=this;if(this.components){setTimeout(function(){internal.loadModels.call(_this,replaceState);},300);return;}
var models=this.page.find('model:not([this-in-collection]),'
+'[this-type="model"]:not([this-in-collection])');this.__proto__.models+=models.length;models.each(function(){internal.loadModel.call(_this,this,null,replaceState);});return this;},cache:function(type,id,data,update){if(!type)
return this.store();var __data=this.store(type.toLowerCase())||{};if(!data){if(!id)
return __data;return __data?__data[id]:[];}
if(update){if(__data)
__data[id]=__data[id]?this.__.extend(__data[id],data):data;}
else
__data[id]=data;this.store(type.toLowerCase(),__data);return this;},clearCache:function(type,id){if(!type){localStorage.clear();return this;}
if(!id){localStorage.removeItem(type.toLowerCase());return this;}
var data=internal.cache.call(this,type.toLowerCase());delete data[id];return this.store(type.toLowerCase(),data);},modelFromStore:function(model_id,model_name){return this.tryCatch(function(){var _collection=internal.cache.call(this,'model',model_name);return _collection.data[model_id];});},modelToStore:function(model,model_name,uid){return this.tryCatch(function(){var collection=internal.cache.call(this,'model',model_name)||{data:{},uid:uid};if(!collection.data[model[collection.uid||uid]])
collection.length++;collection.data[model[collection.uid||uid]]=model;internal.cache.call(this,'model',model_name,collection);return this;});},removeModelFromStore:function(model_id,collection_id){this.tryCatch(function(){var collection=internal.cache.call(this,'model',collection_id);delete collection.data[model_id];internal.cache.call(this,'model',collection_id,collection,true);return this;});},fullyFromURL:function(type,id,success,error){if(!this.config.paths){this.__.callable(error).call(this);return;}
var _this=this,url=this.config.paths[type+'s']+id+this.config.paths.ext;if(this.config.debug)
url+='?'+Math.ceil(Math.random()*9999);this.request(url,function(data){var elem=_this.__.createElement(data);if(!elem.length||elem.length>1||((!elem.is(type)||elem.attr('this-type')!==type)&&elem.hasAttr('this-id')&&elem.attr('this-id')!==id)){elem=_this._('<div this-type="'+type+'" this-id="'
+id+'" />').html(data);}
if(!elem.attr('this-id'))
elem.attr('this-id',id);_this.__.callable(success).call(this,elem);},function(e){_this.__.callable(error).call(this,e);},{},'text');},notAPage:function(page){this.error('Page ['+page+'] not found');if(this.__.isString(this.notFound)){page=this._(internal.selector.call(this,this.notFound.startsWith('page#')?this.notFound:'page#'+this.notFound,':not([this-current]):not([this-dead])'));if(!page.length){return this.error('Page ['+this.notFound+'] also not found');}
internal.pageFound.call(this,page,true);return this;}
else
return this.__.callable(this.notFound).call(this,page);},pageFound:function(page,replaceInState){if(internal.is.call(this,'page',page)){if(false===this.__.callable(this.beforePage).call(this,page.items[0])){page.trigger('page.load.canceled');return this;}
if(this.page){this.oldPage=this.page.attr('this-dead','');if(this.oldPage.attr('this-id')===page.attr('this-id'))
replaceInState=true;}
this.page=page;if(this.page.attr('this-tar')){var _page=internal.doTar.call(this,this.page.clone());this.page.removeAttr('this-tar');this.page=_page;}else
this.page=this.page.clone();internal.loadLayouts.call(this,replaceInState);}
else{this.error('Load page failed: '+page.attr('this-id'));page.trigger('page.load.failed');}},loadLayouts:function(replaceInState){var _layout=_(),_this=this;if(this.config.layout||this.page.attr('this-layout')){var layout=this.page.attr('this-layout')||this.config.layout;_layout=this.container.find('layout[this-id="'+layout
+'"],[this-type="layout"][this-id="'+layout+'"]');_layout.find('[this-content]').html(this.page.show());if(!_layout.length){_layout=this._('[this-type="layouts"] layout[this-id="'+layout+'"],'
+'[this-type="layouts"] [this-type="layout"][this-id="'
+layout+'"]').clone();if(!_layout.length){internal.fullyFromURL.call(this,'layout',layout,function(_layout){_layout.removeAttr('this-url').find('[this-content]').html(_this.page);if(_layout.attr('this-extends'))
internal.extendLayout.call(_this,_layout,replaceInState);else
internal.finalizePageLoad.call(_this,_layout,replaceInState);},function(){this.error('Layout ['+layout+'] not found!');internal.finalizePageLoad.call(_this,_layout,replaceInState);});}
else{if(_layout.attr('this-url')){this.request(_layout.attr('this-url'),function(data){_layout.removeAttr('this-url').html(data).find('[this-content]').html(_this.page);if(_layout.attr('this-extends'))
internal.extendLayout.call(_this,_layout,replaceInState);else
internal.finalizePageLoad.call(_this,_layout,replaceInState);},function(){},{},'text');}
else{_layout.find('[this-content]').html(_this.page);internal.extendLayout.call(this,_layout,replaceInState);}}}
else
internal.finalizePageLoad.call(this,_layout,replaceInState);}
else{internal.finalizePageLoad.call(this,_layout,replaceInState);}},extendLayout:function(_layout,replaceInState){var __layout=_layout.clone(),_this=this;_layout=this.container.find('layout[this-id="'
+__layout.attr('this-extends')
+'"],[this-type="layout"][this-id="'
+__layout.attr('this-extends')+'"]');if(!_layout.length)
_layout=this._('[this-type="layouts"] layout[this-id="'
+__layout.attr('this-extends')+'"],'
+'[this-type="layouts"] [this-type="layout"][this-id="'
+__layout.attr('this-extends')+'"]').clone();if(!_layout.length){internal.fullyFromURL.call(this,'layout',__layout.attr('this-extends'),function(_layout){_layout.removeAttr('this-url').find('[this-content]').html(__layout);if(_layout.attr('this-extends'))
internal.extendLayout.call(_this,_layout,replaceInState);else
internal.finalizePageLoad.call(_this,_layout,replaceInState);},function(){this.error('Layout ['+__layout.attr('this-extends')
+'] not found!');internal.finalizePageLoad.call(_this,_layout,replaceInState);});}
else{if(_layout.attr('this-url')){this.request(_layout.attr('this-url'),function(data){_layout.removeAttr('this-url').html(data).find('[this-content]').html(__layout.show());if(_layout.attr('this-extends')){internal.extendLayout.call(_this,_layout,replaceInState);}
else{internal.finalizePageLoad.call(_this,_layout,replaceInState);}},function(){},{},'text');}
else{_layout.find('[this-content]').html(__layout.removeAttr('this-extends').show());if(_layout.attr('this-extends')){internal.extendLayout.call(this,_layout,replaceInState);}
else{internal.finalizePageLoad.call(this,_layout,replaceInState);}}}},finalizePageLoad:function(_layout,replaceInState){var _this=this;if(_layout&&_layout.length){if(!this.container.find('layout[this-id="'
+_layout.attr('this-id')
+'"],[this-type="layout"][this-id="'
+_layout.attr('this-id')+'"]').length)
this.container.html(_layout.show());}
else
this.container.html(this.page);this.page=this.container.find('page:not([this-dead]),'
+'[this-type="page"]:not([this-dead])').attr('this-current','').show();var transit=this.__.callable(this.config.transition,true),wait;if(transit)
wait=transit.call(null,_this.oldPage.removeAttr('this-current'),this.page,this.config.transitionOptions);else if(this.__.isString(this.config.transition)){if(!Transitions[this.config.transition])
this.config.transition='show';wait=Transitions[this.config.transition](_this.oldPage.removeAttr('this-current'),this.page,this.config.transitionOptions);}
setTimeout(function(){_this.oldPage.remove();delete _this.oldPage;},wait);if(this.config.titleContainer)
this.config.titleContainer.html(this.page.attr('this-title'));if(this.page.attr('this-url')){this.request(this.page,function(data){_this.page.html(data);internal.loadComponents.call(_this);internal.loadCollections.call(_this,replaceInState);internal.loadModels.call(_this,replaceInState);internal.loadForms.call(_this);_this.page.attr('this-loaded','');internal.pageLoaded.call(_this,replaceInState);},function(){},{},'text');}
else{internal.loadComponents.call(this);internal.loadCollections.call(this,replaceInState);internal.loadModels.call(this,replaceInState);internal.loadForms.call(this);this.page.attr('this-loaded','');internal.pageLoaded.call(this,replaceInState);}},pageLoaded:function(replaceState){if(!this.__proto__.collections&&!this.__proto__.models&&!this.__proto__.components){var _this=this;this.container.find('[this-inline-code]').each(function(){var __this=_this._(this);__this.replaceWith(_this._('<code this-code />').html(__this.html()));});this.container.find('[this-block-code]').each(function(){var __this=_this._(this);__this.replaceWith(_this._('<pre />').html(__this.html())).innerWrap('<code this-code />');});this.container.find('[this-code]').each(function(){var __this=_this._(this),tags=internal.parseBrackets.call(_this,'<','>',__this.html()),content=__this.html();_this.__.forEach(tags,function(i,v){content=content.replace(v,'&lt;'+v.substr(1,v.length-2)+'&gt;');});content=content.replace(/\n/g,'<br/>').replace(/\s/g,'&nbsp;');__this.html(content).removeAttr('this-code');});this.container.html(internal.processExpressions.call(this,this.container.html()));delete this.firstPage;this.page=this.container.find('page[this-id="'+this.page.attr('this-id')
+'"][this-loaded], [this-type="page"][this-id="'
+this.page.attr('this-id')+'"][this-loaded]');this.page.trigger('page.loaded');internal.saveState.call(this,replaceState);}
return this;},loadData:function(container,data,content,model,save){container=this._(container);if(!data){container.trigger('invalid.response');return;}
var variables=internal.parseBrackets.call(this,'{{','}}',content),_data={data:{},length:0},save_as=container.attr('this-model')||container.attr('this-id');if(this.config.dataKey){if(container.attr('this-type')==='collection'){if(!data.expires)
_data.expires=new Date().setMilliseconds(1000*3600*24);else if(!isNaN(data.expires))
_data.expires=new Date().setMilliseconds(1000*data.expires);else if(this.__isString(data.expires))
_data.expires=new Date(data.expires).getTime();}
data=data[this.config.dataKey];}
if(this.__.isArray(data)||model===false){var _this=this,filter=container.attr('this-filter');this.__.forEach(data,function(index,model){if(save){_data.data[model[container.attr('this-model-uid')||'id']||index]=model;_data.length++;}
var _content=internal.inLoop.call(_this,{index:index,model:model},filter,content.replace(/{{_index}}/g,index));if(!_content)
return;_content=internal.processExpressions.call(_this,_content,{index:index,model:model});internal.doLoad.call(_this,container,model,_content,variables);});if(container.attr('this-type')==='collection'){_data.uid=container.attr('this-model-uid')||'id';_data.url=container.attr('this-url');}}
else if(data&&model){if(container.attr('this-type')==='model'&&container.attr('this-id')){save_as=container.attr('this-id');}
if(save)
_data.data[data[container.attr('this-uid')||'id']]=data;internal.doLoad.call(this,container,data,content,variables);}
container.show();if(this.config.cacheData&&save!==false)
internal.cache.call(this,'model',save_as,_data,true);return this;},doLoad:function(container,data,content,variables){container=this._(container);var _temp=internal.parseData.call(this,data,content,variables),id=container.attr('this-model-uid')||'id';if(internal.is.call(this,'collection',container)){_temp.attr('this-mid',data[id]||'').attr('this-uid',id).attr('this-type','model').attr('this-in-collection','').attr('this-url',container.attr('this-url')
+(data[id]||''));if(container.attr('this-model'))
_temp.attr('this-id',container.attr('this-model'));container.append(_temp.show());}
else{container.attr('this-uid',id).attr('this-mid',data[id]);container.html(_temp.show().html());}
return this;},eval:function(content,data){var variables=internal.parseBrackets.call(this,'{{','}}',content);content=internal.fillVariables.call(this,variables,data,content);return eval(content);},parseBrackets:function(oBrace,cBrace,content){return this.__.tryCatch(function(){return content.match(new RegExp(oBrace+'\\s*[^'+cBrace+']+\\s*'
+cBrace,'gi'))||[];});},regEsc:function(str){return str.replace(/[-[\]{}()*+?.,\\/^$|#\s]/g,"\\$&");},getExpressions:function(content){var exps=[];this.__.forEach(content.split('({'),function(i,v){if(!i)
return;exps.push('({'+v.split('})')[0]+'})');});return exps;},processExpressions:function(content,current){var _this=this,exps=internal.getExpressions.call(this,content);this.__.forEach(exps,function(i,v){try{content=content.replace(v,eval(v.trim().substr(2,v.trim().length-4)));}
catch(e){_this.error(e.message);}});return content;},parseData:function(data,content,variables){if(!variables)
variables=internal.parseBrackets.call(this,'{{','}}',content);var _temp=this.__.isObject(content)?content:this._('<div/>').html(content),_this=this;_temp.find('[this-each]').each(function(){var __this=_this._(this),_data=data[__this.attr('this-each')],filter=__this.attr('this-filter'),each=__this.attr('this-each').trim(),content=__this.removeAttr('this-muted').html().replace(/__obrace__/g,'{{').replace(/__cbrace__/g,'}}').replace(/__obrace2__/g,'({').replace(/__cbrace2__/g,'})');__this.html('');if(!_data){if(each.startsWith('{(')){_data=internal.eval.call(_this,each.substr(1,each.length-2),data);}
else if(each.startsWith('{{')){_data=internal.getVariableValue.call(_this,each,data);}}
if(!_this.__.isObject(_data,true))
return;_this.__.forEach(_data,function(key,value){var __data={key:key,value:value},_content=internal.inLoop.call(_this,__data,filter,content);if(!_content)
return;_content=internal.processExpressions.call(_this,_content,__data);var _variables=internal.parseBrackets.call(_this,'{{','}}',_content);__this.append(internal.fillVariables.call(_this,_variables,__data,_content).replace(/{{key}}/g,key));});__this.removeAttr('this-each');});_temp.html(internal.fillVariables.call(this,variables,data,_temp.html()));var children=_temp.children();if(children.length===1)
_temp=children;return _temp.show();},inLoop:function(current,filter,content){if(filter&&!eval(filter.trim()))
return;content=this._(document.createElement('div')).html(content);var _this=this,level=0,matched={};content.find('[this-each]').each(function(){var __this=_this._(this).attr('this-muted','');__this.html(__this.html().replace(/\{\{/g,'__obrace__').replace(/\}\}/g,'__cbrace__').replace(/\(\{/g,'__obrace2__').replace(/\}\)/g,'__cbrace2__')).find('[this-if], [this-else-if], [this-else]').attr('this-ignore','');});content.find('[this-if],[this-else-if],[this-else]').each(function(){var __this=_this._(this);if(__this.attr('this-if')&&!__this.hasAttr('this-ignore')){level++;if(eval(__this.attr('this-if').trim())){__this.removeAttr('this-if');matched[level]=true;}
else{matched[level]=false;__this.remove();}
if(__this.hasAttr('this-end-if')){__this.removeAttr('this-end-if');delete matched[level];level--;}}
else if(__this.attr('this-else-if')&&!__this.hasAttr('this-ignore')){if(!__.isBoolean(matched[level])){_this.error('Branching error: Else-if without If!');return;}
if(matched[level]||!eval(__this.attr('this-else-if').trim()))
__this.remove();else{__this.removeAttr('this-else-if');matched[level]=true;}
if(__this.hasAttr('this-end-if')){__this.removeAttr('this-end-if');delete matched[level];level--;}}
else if(__this.hasAttr('this-else')&&!__this.hasAttr('this-ignore')){if(!__.isBoolean(matched[level])){_this.error('Branching error: Else without If!');return;}
if(matched[level])
__this.remove();else
__this.removeAttr('this-else');if(__this.hasAttr('this-end-if'))
__this.removeAttr('this-end-if');delete matched[level];level--;}});content.find('[this-ignore]').removeAttr('this-ignore');return content.html();},getVariableValue:function(variable,data){var _this=this,vars=variable.replace(/{*}*/g,'').replace(/\\\|/g,'__fpipe__').split('|'),key=this.__.arrayRemove(vars,0),value=this.__.contains(key,'.')?internal.getDeepValue.call(null,key,data):data[key];if(!value)
return;this.__.forEach(vars,function(i,v){v=v.replace(/__fpipe__/g,'|');var exp=v.split(':'),filter=_this.__.arrayRemove(exp,0);if(Filters[filter])
value=Filters[filter](value,exp.join(':'));if(!value)
return false;});return value;},fillVariables:function(variables,data,content){var _this=this;this.__.forEach(variables,function(i,v){var value=internal.getVariableValue.call(_this,v,data);content=content.replace(v,value);});return content;},getDeepValue:function(variable,data){var value=data,vars=__.isObject(variable,true)?variable:variable.split('.');__.forEach(vars,function(i,v){if(!value)
return false;value=value[v];});return value||'';},restoreState:function(state){if(this.page){this.page.trigger('page.leave');}
this.container.html(state.content);this.page=this.container.find('[this-id="'+state.id+'"]');if(this.config.titleContainer)
this.config.titleContainer.html(state.title);this.store('last_page',state.id);internal.updatePage.call(this);this.page.trigger('page.loaded');},updatePage:function(){var deleted=internal.cache.call(this,'deleted')||{},created=internal.cache.call(this,'created')||{},updated=internal.cache.call(this,'updated')||{},collection=internal.cache.call(this,'model')||{},_this=this,_collections=this.page.find('collection,[this-type="collection"]'),_models=this.page.find('model,[this-type="model"]'),touched={'deleted':{},'created':false,'updated':false};if(_collections.length){this.__.forEach(created,function(model_name,arr){var _collection=_this.page.find('collection[this-model="'+model_name+'"],[this-type="collection"][this-model="'+model_name+'"]');if(!_collection.length)
return;var __collection=collection[model_name],uid=__collection.uid;_this.__.forEach(arr,function(i,v){var tmpl=internal.parseData.call(_this,__collection.data[v],_collection.children('[this-cache]').clone().removeAttr('this-cache').outerHtml()),action=_collection.attr('this-prepend-new')?'prepend':'append';_collection[action](tmpl.attr('this-mid',v).attr('this-uid',uid).attr('this-type','model').attr('this-id',model_name).attr('this-url',_collection.attr('this-url')+v).attr('this-in-collection','').outerHtml());_this.__.arrayRemove(arr,i);});if(!created[model_name].length){delete created[model_name];}
touched.created=true;});}
if(_models.length){this.__.forEach(updated,function(model_name,arr){var _model=_this.page.find('model[this-id="'+model_name+'"],[this-type="model"][this-id="'+model_name+'"],'
+'collection[this-model="'+model_name+'"]>[this-type="model"],'
+'[this-type="collection"][this-model="'+model_name+'"]>[this-type="model"]'),in_collection=false;if(!_model.length)
return;_this.__.forEach(arr,function(id,v){_model.filter(function(){return this.getAttribute('this-mid')===id;}).each(function(){var __model=_this._(this),tmpl=internal.parseData.call(_this,v,__model.siblings('[this-cache]').clone().removeAttr('this-cache').outerHtml());if(__model.hasAttr('this-in-collection')){in_collection=true;}
__model.html(tmpl.html());});});if(in_collection)
delete updated[model_name];touched.updated=true;});this.__.forEach(deleted,function(model_name,arr){_this.__.forEach(arr,function(i,mid){var _model=_this.page.find('model[this-id="'+model_name+'"][this-mid="'+mid+'"],[this-type="model"][this-id="'+model_name+'"][this-mid="'+mid+'"],'
+'collection[this-model="'+model_name+'"]>[this-type="model"][this-mid="'+mid+'"],'
+'[this-type="collection"][this-model="'+model_name+'"]>[this-type="model"][this-mid="'+mid+'"]');if(!_model.length)
return;_model.each(function(){var __model=_this._(this);__model.hide();if(__model.hasAttr('this-in-collection')){if(!touched.deleted[model_name]){touched.deleted[model_name]=[];}
touched.deleted[model_name].push(mid);__model.remove();}
else{if(!__model.attr('this-bind')&&this.page.attr('this-reading')&&_models.length===1){touched.back=true;return false;}
else{__model.removeAttr('this-url').removeAttr('this-mid').html('');}}});});});}
if(touched.cancel)
return;if(touched.updated)
this.store('updated',updated);if(touched.created)
this.store('created',created);var del=false;this.__.forEach(touched.deleted,function(mod,arr){_this.__.forEach(arr,function(i,v){_this.__.arrayRemoveValue(deleted[mod],v);del=true;});if(!deleted[mod].length){delete deleted[mod];}});if(del)
this.store('deleted',deleted);internal.loadForms.call(this);return touched.back?this.back():internal.saveState.call(this,true);},saveState:function(replace){var action='pushState';if(replace||this.firstPage)
action='replaceState';history[action]({id:this.page.attr('this-id'),title:this.page.attr('this-title'),content:this.container.html()},this.page.attr('this-title'),'#'
+this.page.attr('this-id'));this.store('last_page',this.page.attr('this-id'));return this;},is:function(type,container){return this._(container).attr('this-type')===type||this._(container).is(type);},selector:function(id,append){id=id.split('#');if(!append)
append='';var attrs=id[id.length-1].split('[');id[id.length-1]=attrs[0];this.__.arrayRemove(attrs,0);if(attrs.length)
append+='['+attrs.join('[');return id.length>1?'[this-type="'+id[0]+'"][this-id="'+id[1]+'"]'+append+','+id[0]+'[this-id="'+id[1]+'"]'+append:'[this-id="'+id[0]+'"]'+append;}}),Transitions=Object.create({show:function(pageOff,pageOn){pageOff.remove();pageOn.show();return this;}}),Filters=Object.create({lowercase:function(item){var _this=this;if(__.isArray(item)){var arr=[];__.forEach(item,function(i,v){var _item=_this.lcase(v);if(_item)
arr.push(_item);});return arr;}
else if(__.isString(item))
return item.toLowerCase();},uppercase:function(item){var _this=this;if(__.isArray(item)){var arr=[];__.forEach(item,function(i,v){var _item=_this.ucase(v);if(_item)
arr.push(_item);});return arr;}
else if(__.isString(item))
return item.toUpperCase();},capitalize:function(item,options){return this.ucwords(item,options);},smallize:function(item){return this.lcfirst(item);},lcase:function(item){return this.lowercase(item);},ucase:function(item){return this.uppercase(item);},ucfirst:function(item){var _this=this;if(__.isArray(item)){var arr=[];__.forEach(item,function(i,v){var _item=_this.ucfirst(v);if(_item)
arr.push(_item);});return arr;}
else if(__.isString(item))
return item[0].toUpperCase()+item.substr(1);},lcfirst:function(item){var _this=this;if(__.isArray(item)){var arr=[];__.forEach(item,function(i,v){var _item=_this.lcfirst(v);if(_item)
arr.push(_item);});return arr;}
else if(__.isString(item))
return item[0].toLowerCase()+item.substr(1);},ucwords:function(item,options){var _this=this;if(__.isArray(item)){var arr=[];__.forEach(item,function(i,v){var _item=_this.ucwords(v,options);arr.push(_item);});return arr;}
else if(__.isString(item))
return item.replace(options==='-'?/[^-'\s]+/g:/[^\s]+/g,function(word){return word.replace(/^./,function(first){return first.toUpperCase();});});},snakeToCamel:function(item,ucfirst){var _this=this;if(__.isArray(item)){var arr=[];__.forEach(item,function(i,v){var _item=_this.snakeToCamel(v,ucfirst);if(_item)
arr.push(_item);});return arr;}
else if(__.isString(item)){var _item=item.replace(/(\_\w)/g,function(w){return w[1].toUpperCase();});return ucfirst?this.ucfirst(_item):_item;}},camelToSnake:function(item){var _this=this;if(__.isArray(item)){var arr=[];__.forEach(item,function(i,v){var _item=_this.camelToSnake(v);if(_item)
arr.push(_item);});return arr;}
else if(__.isString(item)){var _item=item.replace(/([A-Z])/g,function(i){return'_'+i.toLowerCase();});return this.lcfirst(_item);}},camelToHyphen:function(item){var _this=this;if(__.isArray(item)){var arr=[];__.forEach(item,function(i,v){var _item=_this.camelToSnake(v);if(_item)
arr.push(_item);});return arr;}
else if(__.isString(item)){var _item=item.replace(/([A-Z])/g,function(i){return'-'+i.toLowerCase();});return this.lcfirst(_item);}},contains:function(val,options){if(__.isObject(val,true)){options=options.split(',');return this.filter(val,function(v){var search=options[0];if(options.length>1){v=internal.getDeepValue.call(null,options[0],v);search=options[1];}
return v&&(__.isString(v)||__.isArray(v))&&__.contains(v,search);});}
else if(__.isString(val)){return __.contains(val,options)?val:null;}
return null;},filter:function(obj,func){func=__.callable(func,true);if(func){if(__.isArray(obj)){return obj.filter(func);}
else{var newObj={};__.forEach(obj,function(i,v){if(true===func.call(null,v,i)){newObj[i]=v;}});return newObj;}}
return obj;},trim:function(str){if(__.isArray(str)){var _this=this,arr=[];__.forEach(str,function(i,v){arr.push(_this.trim(v));});return arr;}
else if(__.isString(str))
return str.trim();},split:function(str,separator){return this.__(str,separator,function(str,separator){return str.split(separator);});},join:function(str,separator){if(!__.isArray(str))
return str;return str.join(separator);},replace:function(str,options){return this.__(str,options,function(str,search,replace){return str.replace(search,replace);});},__:function(str,options,func){return __.tryCatch(function(){if(__.isArray(str)){var arr=[],_this=this;__.forEach(str,function(i,v){arr.push(_this.__(v,options,func));});return arr;}
else if(__.isString(str)){options=this.__opts(options);options.unshift(str);return func.apply(this,options);}}.bind(this));},__opts:function(options){options=options.replace(/\\,/g,'__fcomma__').split(',');__.forEach(options,function(i,v){options[i]=v.replace(/__fcomma__/g,',');});return options;}}),Model=function(attributes,props){function toURL(attributes,_key){var url='';__.forEach(attributes,function(key,value){if(_key)
key=__.isString(key)?_key+'['+key+']':_key+'[]';if(url)
url+='&';if(__.isObject(value,true)){url+=toURL(value,key);}
else{url+=encodeURIComponent(key)+'='+encodeURIComponent(value);}});return url;}
var _Model=Object.create({name:props&&props.name?props.name:null,app:props&&props.app?props.app:null,uid:props&&props.uid?props.uid:'id',url:props&&props.url?props.url:null,collection:props&&props.collection?props.collection:null,method:props&&props.method?props.method:null,attributes:__.isObject(attributes)?attributes:{},init:function(attr){this['get'+Filters.snakeToCamel(attr,true)]=function(){return this.attributes[attr];};this['set'+Filters.snakeToCamel(attr,true)]=function(val){this.attributes[attr]=val;return this;};},toURL:function(){return toURL(this.attributes);},save:function(cacheOnly,success,error,complete){var _this=this,method=_this.attributes.id?'PUT':'POST';if(!_this.app){console.error('Invalid model object');return false;}
else if(!_this.name){_this.app.error('Cannot delete model that has no name.');return false;}
if(_this.method)
method=_this.method;if(cacheOnly)
internal.modelToStore.call(this.app,this.attributes,this.name,this.uid);else if(_this.url){_this.app.__.ajax({type:method,url:_this.app.config.baseURL+_this.url,data:this.toURL(),success:function(data){var model=_this.app.config.dataKey?data[_this.app.config.dataKey]:data;if(model){internal.modelToStore.call(_this.app,model,_this.name,_this.uid);var _action=_this.attributes.id?'updated':'created',action=_this.app.store(_action)||{};if(_this.attributes.id){if(!action[_this.name])
action[_this.name]={};action[_this.name][model[_this.uid]]=model;_this.app.store(_action,action);if(_this.collection)
_this.collection.models[_this.attributes.id]=model;}
else{_this.url+=model[_this.uid];if(!action[_this.name])
action[_this.name]=[];action[_this.name]=_this.app.__.arrayRemoveValue(action[_this.name],model[_this.uid],true);action[_this.name].push(model[_this.uid]);_this.app.store(_action,action);}
_this.attributes=model;internal.updatePage.call(_this.app);if(_this.collection){_this.collection.models[model[_this.uid]]=model;_this.collection.length++;}}
_this.app.__.callable(success).call(this,data);},error:function(e){_this.app.__.callable(error).call(this,e);},complete:function(e){_this.app.__.callable(complete).call(this,e);}});return true;}
else{_this.app.error('Cannot save model to server: No URL supplied.');}
return false;},remove:function(cacheOnly,success,error,complete){var _this=this;if(!_this.app){console.error('Invalid model object');return false;}
else if(!_this.name){_this.app.error('Cannot delete model that has no name.');return false;}
if(cacheOnly)
internal.removeModelFromStore.call(this.app,this.getId(),this.name);else if(_this.url){_this.app.__.ajax({type:'delete',url:_this.app.config.baseURL+_this.url,success:function(data){var model=_this.app.config.dataKey?data[_this.app.config.dataKey]:data;if(model){_this.attributes=model;internal.removeModelFromStore.call(_this.app,model[_this.uid],_this.name);var __model=_this.app.store('deleted')||{};if(!__model[_this.name])
__model[_this.name]=[];__model[_this.name]=_this.app.__.arrayRemoveValue(__model[_this.name],model[_this.uid],true);__model[_this.name].push(model[_this.uid]);_this.app.store('deleted',__model);if(_this.collection){delete _this.collection.models[model[_this.uid]];_this.collection.length--;}
internal.updatePage.call(_this.app);}
_this.app.__.callable(success).call(this,data);},error:function(e){_this.app.__.callable(error).call(this,e);},complete:function(e){_this.app.__.callable(complete).call(this,e);}});}
else{_this.app.error('Cannot remove model from server: No URL supplied.');return false;}
return true;}});if(__.isObject(attributes)){__.forEach(attributes,function(key){_Model.init(key);});}
return _Model;},Collection=function(models,props){var _Collection=Object.create({name:props&&props.name?props.name:null,app:props&&props.app?props.app:null,uid:props&&props.uid?props.uid:'id',url:props&&props.url?props.url:null,current_index:-1,models:__.isObject(models)?models:{},get:function(index){var key=Object.keys(this.models)[index];if(key)
this.__proto__.current_index=index;return this.model(key);},first:function(){return this.get(0);},last:function(){return this.get(this.length-1);},current:function(){return this.get(this.__proto__.current_index||0);},next:function(){return this.get(this.__proto__.current_index+1);},rewind:function(){this.__proto__.current_index=-1;return this;},hasNext:function(){var current_index=this.__proto__.current_index,model=this.next();this.__proto__.current_index=current_index;return model!==null;},model:function(model_id){var _this=this;return model_id&&this.models[model_id]?new Model(this.models[model_id],{name:_this.name,app:_this.app,uid:_this.uid,url:_this.url+model_id,collection:this}):null;},add:function(attributes,cacheOnly,success,error,complete){var model=new Model(attributes,{name:this.name,app:this.app,uid:this.uid,url:this.url,collection:this});return model.save(cacheOnly,success,error,complete);},remove:function(model_id,cacheOnly,success,error,complete){if(model_id===undefined){if(cacheOnly){this.app.store(this.name,null);this.models={};this.length=0;}
else{var _this=this;this.app.__.ajax({url:this.app.config.baseURL+this.url,type:'delete',success:function(data){_this.app.store(_this.name,null);_this.models={};_this.length=0;_this.app.__.callable(success).call(_this,data);},error:function(e){_this.app.__.callable(error).call(_this,e);},complete:function(e){_this.app.__.callable(complete).call(_this,e);}});}
return true;}
var model=this.model(model_id);if(!model)
return false;model.remove(cacheOnly,success,error,complete);delete this.models[model_id];this.length--;return true;}});_Collection.length=props&&props.length?props.length:0;return _Collection;};_.prototype=__.__proto__;ThisApp=function(config){if(!(this instanceof ThisApp))
return new ThisApp(config);this.version='1.0';if(config&&__.isObject(config)){this.config=this.__.extend(this.config,config);if(!_(container,this.config.debug).length){this.error('ThisApp container not found');}}
else{this.debug(true);this.error('ThisApp must be constructed with a configuration object with at least'
+' the target container\'s selector');}};ThisApp.Transitions={add:function(name,func){if(name&&func&&!Transitions[name]){Transitions[name]=func;}
return this;},overwrite:function(name,func){if(name&&func){Transitions[name]=func;}
return this;},exists:function(name){return Transitions[name]!==undefined;}};ThisApp.Filters={add:function(name,func){if(name&&func&&!Filters[name]){Filters[name]=func;}
return this;},overwrite:function(name,func){if(name&&func){Filters[name]=func;}
return this;},exists:function(name){return Transitions[name]!==undefined;}};ThisApp.prototype={events:[],config:{startWith:null,baseURL:location.href,debug:false,dataKey:'data',titleContainer:null,cacheData:true,transition:'show',transitionOptions:{},loadFromState:true,layout:null,paths:{pages:'pages',layouts:'layouts',components:'components',ext:'.html'}},components:0,collections:0,models:0,__:__,_:function(selector,debug){return _(selector,debug||this.config.debug);},setBaseUrl:function(url){this.config.baseURL=url;return this;},cacheData:function(status){if(!this.running)
this.config.cacheData=status;return this;},debug:function(debug){if(!this.running){this.config.debug=debug!==false?true:false;this.__.__proto__.debug=this.config.debug;}
return this;},setDataKey:function(key){this.config.dataKey=key;return this;},setTitleContainer:function(container){this.config.titleContainer=this.running?this._(container):container;return this;},setTransition:function(transition,options){this.config.transition=transition;this.config.transitionOptions=options;return this;},getAvailableTransitions:function(){return Object.keys(Transitions);},getAvailableFilters:function(){return Object.keys(filters);},header:function(component_id){this.header=this._('component[this-id="'+component_id+'"], '+'[this-type="components"] [this-id="'+component_id+'"]');return this;},footer:function(component_id){this.footer=this._('component[this-id="'+component_id+'"],'
+'[this-type="components"] [this-id="'+component_id+'"]');return this;},loadFromState:function(load){this.config.loadFromState=load!==undefined?load:true;return this;},setLayout:function(layout){this.config.layout=layout;return this;},setPathsExtension:function(ext){if(!this.config.paths)
this.config.paths={};if(!ext.startsWith('.'))
ext='.'+ext;this.config.paths.ext=ext;return this;},setPagesPath:function(path){if(!this.config.paths)
this.config.paths={};this.__proto__.config.paths.pages=path;return this;},setLayoutsPath:function(path){if(!this.config.paths)
this.config.paths={};this.__proto__.config.paths.layouts=path;return this;},setComponentsPath:function(path){if(!this.config.paths)
this.config.paths={};this.__proto__.config.paths.components=path;return this;},start:function(page){if(this.running)
return this;if(page)
this.config.startWith=page;this.container=this._(this.config.container).html('');this.firstPage=true;internal.setup.call(this);var target_page=internal.pageIDFromLink.call(this,location.hash);if(this.config.loadFromState&&history.state&&target_page===this.store('last_page')){internal.restoreState.call(this,history.state);}
else{this.loadPage(target_page||this.config.startWith||this._('page[this-default-page]:not([this-current]):not([this-dead]), [this-type="pages"] [this-default-page]').attr('this-id'));}
return this;},beforePageLoad:function(func){this.beforePage=func;return this;},beforeDeleteModel:function(func){this.beforeDelete=func;return this;},loadPage:function(page,replaceInState){if(!page)
return;this.oldPage=_();var newPage=this._('page[this-id="'+page
+'"]:not([this-current]):not([this-dead]),'
+'[this-type="pages"]>[this-id="'+page+'"]');if(newPage.length>1){this.error('Target page matches multiple pages!');return this;}
if(!newPage.length){if(this.config.paths&&this.config.paths.pages){var _this=this;internal.fullyFromURL.call(this,'page',page,function(elem){internal.pageFound.call(_this,elem,replaceInState);},function(){internal.notAPage.call(_this,page);});return this;}
internal.notAPage.call(this,page);return this;}
internal.pageFound.call(this,newPage,replaceInState);return this;},pageNotFound:function(callback){this.notFound=callback;return this;},home:function(){this.loadPage(this.config.startWith||this._('page[this-default-page]:not([this-current]):not([this-dead]),[this-type="pages"] [this-default-page]').attr('this-id'));return this;},back:function(e){if(e&&this.__.isObject(e)&&e['preventDefault'])
e.preventDefault();if(history.length<=2){this.home();return;}
history.back();return this;},forward:function(e){if(e&&this.__.isObject(e)&&e['preventDefault'])
e.preventDefault();history.forward();return this;},when:function(event,target,callback){var selector="",targets=target.split(',');if(selector)
selector+=', ';this.__.forEach(targets,function(i,v){switch(target){case"page":selector+='page,[this-type="page"]';break;case"collection":selector+='collection,[this-type="collection"]';break;case"model":selector+='model,[this-type="model"]';break;case"component":selector+='component,[this-type="component"]';break;default:var exp=v.split('#');if(exp.length>1&&exp[0]){selector+='[this-type="'+exp[0]+'"][this-id="'+exp[1]+'"]';}
else{selector+='[this-id="'+v+'"]';}}});this.events.push({event:event,selector:selector,callback:callback});return this;},on:function(event,selector,callback){this.events.push({event:event,selector:selector,callback:callback});return this;},onError:function(callback){this.error=this.__.callable(callback,true)||this.error;return this;},request:function(url,success,error,data,responseType){var elem,_this=this;if(this.__.isObject(url)){elem=this._(url);if(!elem.attr('this-url')){this.error('Request object must have a `this-url` attribute.');return;}
elem.trigger('loading.url');url=elem.attr('this-url');}
if(!url.startsWith('./')&&!url.startsWith('../')&&url.indexOf('://')===-1)
url=this.config.baseURL+url;return this.__.ajax({type:'get',url:url,dataType:responseType||'json',data:data||{},success:function(data){_this.__.callable(success).call(elem||this,data);if(elem)
elem.trigger('load.content.success');},error:function(){_this.__.callable(error).call(elem||this,data);if(elem)
elem.trigger('load.content.error');},complete:function(){if(elem)
elem.trigger('load.content.complete');}});},error:function(msg){if(!this.config.debug)
return this;console.error(msg);},store:function(key,value){if(!key)
return localStorage;if(!value){if(value===null){localStorage.removeItem(key);return this;}
var data=localStorage.getItem(key),_data=this.__.toObject(data);return _data||data;}
if(this.__.isObject(value,true))
value=this.__.toJSON(value);if(value)
localStorage.setItem(key,value);return this;},tryCatch:function(callback,args){return this.__.tryCatch((this.__.callable(callback)).bind(this),args);},reload:function(){location.reload();return this;},collection:function(model_name){var collection=internal.cache.call(this,'model',model_name);return new Collection(collection.data,{name:model_name,app:this,uid:collection.uid,url:collection.url,length:collection.length});}};})();