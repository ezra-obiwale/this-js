/* 
 * Copyright (C) 2017 Ezra Obiwale <contact@ezraobiwale.com>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
!function(){function objToQStr(t,e,i){if(!__.isObject(t,!0))return t;var s="",e=__.callable(e);return __.forEach(t,function(t,n){e.call(null,t,n),s&&(s+="&");var a=i||"";if(i&&(t="["+t+"]"),a+=__.isNumeric(t)?"[]":t,__.isObject(n,!0)){__.isArray(n);__.forEach(n,function(t,e){t&&__.isNumeric(t)&&(s+="&"),__.isObject(e,!0)?s+=objToQStr(e,null,a+"["+t+"]"):e&&(s+=a+"["+t+"]="+encodeURIComponent(e))})}else void 0!==n&&(s+=a+"="+encodeURIComponent(n))}),s}function qStrToObj(str,callback){var obj={},callback=__.callable(callback);return __.forEach(str.split("&"),function(i,keyToValue){var parts=keyToValue.split("="),value=decodeURIComponent(parts[1]);callback.apply(null,parts);try{value=eval(value)}catch(e){}if(-1!==parts[0].indexOf("[")){parts=parts[0].replace(/\]/g,"").split("[");var firstKey=parts.shift(),lastKey=parts.pop();obj[firstKey]=obj[firstKey]||{};var _tmp=obj[firstKey],prevTmp=obj,prevKey=firstKey;__.forEach(parts,function(t,e){return e&&parseInt(e)!=e?(prevTmp=_tmp,__.isArray(prevTmp)?(_tmp={},_tmp[e]||(_tmp[e]={}),prevTmp.push(_tmp)):(_tmp[e]||(_tmp[e]={}),_tmp=prevTmp[e]),void(prevKey=e)):(_tmp={},void(__.isArray(prevTmp[prevKey])?prevTmp[prevKey][e]?_tmp=prevTmp[prevKey][e]:prevTmp[prevKey].push(_tmp):prevTmp[prevKey]=[_tmp]))}),lastKey?_tmp[lastKey]=value:(lastKey=parts.pop()||prevKey,prevTmp[lastKey]&&__.isArray(prevTmp[lastKey])?prevTmp[lastKey].push(value):prevTmp[lastKey]=[value])}else obj[parts[0]]=value}),obj}function styleToObj(t,e){var i={},e=__.callable(e);return __.forEach(t.split(";"),function(t,s){var n=s.split(":");i[n[0]]=n[1],e.apply(null,n)}),i}function getElemType(t){return _(t).length?_(t)["this"]("type")||_(t).get(0).tagName.toLowerCase():null}function getRealData(t,e){return e||ext.config.call(this).dataKey?t[e||ext.config.call(this).dataKey]:t}function analyzeLink(t){t.startsWith("#")&&(t=t.substr(1)),t.startsWith("/")&&(t=t.substr(1));var e=t.split("/"),i={};return e[0].endsWith("/")&&(e[0]=e[0].substr(0,e[0].length-1)),i.page=e.shift(),e.length&&__.forEach(crudConnectors,function(t,s){return s===e[0]?(e.shift(),i.action=t,!1):void 0}),e.length&&(i.model=e.shift()),e.length&&(i.url=e.join("/")),-1!==i.page.indexOf("?")&&(e=i.page.split("?"),i.page=e[0],i.params=qStrToObj(e[1])),i}function when(t,e,i){var s="",n=e.split(",");return s&&(s+=", "),__.forEach(n,function(t,i){switch(e){case"layout":s+='layout,[this-type="layout"]';break;case"page":s+='page,[this-type="page"]';break;case"collection":s+='collection,[this-type="collection"]';break;case"model":s+='model,[this-type="model"]';break;case"component":s+='component,[this-type="component"]';break;case"list":s+='list,[this-type="list"]';break;default:var n=i.split("#");s+=n.length>1&&n[0]?'[this-type="'+n[0]+'"][this-id="'+n[1]+'"]':'[this-id="'+i+'"]'}}),this.on(t,s,i)}function parseSelector(t){var e={tag:null,id:null,classes:[]},i=t.split("#"),s=i[0].split(".");return i.length>1?(e.tag=s.shift(),e.classes=s,i=i[1].split("."),e.id=i.shift()):e.tag=i.shift(),e.classes=e.classes.concat(i),e}function elemToSelector(t,e){if(t=_(t),e.ignore=e.ignore||[],e.attrs=e.attrs||[],!t.length)return"";var i="",s="";return __.inArray("tag",e.ignore)||(i=t.get(0).tagName.toLowerCase()),!__.inArray("id",e.ignore)&&t.attr("id")&&(i="#"+t.attr("id")),__.inArray("attrs",e.ignore)||t.attr().forEach(function(t){if(__.inArray(t.name,e.attrs)&&"id"!==t.name&&"style"!==t.name){if("class"===t.name)return void(s=t.value.trim());i+="["+t.name,t.value&&(i+='="'+t.value+'"'),i+="]"}}),__.inArray("class",e.ignore)?i:(s&&(i+="."),i+=s.replace(/\s/g,"."))}function updateLinkHrefs(t){var e=this;t.find("a[this-goto]:not(form)").each(function(){var t,i,s,n=e._(this),a="";n.attr("href")&&"#"!==n.attr("href")||(t="#/"+n["this"]("goto"),s=n.closest('model,[this-type="model"],[this-model]'),n.hasThis("create")?(n["this"]("create")?a+=n["this"]("create"):s.length&&(a+=s.hasThis("model")?s["this"]("url"):s.parent()["this"]("url")),i="create"):n.hasThis("read")?(n["this"]("read")?a+=n["this"]("read"):s.length&&(a+=s["this"]("url")),i="read"):n.hasThis("update")?(n["this"]("update")?a+=n["this"]("update"):s.length&&(a+=s["this"]("url")),i="update"):n.hasThis("delete")&&(n["this"]("delete")?a+=n["this"]("delete"):s.length&&(a+=s["this"]("url")),i="delete"),a&&(t+="/"+crudConnectors[i]+"/"+(n["this"]("model")||s["this"]("model")||s["this"]("id"))+"/"+a),n.attr("href",t))})}function forEach(t,e){if(__.isObject(t)&&t instanceof _&&(t=t.items),__.isArray(t))t.every(function(t,i){return!1!==__.callable(e).call(t,i,t)});else for(var i in t)if(t.hasOwnProperty(i)&&!1===__.callable(e).call(t[i],i,t[i]))break}function findElem(t){return Array.from(this.querySelectorAll(t))}var privData={data:{},get:function(t,e){return this.data[t]?this.data[t][e]:void 0},set:function(t,e,i){return this.data[t]||(this.data[t]={}),this.data[t][e]=i,this},unset:function(t,e){return this.data[t]?(delete this.data[t][e],this):void 0}},pageAssets={js:{},css:{}},loadedPageJS={first:{},last:{}},containedEvents={},crudConnectors={create:"+",read:"#",update:"!","delete":"-"};FormData.prototype.fromObject=function(t,e){function i(t,n){__.forEach(t,function(t,a){n&&(t=n+"["+(__.isString(t)||!e?t:"")+"]"),__.isObject(a,!0)?i(a,t):s.append(t,a)}),n&&t&&__.isObject(t,!0)&&!Object.keys(t).length&&s.append(n,t)}var s=this;return i(t),this};var Store=function(t){return this instanceof Store?t?this.collection(t):void 0:new Store(t)};Store.prototype.collection=function(t){if(!t)throw"Collection name not specified";this.name=t;var e=function(t){return __.isObject(t,!0)&&(this.length=Object.keys(t).length,t=JSON.stringify(t)),localStorage.setItem(this.name,t)}.bind(this),i=function(){var s=localStorage.getItem(this.name);try{s=JSON.parse(s)}catch(n){if(!s&&"__cols__"!==t){var a=i("__cols__")||[];a.push(t),e(a,"__cols__")}}return s}.bind(this),s=function(){return Math.round(Math.random()*Date.now())+Date.now()},n=i()||{},a=function(t,e,i){return i||!__.isObject(e,!0)?e:__.isArray(e)?__.extend(__.isObject(n[t],!0)?n[t]:[],e):__.isObject(e)?__.extend(__.isObject(n[t],!0)?n[t]:{},e):void 0};this.length=Object.keys(n).length,this.find=function(t){return void 0!==t?n[t]:n},this.save=function(t,i,r){var o=!0;return i||0===i||(i=s(),o=!1),n[i]=a(i,t,r),e(n),o?n[i]:i},this.saveMany=function(t,i,r){i||(i="id");var o={};return __.forEach(t,function(t,e){var l=e[i]||s();n[l]=a(l,e,r),o[l]=n[l]}),e(n),o},this.remove=function(t){var i=n[t];return delete n[t],e(n),i},this.drop=function(){return n={},length=0,Store.dropCollection(this.name)}},Store.toString=function(){return"Store"},Store.dropCollection=function(t){return localStorage.removeItem(t),this},Store.collections=function(){return Store("__cols__").find()};var Form=function(t){if(!this instanceof Form)return new Form(t);var e=[],i=function(t){t.is("input")&&"file"===t.attr("type").toLowerCase()||e.push({name:t.attr("name"),value:t.val()})},s={};_(t).find("input,select,button,textarea").each(function(){var t=_(this);t.attr("name")&&("checkbox"!==t.attr("type")&&"radio"!==t.attr("type")||!t.is(":checked")?t.val().trim()&&i(t):i(t))}),this.toQueryString=function(){var t="";return e.forEach(function(e){""!==t&&(t+="&"),t+=e.name+"="+encodeURIComponent(e.value)}),t&&(t+="&"),t+=objToQStr(s)},this.toObject=function(){var t={};return e.forEach(function(e){var i,s=t;__.forEach(e.name.split("["),function(t,e){var n=e.replace("]","");return t?void(n&&n.replace(/[^0-9]/g,"")!=n?(__.isObject(s[i],!0)&&null!==s[i]||(s[i]={}),s=s[i],i=n):(__.isArray(s[i])||(s[i]=[]),s=s[i],void 0===s[n]?(s.push(null),i=s.length-1):i=n)):void(i=n)}),s[i]=e.value}),__.forEach(s,function(e,i){var s,n=t;__.forEach(e.split("["),function(t,e){var i=e.replace("]","");return t?void(i&&i.replace(/[^0-9]/g,"")!=i?(__.isObject(n[s],!0)&&null!==n[s]||(n[s]={}),n=n[s],s=i):(__.isArray(n[s])||(n[s]=[]),n=n[s],void 0===n[i]?(n.push(null),s=n.length-1):s=i)):void(s=i)}),n[s]=i}),t},this.fromObject=function(t){return s=__.extend(s,t),this},this.forRequest=function(e,i){return"get"===e||"application/x-www-form-urlencoded"===_(t).attr("enctype")||"application/x-www-form-urlencoded"===i?{data:this.toQueryString(),contentType:"application/x-www-form-urlencoded"}:{data:JSON.stringify(this.toObject()),contentType:"application/json"}},this.getForm=function(){return t}},Ajax=function(t,e){t=__.extend({type:"get",url:location.href,data:null,dataType:"json",headers:{},success:function(){},error:function(){},progress:function(){},async:!0,clearCache:!1},t),t.type=t.type.toLowerCase();var i=new XMLHttpRequest,s=t.headers["Content-Type"]||t.headers["Content-type"]||t.headers["content-type"]||t.headers["CONTENT-TYPE"];if(e&&t.api){var n=ext.record.call(e,"secureAPI"),a={},r={},o={};if(!1===__.callable(n||e.secap).call(e,a,o,r))return __.callable(t.error).call(i);__.isObject(r)&&(t=__.extend(t,r)),__.isObject(a)&&(t.headers=__.extend(t.headers,a)),__.isObject(o)&&(t.data instanceof Form||t.data instanceof FormData?t.data.fromObject(o):__.isObject(t.data)?t.data=__.extend(t.data,o):__.isString(t.data)&&(t.data+="&"+objToQStr(o)))}if(i.onreadystatechange=function(){i.readyState===XMLHttpRequest.DONE&&(i.status>=200&&i.status<400?__.callable(t.success).call(i,i.response):__.callable(t.error).call(i,i.response))},t.ignoreCache&&(t.url+=(/\?/.test(t.url)?"&":"?")+(new Date).getTime()),!s&&__.isObject(t.data)&&!(t.data instanceof FormData)){t.data instanceof Form||(t.data=(new Form).fromObject(t.data));var l=t.data.forRequest(t.type.toLowerCase());s=l.contentType,t.data=l.data}return"get"===t.type&&(__.isString(t.data)||__.isObject(t.data,!0))?(t.data=__.isString(t.data)?t.data:objToQStr(t.data),t.url+=(/\?/.test(t.url)?"&":"?")+t.data,t.data=null):"get"!==t.type&&__.isString(t.data)&&!s&&(s="application/x-www-form-urlencoded"),i.open(t.type,t.url,t.async),i.responseType=t.dataType,i.withCredentials=t.withCredentials,__.isObject(t.headers)&&__.forEach(t.headers,function(t,e){i.setRequestHeader(t,e),"content-type"===t.toLowerCase()&&(s=null)}),s&&i.setRequestHeader("Content-Type",s),__.tryCatch(function(){i.upload.onprogress=function(e){e.lengthComputable&&__.callable(t.progress).call(i,e,e.loaded,e.total)}}),i.send(t.data),i},__=Object.create({debug:!0,index:0,items:[],addClass:function(t){var e=this;return this.each(function(){var i=this;e.forEach(t.split(" "),function(t,e){i.classList.add(e)})})},after:function(t){return t?(t instanceof _||(t=_(t,this.debug)),t.length?this.each(function(){var e=this;t.each(function(){e.insertAdjacentElement("afterEnd",this)})}):this):this.next()},ajax:function(t){return t=this.extend({type:"get",url:location.href,data:{},success:function(){},error:function(){}},t),Ajax(t)},append:function(t){if(!t)return this;var e=t;return this.isString(t)&&!t.trim().startsWith("<")&&(e=this.createElement(null,"span").items[0].innerHTML=t),e=_(t,this.debug),e.length?this.each(function(){var t=this;e.each(function(){t.insertAdjacentElement("beforeEnd",this)})}):this},attr:function(t,e){return this.tryCatch(function(){if(void 0!==e||__.isObject(t))return this.each(function(){if(__.isObject(t)){var i=this;__.forEach(t,function(t,e){i.setAttribute(t,e)})}else this.setAttribute(t,e)}),this;if(this.items.length)return t?null!==this.items[0].getAttribute(t)?this.items[0].getAttribute(t):void 0:Array.from(this.items[0].attributes)})},before:function(t){return t?(t instanceof _||(t=_(t,this.debug)),t.length?this.each(function(){var e=this;t.each(function(){e.insertAdjacentElement("beforeBegin",this)})}):this):this.prev()},callable:function(t,e){if(this.isFunction(t))return t;if(this.isString(t)){for(var i=t.split("."),s=window,n=0;n<i.length;n++){if(!s[i[n]])return this.callable(null,e);s=s[i[n]]}return s===window?this.callable(null,e):this.callable(s,e)}return e?void 0:function(){}},children:function(t){var e=[];return this.each(function(){if(t){var i=!1,s="",n=this;return this.id||(this.id="rANd"+Math.ceil(100*Math.random()),i=!0),__.forEach(t.split(","),function(t,e){s&&(s+=","),s+="#"+n.id+">"+e}),e=e.concat(findElem.call(this,s)),void(i&&this.removeAttribute("id"))}e=e.concat(Array.from(this.children))}),_(e,this.debug)},randomString:function(t){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefjhijklmnopqrstuvwxyz",i="";for(t||(t=6);i.length<t;)i+=e[Math.floor(52*Math.random())];return i+"-"+Date.now()},clone:function(){return this.tryCatch(function(){return _(this.items.length?this.items[0].cloneNode(!0):[],this.debug)})},closest:function(t){return this.tryCatch(function(){var e=null;return this.items.length&&(e=this.items[0].closest(t),e===this.items[0]&&(e=null)),_(e,this.debug)})},contains:function(t,e,i){var s=this;return this.tryCatch(function(){if(s.isObject(t,!0)){var n=!1;return s.forEach(t,function(t,a){return s.contains(a,e,i)?(n=!0,!1):void 0}),n}if(this.isString(e))return s.isString(t)&&-1!==t.indexOf(e);if(this.isArray(e)){var n=!0;return this.forEach(e,function(e,a){return n=s.contains(t,a,i),!i&&n?!1:i?n:void 0}),n}})},createElement:function(t,e){var i=document.createElement(e||"div");return t?(i.innerHTML=t,_(Array.from(i.children),this.debug)):_(i,this.debug)},css:function(t,e){if(!t&&this.items.length)return this.items[0].style;if(void 0===e&&this.items.length){if(this.items[0].style[t])return this.items[0].style[t];var i=this.items[0].ownerDocument.defaultView;return i&&i.opener||(i=window),i.getComputedStyle(this.items[0])[t]}return this.each(function(){this.style[t]=e}),this},data:function(key,value){if(void 0!==value||__.isObject(key))return this.each(function(){privData.set(this,key,value)}),this;if(this.items.length)return value=privData.get(this.items[0],key),void 0===value&&(value=this.items[0].dataset[key]),this.tryCatch(function(){var val=eval(value);if(void 0===val)throw"error"},function(){return value})},each:function(t){return this.forEach(this.items,t)},error:function(t){return this.debug&&console.error(t),this},extend:function(t){var e=Array.from(arguments),i={},s=[],n=this,a=!1;return this.isBoolean(e[e.length-1])&&(a=e.pop(e)),this.forEach(e,function(t,e){n.isArray(e)?n.forEach(e,function(e,i){t&&s[e]&&(n.isArray(s[e])&&!n.isArray(i)||n.isObject(s[e])&&!n.isObject(i)||!n.isObject(s[e],!0)&&!n.isObject(i,!0)||!a)?s[e]=i:n.isObject(i,!0)&&t&&a?s[e]=n.extend(s[e],i,a):s.push(i)}):n.isObject(e)&&n.forEach(e,function(t,e){i[t]&&n.isObject(i[t])&&n.isObject(e)&&!n.isArray(e)&&a?i[t]=n.extend(i[t],e,a):i[t]=e})}),this.isArray(t)?s:i},filter:function(t){var e=this,i=this.items.filter(function(i,s){return t=e.callable(t),t?t.call(i,s,i):!0});return _(i,this.debug)},find:function(t){var e=[],i=this;return this.each(function(){e=i.items.length>1?e.concat(findElem.call(this,t)):findElem.call(this,t)}),_(e,this.debug)},forEach:function(t,e){return this.tryCatch(function(){return forEach(t,e),this})},get:function(t,e){var i=this.items[t];return e?_(i,this.debug):i},hasAttr:function(t){return this.tryCatch(function(){return null!==this.attr(t)&&void 0!==this.attr(t)})},hasClass:function(t){var e=!1;if(this.length){var i=this,s=t.split(" ");this.forEach(Array.from(this.items[0].classList),function(t,n){var a=0;return i.forEach(s,function(t,e){n===e&&a++}),a===s.length?(e=!0,!1):void 0})}return e},hasThis:function(t){return this.hasAttr("this-"+t)},hide:function(){var t=this;return this.each(function(){var e=_(this,t.debug);e.css("display")&&"none"!==e.css("display")&&e.data("display",this.style.display),this.style.display="none"})},html:function(t){if(void 0===t)return this.tryCatch(function(){return this.items.length?this.items[0].innerHTML:""});var e=this;return t instanceof _||t&&e.isObject(t)&&t.outerHTML?(this.html("").append(t),this):this.each(function(){this.innerHTML=t})},innerWrap:function(t){var e=this;return this.each(function(){var i=_(this);i.html(_(t,e.debug).html(i.html()))})},is:function(t,e){if(!this.items.length)return!1;if(e&&this.items[0].getAttribute("this-id")===t)return!0;var i=this.items[0];return(i.matches||i.matchesSelector||i.msMatchesSelector||i.mozMatchesSelector||i.webkitMatchesSelector||i.oMatchesSelector).call(i,t)},inArray:function(t,e){var i=this.extend(e);return this.removeArrayValue(i,t).length>0},isArray:function(t){return Array.isArray(t)},isBoolean:function(t){return t===!0||t===!1},isFunction:function(t){return"function"==typeof t},isObject:function(t,e){return t&&"object"==typeof t&&(e||!Array.isArray(t))},isNumeric:function(t){return!isNaN(t)},isString:function(t){return"string"==typeof t},inObject:function(t,e){var i=!1;return this.forEach(e,function(e,s){return s===t?(i=!0,!1):void 0}),i},keyExists:function(t,e){return e.hasOwnProperty(t)},next:function(){var t=[];return this.each(function(){this.nextElementSibling&&t.push(this.nextElementSibling)}),_(t,this.debug)},prev:function(){var t=[];return this.each(function(){this.previousElementSibling&&t.push(this.previousElementSibling)}),_(t,this.debug)},objectToQueryString:objToQStr,on:function(t,e,i){this.isFunction(e)&&!i&&(i=e,e=null);var s=this;return this.each(function(){var n=this;s.forEach(t.replace(/,/g," ").split(" "),function(t,a){n.addEventListener(a.trim(),function(t){var n=t.target;e&&n&&!n.matches(e)&&!(n=n.closest(e))||s.callable(i).apply(n,arguments)},!1)})})},outerHtml:function(){return this.tryCatch(function(){return this.items.length?this.items[0].outerHTML:""})},parent:function(){var t=[];return this.each(function(){t.push(this.parentElement)}),_(t,this.debug)},prepend:function(t){if(!t)return this;var e=t;return this.isString(t)&&!t.trim().startsWith("<")&&(e=this.createElement(null,"span").items[0].innerHTML=t),t instanceof _||(e=_(t,this.debug)),e.length?this.each(function(){var t=this;e.each(function(){t.insertAdjacentElement("afterBegin",this)})}):this},prop:function(t,e){return this.tryCatch(function(){return void 0!==e?(this.each(function(i,s){s[t]=e}),this):t&&this.items.length?this.items[0][t]:null})},queryStringToObject:qStrToObj,ready:function(t){return _(document,this.debug).on("DOMContentLoaded",t),this},remove:function(){var t=[];return this.each(function(){this.parentElement&&t.push(this.parentElement.removeChild(this))}),_(t,this.debug)},removeArrayIndex:function(t,e){return this.tryCatch(function(){return t.splice(e,1)[0]})},removeArrayValue:function(t,e,i){return this.tryCatch(function(){var s=t.indexOf(e),n=[];if(0>s&&(s=t.indexOf(parseInt(e))),i){for(;s>-1;){var a=this.removeArrayIndex(t,s);(a||0==a)&&n.push(a),s=t.indexOf(e),0>s&&(s=t.indexOf(parseInt(e)))}return n}return s>-1?[this.removeArrayIndex(t,s)]:[]})},removeAttr:function(t){var e=this;return t&&!__.isArray(t)&&(t=[t]),this.each(function(){var i=this;return t?void __.forEach(t,function(t,e){i.removeAttribute(e)}):void e.forEach(Array.from(this.attributes),function(){i.removeAttribute(this.name)})})},removeClass:function(t){var e=this;return this.each(function(){var i=this;e.forEach(t.split(" "),function(t,e){i.classList.remove(e)})})},removeData:function(t){return this.each(function(){privData.unset(this,t),delete this.dataset[t]})},removeThis:function(t){return this.removeAttr("this-"+t)},replaceWith:function(t){var e=[];return t=_(t,this.debug),this.each(function(){var i=t.items[0];i&&(this.replaceWith(i),e.push(i))}),this.items=e,this},siblings:function(t){var e=[];return this.each(function(){var i=!1,s="",n=this;this.id||(this.id=__.randomString(),i=!0),t?__.forEach(t.split(","),function(t,e){s&&(s+=","),s+=e+":not(#"+n.id+")"}):s=":not(#"+n.id+")",e=e.concat(_(this.parentElement,this.debug).children(s).items),i&&this.removeAttribute("id")}),_(e,this.debug)},show:function(){var t=this;return this.each(function(){var e=_(this,t.debug);e.data("display")&&"none"!==e.data("display")?(this.style.display=e.data("display"),e.removeData("display")):this.style.display=""})},text:function(t){return void 0===t?this.tryCatch(function(){return this.items.length?this.items[0].innerText:""}):this.each(function(){this.innerText=t})},"this":function(t,e){return this.attr("this-"+t,e)},toggle:function(){var t=this;return this.each(function(){"none"===_(this,t.debug).css("display")?_(this,t.debug).show():_(this,t.debug).hide()}),this},toggleClass:function(t){return this.each(function(){var e=_(this);e.hasClass(t)?e.removeClass(t):e.addClass(t)})},toJSONObject:function(t){return this.tryCatch(function(){return JSON.parse(t)},function(){})},toJSONString:function(t){return this.tryCatch(function(){return JSON.stringify(t)},function(){})},trigger:function(t,e){var i={detail:e,cancelable:!0,bubbles:!0},s=new CustomEvent(t,i);return this.each(function(){this.dispatchEvent(s)})},tryCatch:function(t,e){try{var i=this.callable(t).call(this);return i}catch(s){if(e)return this.callable(e).call(this,s);this.error(s.message)}},val:function(t){var e;return this.each(function(){return void 0!==t?(this.value=t,void _(this).attr("value",t)):void(e=this.value)}),void 0!==t?this:e},when:function(t,e,i){return this.tryCatch(function(){return when.call(this,t,e,i)})},wrap:function(t){var e=this,t=_(t,this.debug);return this.each(function(){_(this,e.debug).before(t).prev().html(this)})}}),_=function(t,e){if(!(this instanceof _))return new _(t,e);if(t instanceof _)return t;if(t)if(this.isObject(t))this.items=t instanceof HTMLCollection?Array.from(t):[t];else if(this.isArray(t))this.items=t;else if(this.isString(t)){var i=this.createElement(t);if(t.trim().startsWith("<thead")||t.trim().startsWith("<tbody"))return this.createElement(t,"table");if(t.trim().startsWith("<tr"))return this.createElement(t,"table").children();if(t.trim().startsWith("<td")||t.trim().startsWith("<th"))return this.createElement(t,"table").children().children();if(i.length)return i;this.items=findElem.call(document,t)}else this.error("Invalid selector");else this.items=[];return this.debug=e!==!1,this.length=this.items.length,this},ext={records:{},bindToElementModel:function(t,e,i){if(t=this._(t),e=this._(e),!t.length||!e.length)return Promise.reject("Target or Element not found");if(!e["this"]("mid")||!e["this"]("id")&&!e["this"]("model"))return this.error("Element to bind must be already bound to model."),Promise.reject("Element to bind must be already bound to model.");var s=e["this"]("model")||e["this"]("id"),n=this.getCached(t),a=this;return n.length&&(t["this"]("tar")&&n["this"]("tar",t["this"]("tar")),t=t.replaceWith(n)),t=ext.doTar.call(this,t,!0),this.promise(function(n,r){new Collection({app:this,name:s}).then(function(t){return t.model(e["this"]("mid"),{url:e["this"]("url")})}).then(function(o){if(i){var l=ext.getVariableValue.call(a,i,o.attributes);ext.bindToObject.call(a,t,l,function(e){t.replaceWith(e),n(t)})}else o.bind(t["this"]("model",s)["this"]("mid",e["this"]("mid"))["this"]("url",e["this"]("url"))["this"]("id-key",e["this"]("id-key"))).then(n)["catch"](r)})})},bindToObject:function(t,e,i){var s=ext.hideNotWiths.call(this,t);return ext.loadComponents.call(this,function(){return ext.parseData.call(this,e,t,!1,!0,function(t){ext.loadFormElements.call(this,t.find("[this-is]"),e),ext.showNotWiths.call(this,t,s),this.pageIsLoaded&&ext.postLoad.call(app,t),t.trigger("model.binded",{data:e}),__.callable(i).apply(this,arguments)}.bind(this))}.bind(this),t.find("[this-component]:not([this-ignore])"))},canContinue:function(t,e,i){var s=!0;return this.page&&this.beforeCallbacks[this.page["this"]("id")]&&(s=__.callable(this.beforeCallbacks[this.page["this"]("id")][t]).apply(i||this,e)),s!==!1&&this.beforeCallbacks.___common&&(s=__.callable(this.beforeCallbacks.___common[t]).apply(i||this,e)),s||s!==!1},checkTableContent:function(t){t=this._(t);var e=0,i=t.get(0);if(i)switch(i.tagName.toLowerCase()){case"td":e=3,t=this._("<table />").html(t.outerHtml());break;case"tr":e=2,t=this._("<table />").html(t.outerHtml());break;case"tbody":e=1,t=this._("<table />").html(t.outerHtml())}return{level:e,container:t}},cleanFilter:function(t){return t?(__.isString(t)&&(t=t.trim(),t.startsWith("({")&&(t=t.substr(2)),t.endsWith("})")&&(t=t.substr(0,t.length-2))),t):"true"},componentLoaded:function(t,e,i){return i||(t=this.container.find("[this-component]"),i=t.length)?void ext.loadComponent.call(this,t.get(t.length-i),function(){i--,ext.componentLoaded.call(this,t,e,i)}.bind(this)):__.callable(e).call(this)},dispatchEvent:function(t,e,i){return __.callable(containedEvents[t][this.page["this"]("id")]).apply(e,i)},doLoad:function(t,e,i,s,n,a){t=this._(t).hide();var r=t["this"]("model-id-key")||t["this"]("id-key")||"",o=ext.getUIDValue.call(this,e,r),l=t["this"]("url")||"",h=l.split("?");l=h[0],l&&!l.endsWith("/")&&(l+="/");var c=function(i){for(ext.loadFormElements.call(this,i.find("[this-is]"),e);n;)i=i.children(),n--;s?(t["this"]("id-key",r)["this"]("mid",o),t.html(i.html()).show()):(i["this"]("mid",o)["this"]("id-key",r)["this"]("type","model")["this"]("in-collection",""),i["this"]("url")||i["this"]("url",l+o),t["this"]("model")&&i["this"]("id",t["this"]("model")),t[t.hasThis("prepend")?"prepend":"append"](i.show()).removeThis("loading")),__.callable(a).call(this,t)}.bind(this);return ext.parseData.call(this,e,s?t:i,!1,s,c),this},doLoop:function(data,elem,filter,content,model){if(data){filter=ext.cleanFilter(filter),elem=this._(elem),content||(content=elem.outerHtml());var child=this._(content).get(0),app=this,level,index=0,process=function(t,e){var i={index:index,key:t,value:e},s=ext.inLoop.call(app,i,filter,content);if(index++,s){s=ext.processExpressions.call(app,s,i,model);for(var n=ext.parseBrackets.call(app,"{{","}}",s),s=app._(ext.fillVariables.call(app,n,i,s).replace(/{{key}}/g,t)),a=level;a;)s=s.children(),a--;__.isObject(e,!0)&&__.forEach(e,function(t,e){__.isObject(e,!0)&&s.find('[this-repeat-for="value.'+t+'"]').each(function(){var t=app._(this),i=t["this"]("filter"),s=t.removeThis("muted").removeThis("this-repeat-for").removeThis("filter").clone().outerHtml();ext.doLoop.call(app,e,this,i,s,model)})}),elem.hasThis("prepend")?elem.after(s.children()):elem.before(s.children())}};if(child)switch(child.tagName.toLowerCase()){case"td":level=3,content=this._("<table />").html(content).outerHtml();break;case"tr":level=2,content=this._("<table />").html(content).outerHtml()}if(content="<div>"+this._(content).show().outerHtml()+"</div>",__.isObject(data,!0))__.forEach(data,function(t,e){process(t,e)});else{var parts=data.substr(1,data.length-2).replace("...",",").split(","),current=parts[0],last=parts[1],diff=parts[2]||1,up;try{for(current=eval(current),last=eval(last),diff=eval(diff),current=parseInt(current),last=parseInt(last),diff=Math.abs(diff),up=last>current;up&&last>=current||!up&&current>=last;)process(current,current),up?current+=diff:current-=diff}catch(e){return void this.error(e)}}elem.remove()}},doTar:function(t,e){t=this._(t);var i=getElemType(t)||"",s=i+"#"+t["this"]("id");return this.tar[s]&&(__.forEach(this.tar[s],function(e,i){t["this"](""+e,i)}),delete this.tar[s]),t["this"]("tar")&&styleToObj(t["this"]("tar"),function(e,i){t["this"](e,i)}),e||"page"===i||t.show(),t.removeThis("tar")},emptyFeatures:function(t,e){return this._(t).find(e?'list,collection,[this-type="list"],[this-type="model"],[this-type="collection"]':'list:not([this-loaded]),model:not([this-loaded]),collection:not([this-loaded]),[this-type="list"]:not([this-loaded]),[this-type="collection"]:not([this-loaded])').each(function(){this.innerHTML=""}),this},eval:function(content,data){var variables=ext.parseBrackets.call(this,"{{","}}",content);return content=ext.fillVariables.call(this,variables,data,content),this.tryCatch(function(){return eval(content)},function(){})},extendLayout:function(t,e){var i=t.clone(),s=this;ext.loadAssets.call(this,i),t=this.reloadLayouts?_():this.container.find('layout[this-id="'+i["this"]("extends")+'"],[this-type="layout"][this-id="'+i["this"]("extends")+'"]'),t.length||(t=this.getCached('[this-type="layouts"] [this-id="'+i["this"]("extends")+'"]',"layout")),t.length?(i.removeThis("extends"),t["this"]("url")?this.request({url:t["this"]("url"),dataType:"text"}).then(function(n){t.removeThis("url").html(n).find("[this-content]").html(i.show()),t["this"]("extends")?ext.extendLayout.call(s,t,e):ext.finalizePageLoad.call(s,t,e)})["catch"](function(){}):(t.find("[this-content]").html(i.removeThis("extends").show()),t["this"]("extends")?ext.extendLayout.call(this,t,e):ext.finalizePageLoad.call(this,t,e))):ext.fullyFromURL.call(this,"layout",i["this"]("extends"),function(t){i.removeThis("extends"),t.removeThis("url").find("[this-content]").html(i),t["this"]("extends")?ext.extendLayout.call(s,t,e):ext.finalizePageLoad.call(s,t,e)},function(){s.error("Layout ["+i["this"]("extends")+"] not found!"),i.removeThis("extends"),ext.finalizePageLoad.call(s,i,e)})},fillAutocompleteList:function(options){var app=this,ids=[],data_length=Object.keys(options.data).length,_dropdownList,selected="";if(options.dropdownList){_dropdownList=options.dropdownList;var selected=_dropdownList["this"]("selected")||""}return __.forEach(options.data,function(i,v){if(options.filter=ext.cleanFilter(options.filter),options.filter){var kontinue,current={index:i,model:v};try{kontinue=eval(options.filter)}catch(e){}if(!kontinue)return}var id=ext.getUIDValue.call(app,v,options.idKey);return-1!==selected.indexOf(id+",")?void data_length--:(ids.push(id),void ext.bindToObject.call(app,app.getCached('[this-type="list"][this-id="'+options.list["this"]("id")+'"],list[this-id="'+options.list["this"]("id")+'"]').children(),v,function(t){t.show(),options.list.append(t["this"]("index",i)["this"]("type","listing")["this"]("id",id)).show()}))}),ids.length?(_dropdownList&&!options.ignoreIds&&_dropdownList["this"]("selected",(_dropdownList["this"]("selected")||"")+ids.join(",")+","),options.list.trigger("list.loaded")):options.list.trigger("list.no.data"),ids},fillVariables:function(t,e,i){var s=this;return t&&e&&i&&__.forEach(t,function(t,n){var a=ext.getVariableValue.call(s,n,e);i=i.replace(n.trim(),a||0==a?a:n)}),i},finalizePageLoad:function(t,e){this.removedAssets={},ext.loadAssets.call(this,t);var i=this;t&&t.length?(t.hasThis("loaded")||this.container.html(t.show()),t.trigger("layout.loaded")["this"]("loaded","")):this.container.html(this.page),this.container.find("[this-content]").each(function(){var t=_(this);t["this"]("content")||t["this"]("content",t.closest('layout,[this-type="layout"]')["this"]("id"))}),this.page=this.container.find('page[this-id="'+this.page["this"]("id")+'"]:not([this-dead]),[this-type="page"][this-id="'+this.page["this"]("id")+'"]:not([this-dead])')["this"]("current","").removeThis("layout").hide(),this.container.find('[this-type]:not([this-type="page"]):not(page):not(layout):not([this-type="layout"]):not(component):not([this-type="component"]),[this-repeat-for]').hide(),delete this.pageModel,this.pageIsLoaded=!1;var s=function(){ext.loadComponents.call(this,function(){this.page=ext.doTar.call(this,this.page).hide(),this.page["this"]("url")&&this.page["this"]("model")&&"create"!==this.page["this"]("do")?new Collection({app:this,name:this.page["this"]("model")}).then(function(t){return t.model(this.page["this"]("mid"),{url:this.page["this"]("url"),ignoreCache:this.page.hasThis("ignore-cache")||!ext.config.call(this).cacheData})}.bind(this)).then(function(t){this.pageModel=t,ext.loadModel.call(this,this.page,function(){ext.showPage.call(this,e)}.bind(this),t.attributes||{})}.bind(this))["catch"](function(){ext.loadModel.call(i,this.page,function(){ext.showPage.call(this,e)}.bind(i),null)}):ext.showPage.call(this,e)}.bind(this))}.bind(this);this.page["this"]("path")?this.request({url:this.page["this"]("path"),dataType:"text"}).then(function(t){i.page.html(t).show().find('[this-type]:not(component):not([this-type="component"])').hide(),ext.loadAssets.call(i,i.page,s)})["catch"](function(){}):ext.loadAssets.call(this,this.page,s)},fullyFromURL:function(t,e,i,s){if(!ext.config.call(this).paths)return void __.callable(s).call(this);var n=this,a=ext.config.call(this).paths[t+"s"];if(!__.isObject(a))return void this.__callable(s).call(this);var r=a.dir+e+a.ext;this.request({url:r,dataType:"text"
}).then(function(s){var a=__.createElement(s),r=function(t){var e=ext.removeComments.call(n,t.html());t.html(e),t.find('[this-type="collection"]:not([this-model]),collection:not([this-model])').each(function(){n._(this)["this"]("model",n._(this)["this"]("id"))}),t.find("[this-autocomplete][this-list]").each(function(){var e=n._(this),i=t.find('list[this-id="'+e["this"]("list")+'"],[this-type="list"][this-id="'+e["this"]("list")+'"]')["this"]("autocompleting",e["this"]("id"));t.find('list[this-id="'+i["this"]("selection-list")+'"],[this-type="list"][this-id="'+i["this"]("selection-list")+'"]')["this"]("parent-list",i["this"]("id"))}),t.find("img[src]").each(function(){var t=n._(this);t.attr("src")&&t.attr("this-src",t.attr("src")).removeAttr("src")})},o=function(){__.callable(i).call(this,a.clone())}.bind(this);"component"===t?(a=n._('<div this-type="component" this-url="'+e+'"/>').html(a),r(a),ext.loadCollections.call(n,function(){n.addToCache(a),1===a.children().length&&(a=a.children()),o()},a.find('[this-type="collection"][this-static]:not([this-ignore]),collection[this-static]:not([this-ignore])'))):(!a.length||a.length>1?a=n._('<div this-type="'+t+'" />').html(s):a.is(t)||a["this"]("type")===t||(a["this"]("type")?a=a.wrap('<div this-type="page" />').parent():a["this"]("type",t)),a["this"]("id",e.replace(/\/\\/g,"-")),"page"===t&&(-1!==e.indexOf("/")&&a["this"]("path",e),r(a)),n.addToCache(a),o())})["catch"](function(t){__.callable(s).call(this,t)})},getComments:function(t){return ext.parseBrackets.call(this,"<!--","-->",t)},getDeepValue:function(t,e){var i=e,s=__.isObject(t,!0)?t:t.split(".");return __.forEach(s,function(t,e){return i?void(i=i[e]):!1}),i||0==i?i:""},getExpressions:function(t){var e=[];return __.forEach(t.split("({"),function(t,i){t&&e.push("({"+i.split("})")[0]+"})")}),e},getTemplatePath:function(){var t=location.pathname;return this.container.hasThis("auto-id")||(t+=this.container["this"]("id")),t},getUIDValue:function(t,e){return ext.getDeepValue.call(this,e||ext.config.call(this).idKey,t)},getVariableValue:function(t,e){if(t){var i=t.replace(/{*}*/g,"").replace(/\\\|/g,"__fpipe__").replace(/(\s*)?\|(\s*)?/g,"|").trim().split("|"),s=i.shift(0).trim(),n=__.contains(s,".")?ext.getDeepValue.call(null,s,e):e[s];if(__.forEach(i,function(t,e){e=e.trim().replace(/__fpipe__/g,"|");var i=e.split("="),s=i.shift(0).trim();Filters[s]&&(n=Filters[s](n,i.join(";")))}),n||0==n)return n}},hideNotWiths:function(t){var e=t.find('[this-not-with="'+t["this"]("id")+'"]'),i=0,s={};for(t["this"]("id")||t["this"]("id",__.randomString());e.length;){var n=t["this"]("id")+"-"+i;s[n]=e.get(0),this._(e.get(0)).replaceWith('<div this-with="'+n+'" />'),e=t.find('[this-not-with="'+t["this"]("id")+'"]'),i++}return s},inLoop:function(current,filter,content,returnObject){filter=ext.cleanFilter(filter);var good=this.tryCatch(function(){return!filter||eval(filter)},function(){return!1});if(good){content=this._("<div/>").html(content);var app=this,level=0,matched={};return content.find('collection,model,list,[this-repeat-for],[this-type="collection"],[this-type="model"],[this-type="list"]').each(function(){var t=app._(this);t.html(t.html()),t["this"]("this-repeat-for")&&t.find("[this-if], [this-else-if], [this-else]")["this"]("ignore","")["this"]("muted","")}),content.find("[this-if],[this-else-if],[this-else]").each(function(){var __this=app._(this);if(!__this.hasThis("ignore"))if(__this["this"]("if")){try{level++,matched[level]=!1,eval(__this["this"]("if").trim())?(__this.removeThis("if"),matched[level]=!0):__this.remove()}catch(e){__this.remove()}__this.hasThis("end-if")&&(__this.removeThis("end-if"),delete matched[level],level--)}else if(__this["this"]("else-if")){try{if(!__.isBoolean(matched[level]))return void app.error("Branching error: Else-if without If!");matched[level]||!eval(__this["this"]("else-if").trim())?__this.remove():(__this.removeThis("else-if"),matched[level]=!0)}catch(e){__this.remove()}__this.hasThis("end-if")&&(__this.removeThis("end-if"),delete matched[level],level--)}else if(__this.hasThis("else")){try{if(!__.isBoolean(matched[level]))return void app.error("Branching error: Else without If!");matched[level]?__this.remove():__this.removeThis("else")}catch(e){__this.remove()}__this.hasThis("end-if")&&__this.removeThis("end-if"),delete matched[level],level--}}),content.find("[this-if][this-ignore],[this-else-if][this-ignore],[this-else][this-ignore],[this-end-if][this-ignore]").removeThis("ignore"),returnObject?content.children():content.html()}},is:function(t,e){return this._(e)["this"]("type")===t||this._(e).is(t)},isRunning:function(){var t;return this.container&&(t=ext.record.call(this)),t&&t.running},config:function(){return ext.record.call(this,"config")},loadAsset:function(type,name,elem,callback){name=name.trim();var url=-1!==name.indexOf("://")||name.startsWith("//")?name:ext.config.call(this).paths[type]+name,app=this,load=function(url){"js"===type?eval(pageAssets.js[url]):"css"===type&&elem.prepend('<style type="text/css">'+pageAssets.css[url]+"</style>"),__.callable(callback).call(this,pageAssets[type][url])}.bind(this);return url.endsWith("."+type)||(url+="."+type),pageAssets[type]||(pageAssets[type]={}),ext.record.call(this,"debug")||!pageAssets[type][url]?this.request({dataType:"css"===type?"text/css":"text/javascript",url:url}).then(function(t){pageAssets[type][url]=t,load(url)})["catch"](function(){load(url)}):load(url),ext},loadAssets:function(t,e){var i,s=this,n=getElemType(t)||"",a=0,r=!1,o=function(){r&&!a&&__.callable(e).call(this)}.bind(this);if(t["this"]("load-css")&&!t.hasThis("with-css")){a++;var l=t["this"]("load-css").split(",");__.forEach(l,function(e,i){ext.loadAsset.call(s,"css",i,t,function(){l.length-1===e&&(a--,o())})}),t["this"]("with-css","").removeThis("load-css")}if(Object.keys(this.removedAssets).length||this._('script[this-app="'+this.container["this"]("id")+'"]').removeThis("loaded"),t["this"]("load-js-first")&&!loadedPageJS.first[this.page["this"]("id")]){i=!0,a++;var h=t["this"]("load-js-first").split(","),c=this.removedAssets[n];__.forEach(h,function(e,i){ext.loadAsset.call(s,"js",i,t,function(){h.length-1===e&&(c||s._('script[this-app="'+s.container["this"]("id")+'"][this-for="'+n+'"]:not([this-loaded])').remove(),a--,o())})}),loadedPageJS.first[this.page["this"]("id")]=!0}return i||this.removedAssets[n]||this._('script[this-app="'+this.container["this"]("id")+'"][this-for="'+n+'"]:not([this-loaded])').remove(),this.removedAssets[n]=!0,r=!0,o(),ext},loadCollection:function(t,e,i,s){if(t=this._(t)["this"]("loading",""),!t["this"]("id"))return t.removeThis("loading"),void __.callable(e).call(this);t["this"]("model")||t["this"]("model",t["this"]("id"));var n=this.getCached('[this-id="'+t["this"]("id")+'"]',"collection");return ext.loadComponents.call(this,function(){var a=n.children("[this-on-empty]").remove().removeThis("on-empty").removeThis("on-emptied").removeThis("[this-first-child]").outerHtml(),r=n.children("[this-first-child]").remove().removeThis("first-child").removeThis("on-emptied").outerHtml(),o=n.children(":not([this-on-emptied])").get(0,!0).outerHtml(),l=this;t["this"]("model");t=ext.doTar.call(this,t,!0),t.hasThis("paginate")&&t.children(":first-child")["this"]("mid")||t.html("");var h,c,d={},u=ext.config.call(this).cacheData;l.page["this"]("query")&&(d.query=l.page["this"]("query"),u=!1),t["this"]("search")&&(d.keys=t["this"]("search")),t.hasThis("paginate")&&(t["this"]("pagination-page")||t["this"]("pagination-page",0),void 0!==t["this"]("pagination-page")&&(d.page=parseInt(t["this"]("pagination-page"))+1,t["this"]("pagination-page",d.page),t["this"]("paginate")?d.limit=t["this"]("paginate"):ext.config.call(this).pagination&&ext.config.call(this).pagination.limit&&(d.limit=ext.config.call(this).pagination.limit))),h=function(i,s,n){return r&&t.prepend(r),s&&t["this"]("model-id-key",s),(!i||__.isObject(i,!0)&&!Object.keys(i).length)&&(t.html(a)["this"]("loaded","").removeThis("loading").show(),__.callable(e).call(this,i),i=!1),t.trigger("collection.loaded"),n?void __.callable(e).call(l,i||{}):void(i&&ext.loadData.call(l,t,i,o,!1,u,function(t){t&&t["this"]("loaded","").removeThis("loading").trigger("collection.loaded"),__.callable(e).call(this,i)}.bind(l)))},c=function(){a&&t.html(a).show(),void 0!==t["this"]("pagination-page")&&t["this"]("pagination-page",parseInt(t["this"]("pagination-page"))-1),t.removeThis("loading").trigger("collection.loaded"),__.callable(e).call(l)},ext.loadOrRequestData.call(this,{elem:t,content:o,data:i,success:h,error:c,replaceState:s,requestData:Object.keys(d).length?d:null})}.bind(this),n.find("[this-component]:not([this-ignore])")),this},loadCollections:function(t,e,i){var s=this,n=null===e,e=e||this.container.find('collection:not([this-loaded]):not([this-data]):not([this-loading]):not([this-ignore]),[this-type="collection"]:not([this-loaded]):not([this-data]):not([this-loading]):not([this-ignore])'),a=e.length,r=function(){a||(n?ext.loadForms.call(this,null,null,i,n):__.callable(t).call(s))}.bind(this);return a?e.each(function(){ext.loadCollection.call(s,this,function(){a--,r()}.bind(s),null,i)}):r(),this},loadComponent:function(t,e,i){t=this._(t);var s=this;if(!i||!this._(i).length){if(t["this"]("url")){var n=this.getCached('[this-url="'+t["this"]("url")+'"]',"component");n.length?ext.loadComponent.call(this,t,e,n.children().clone().show()):ext.fullyFromURL.call(s,"component",t["this"]("url"),function(i){ext.loadComponent.call(s,t,e,s._(i).clone())},function(){t.remove(),__.callable(e).call(s)})}else i=this.getCached('[this-id="'+t["this"]("component")+'"]',"component"),i.length?ext.loadComponent.call(this,t,e,i):__.callable(e).call(this);return ext}i=this._(i).clone(),(i.is("component")||"component"===i["this"]("type"))&&i.removeThis("url"),t.replaceWith(i.show()).trigger("component.loaded"),this.pageIsLoaded&&ext.postLoad.call(this,t,!0),__.callable(e).call(this)},loadComponents:function(t,e){var i=this,e=e||this.container.find("[this-component]:not([this-ignore])"),s=e.length;return s?ext.loadComponent.call(i,e.get(0),function(){s--,ext.componentLoaded.call(this,e,t,s)}.bind(this)):__.callable(t).call(this),this},loadData:function(t,e,i,s,n,a){t=this._(t);var r=function(){if(t.hasThis("paginate")){var e='[this-paginate-next="'+t["this"]("id")+'"],[this-paginate-previous="'+t["this"]("id")+'"]',i='[this-paginate-next=""],[this-paginate-previous=""]';setTimeout(function(){this.container.find(e).hide(),t.siblings(i).hide()}.bind(this)),t["this"]("pagination-page",parseInt(t["this"]("pagination-page"))-1)}}.bind(this);if(!e)return r(),t.trigger("invalid.response"),void __.callable(a).call(this);var o={data:{},expires:(new Date).setMilliseconds(864e5)},l=t["this"]("data-key")||ext.config.call(this).dataKey,h=getRealData.call(this,e,l);if(l&&(isNaN(e.expires)?__.isString(e.expires)&&(o.expires=new Date(e.expires).getTime()):o.expires=(new Date).setMilliseconds(1e3*e.expires),e=h),!e||!__.isObject(e,!0)||!Object.keys(e).length)return r(),t.trigger("empty.response"),void __.callable(a).call(this);var c=t["this"]("model")||t["this"]("id"),d=function(){if(t.removeThis("filter").show(),t.hasThis("static")){var e=t["this"]("id"),i=getElemType(t);this.replaceCached(i+'[this-id="'+e+'"],[this-type="'+i+'"][this-id="'+e+'"]',t["this"]("loaded",""))}__.callable(a).apply(this,arguments)}.bind(this);if(__.isArray(e)||s===!1){var u=ext.canContinue.call(this,"collection.render",[e],t.get(0));if(!u)return this;__.isObject(u,!0)&&(e=u);var p=this,f=t["this"]("filter"),g=t["this"]("model-id-key")||ext.config.call(this).idKey,m=ext.checkTableContent.call(this,i),_=m.level,i=m.container.outerHtml();this.collectionData=Object.keys(this.cacheTargets||e).length;var v=function(){if(t.hasThis("paginate")){var e='[this-paginate-next="'+t["this"]("id")+'"]',i='[this-paginate-next=""]';(t.hasThis("paginate-overwrite")&&"true"===t["this"]("paginate-overwrite")||!t.hasThis("paginate-overwrite")&&ext.config.call(this).pagination&&ext.config.call(this).pagination.overwrite&&1===t["this"]("pagination-page"))&&(e+=',[this-paginate-previous="'+t["this"]("id")+'"]',i+=',[this-paginate-previous=""]'),this.container.find(e).hide(),t.siblings(i).hide(),t["this"]("pagination-page",parseInt(t["this"]("pagination-page"))-1)}}.bind(this);if(this.collectionData){t.hasThis("paginate-overwrite")?"true"===t["this"]("paginate-overwrite")&&t.html(""):ext.config.call(this).pagination&&ext.config.call(this).pagination.overwrite&&t.html("");var y=[],b=function(){--this.collectionData||(delete this.collectionData,__.callable(d).call(this,t))}.bind(this);__.forEach(this.cacheTargets||e,function(s,r){var l,h;p.cacheTargets?(l=r,h=e[l]):(h=r,l=ext.getUIDValue.call(p,r));var c=p._(i),d=ext.canContinue.call(p,"collection.model.render",[h,t.get(0)],c.get(0));t.children('[this-mid="'+l+'"]').remove();var u=ext.getUIDValue.call(p,h,g);if(y.push(u||l),!d)return void b();__.isObject(d)&&(h=d),n!==!1&&(t.hasThis("paginate")&&(h.__page=t["this"]("pagination-page")),o.data[u||l]=h);var m=ext.inLoop.call(p,{index:l,model:h},f,c.outerHtml().replace(/{{_index}}/g,l));if(!m)return void __.callable(a).call(p);m=p._(ext.processExpressions.call(p,m,{index:l,model:h}),h),g||(g=ext.config.call(p).idKey);var v=g.split(".").reverse(),x={},T=v.pop();h[T]||($.each(v,function(t,e){t?x[e]=x:x[e]=u||l}),h[T]=x),ext.doLoad.call(p,t,h,m,!1,_,b)}),delete this.cacheTargets;var x=t["this"]("pagination-page");void 0!==x&&(1==x?(this.container.find('[this-paginate-previous="'+t["this"]("id")+'"]').hide(),t.siblings('[this-paginate-previous=""]').hide()):(t.hasThis("paginate-overwrite")&&"true"===t["this"]("paginate-overwrite")||!t.hasThis("paginate-overwrite")&&ext.config.call(this).pagination&&ext.config.call(this).pagination.overwrite)&&(this.container.find('[this-paginate-previous="'+t["this"]("id")+'"]').show(),t.siblings('[this-paginate-previous=""]').show()),this.container.find('[this-paginate-next="'+t["this"]("id")+'"]').show(),t.siblings('[this-paginate-next=""]').show()),n!==!1&&t.hasThis("paginate")&&(o.pagination={},o.pagination[x]=y),(t["this"]("paginate")&&y.length!=t["this"]("paginate")||!t["this"]("paginate")&&ext.config.call(this).pagination&&ext.config.call(this).pagination.limit&&y.length!=ext.config.call(this).pagination.limit)&&v()}else v(),n=!1,delete this.collectionData,__.callable(d).call(this,t);t.hasThis("paginate")&&(this.container.find('[this-paginate-next="'+t["this"]("id")+'"],[this-paginate-previous="'+t["this"]("id")+'"]').removeAttr("disabled"),t.siblings('[this-paginate-next=""],[this-paginate-previous=""]').removeAttr("disabled")),n!==!1&&(ext.store.call(this,c).saveMany(o.data,g),ext.record.call(this).expirationStore.save(o.expires,c),ext.record.call(this).paginationStore.save(o.pagination,c))}else if(e&&s){var u=ext.canContinue.call(this,"model.render",[e],t.get(0));if(!u)return this;if(__.isObject(u)&&(e=u),n!==!1){var T=ext.getUIDValue.call(this,e,t["this"]("id-key"));ext.store.call(this,c).save(e,T)}e._url=t["this"]("url"),ext.doLoad.call(this,t,e,i,!0,null,d)}return t.removeThis("filter"),this},loadFormElements:function(t,e){if(t.length&&e){var i=this;__.forEach(t,function(){var t=i._(this),s=t["this"]("is");if(s){var n=ext.getVariableValue.call(i,s,e);if(n)if(!t.hasThis("autocomplete")&&__.isObject(n)&&(n=ext.getUIDValue.call(i,n)),t.removeThis("is"),"radio"===t.attr("type")||"checkbox"===t.attr("type"))t.attr("value")!=n&&n!=on||t.attr("checked","checked");else if(t.is("select"))t.children().each(function(){var t=i._(this).attr("value")||i._(this).html().trim();t==n?i._(this).attr("selected","selected"):i._(this).removeAttr("selected")}),t.find('[value="'+n+'"]').attr("selected","selected");else if(t.is("textarea"))t.html(n);else if(t.hasThis("autocomplete")){var a=i.container.find('list[this-id="'+t["this"]("list")+'"],[this-type="list"][this-id="'+t["this"]("list")+'"]'),r=i.container.find('list[this-id="'+a["this"]("selection-list")+'"],[this-type="list"][this-id="'+a["this"]("selection-list")+'"]'),o=function(e){var s=[];if(e){if(!__.isObject(e,!0)){if(t["this"]("value-key"))return void t.val(e);var n=e;e={},e[ext.config.call(i).idKey||"id"]=n}t.hasThis("multiple")||(__.isObject(e)&&(e=[e]),t.hide()),s=ext.fillAutocompleteList.call(this,{list:r.html(""),data:e,dropdownList:a})}}.bind(i);if(r["this"]("refill"))return __.callable(r["this"]("refill")).call(this,n,o);if(r["this"]("refill-url"))return i.request({dataType:"json",type:"POST",url:r["this"]("refill-url"),data:{ids:n}}).then(function(t){o(getRealData.call(i,t))})["catch"](function(){});o(n)}else"img"===t.get(0).tagName.toLowerCase()?t.attr("src",n):t.attr("value",n)}})}return this},loadForms:function(t,e,i,s){var n=this,a=!1;return t||(a=this.page.is("form"),t=a?this.page:this.container.find("form")),t.each(function(){var t=n._(this);if(t.is("form")){if(!t.hasThis("do")&&n.page["this"]("do")&&t["this"]("do",n.page["this"]("do")),("search"===t["this"]("do")||"search"===n.page["this"]("do"))&&n.page["this"]("query"))return void t.find("[this-search]").attr("value",n.page["this"]("query"));ext.doTar.call(n,t,!0)}var i=t["this"]("mid")||n.page["this"]("mid"),s=t["this"]("model")||n.page["this"]("model");i&&(e||(e=ext.modelFromStore.call(n,i,s)),ext.loadFormElements.call(n,t.find("[this-is]"),e),t.is("form")&&t["this"]("loaded","").trigger("form.loaded"))}),s&&ext.pageLoaded.call(this,i),this},loadLayouts:function(t){var e=_(),i=this;if(this.page.hasThis("no-layout")||!ext.config.call(this).layout&&!this.page["this"]("layout"))ext.finalizePageLoad.call(this,e,t);else{var s=this.page["this"]("layout")||ext.config.call(this).layout;e=this.reloadLayouts?e:this.container.find('layout[this-id="'+s+'"],[this-type="layout"][this-id="'+s+'"]'),e.length?(this.page.hasThis("loaded")||e.find('[this-content="'+e["this"]("id")+'"]').html(this.page),e["this"]("loaded",""),ext.finalizePageLoad.call(this,e,t)):(e=this.getCached('[this-id="'+s+'"]',"layout"),e.length?e["this"]("url")?this.request({url:e["this"]("url"),dataType:"text"}).then(function(s){e.removeThis("url").html(s).find("[this-content]").html(i.page),e["this"]("extends")?ext.extendLayout.call(i,e,t):ext.finalizePageLoad.call(i,e,t)})["catch"](function(){i.error("Layout ["+s+"] not found!"),ext.finalizePageLoad.call(i,e,t)}):(e.find("[this-content]").html(i.page),e["this"]("extends")?ext.extendLayout.call(this,e,t):ext.finalizePageLoad.call(this,e,t)):ext.fullyFromURL.call(this,"layout",s,function(e){e.removeThis("url").find("[this-content]").html(i.page),e["this"]("extends")?ext.extendLayout.call(i,e,t):ext.finalizePageLoad.call(i,e.clone(),t)},function(){i.error("Layout ["+s+"] not found!"),ext.finalizePageLoad.call(i,e,t)}))}},loadModel:function(t,e,i,s){function n(t){this.notWiths=ext.hideNotWiths.call(this,a),Object.keys(this.notWiths).length&&(t=a.outerHtml());var n=function(i,s,n){return a.removeThis("loading"),n?void __.callable(e).call(r,i):void ext.loadData.call(r,a,i,t,!0,"page"!==o||ext.config.call(r).cacheData===!1,function(t){t&&t["this"]("loaded","").removeThis("loading").trigger("model.loaded").show(),__.callable(e).call(this,i)}.bind(r))},l=function(){a.removeThis("loading"),__.callable(e).call(r)};i?n(i):ext.loadOrRequestData.call(this,{elem:a,content:t,data:i,success:n,error:l,replaceState:s})}var a=this._(t),r=this,o=getElemType(a),l="";return a["this"]("loading","").find('collection:not([this-ignore]),[this-type="collection"]:not([this-ignore])')["this"]("loading",""),a["this"]("id")?l+='[this-id="'+a["this"]("id")+'"]':a["this"]("model")&&(l+='[this-model="'+a["this"]("model")+'"]'),a=ext.doTar.call(this,a,!0),i||a["this"]("url")?("page"!==o&&a.html(this.getCached(l,o).hide().html()),ext.loadComponents.call(this,function(){n.call(r,a.outerHtml())},a.find("[this-component]:not([this-ignore])")),r):void __.callable(e).call(this)},loadModels:function(t,e){var i=this,s=this.page.find('model:not([this-in-collection]):not([this-ignore]),[this-type="model"]:not([this-in-collection]):not([this-ignore])'),n=s.length;return e&&!n&&ext.loadCollections.call(this,null,null,t),s.each(function(){ext.loadModel.call(i,this,function(){n--,e&&!n&&ext.loadCollections.call(this,null,null,t)}.bind(i),null,t)}),this},loadOrRequestData:function(t){var e,i,s=this,n=ext.is.call(this,"collection",t.elem),a=n?"collection":"model",r=s.page["this"]("ignore-cache")||"",o=t.elem["this"]("model")||t.elem["this"]("id"),l=ext.record.call(this).expirationStore.find(o),h=l&&l<Date.now()||!l;if(ext.config.call(this).cacheData)if(n){if(e=ext.store.call(s,o).find(),t.elem.hasThis("paginate")&&e){var c=ext.record.call(s).paginationStore.find(o);c&&void 0!==c[t.elem["this"]("pagination-page")]&&c[t.elem["this"]("pagination-page")].length===t.requestData.limit?this.cacheTargets=c[t.elem["this"]("pagination-page")]:e=null}}else e=ext.store.call(s,o).find(t.elem["this"]("mid"));var d=function(){s.pageIsLoaded&&ext.postLoad.call(s,t.elem),__.callable(t.success).apply(t.elem,arguments),t.elem.trigger("load.content.success"),t.elem.trigger("load.content.complete")}.bind(this),u=function(){p(t,!0)||(__.callable(t.error).apply(t.elem,arguments),t.elem.trigger("load.content.error"),t.elem.trigger("load.content.complete"))}.bind(this),p=function(t,s){if(!t.data&&e&&Object.keys(e).length&&(t.looping&&this.__proto__[a+"s"]--,t.data=e,i=!0),t.data){var r={},o=t.elem["this"]("data-key")||ext.config.call(this).dataKey;return o&&(r[o]=t.data,t.data=r),ext.watch.call(this,t.elem),ext.loadData.call(this,t.elem,t.data,t.content,!n,!1,function(e){e&&i&&(h?e.trigger("expired."+a+".cache.loaded"):e.trigger(a+".cache.loaded"),e.removeThis("loading")["this"]("loaded","")),__.callable(d).call(this,t.data,null,!0)}.bind(this)),!0}return s||__.callable(t.error).call(this),!1}.bind(this);if(!t.data&&(!e||e&&h||__.contains(r,a+"#"+t.elem["this"]("id"))||t.elem.hasThis("ignore-cache"))){var a;try{a=ext.config.call(s).crud.methods.read}catch(f){a="get"}return ext.request.call(this,t.elem,function(){return!t.elem.hasThis("no-updates")&&this.watchCallback&&ext.watch.call(this,t.elem),t.elem.removeThis("no-updates"),{elem:t.elem,type:a,id:t.elem["this"]("mid"),url:t.elem["this"]("url"),isCollection:n,data:t.requestData,success:d,error:u}},function(){return{type:a,url:t.elem["this"]("url"),data:t.requestData,success:d,error:u}},function(){p(t)})}p(t)},log:function(t,e){return ext.record.call(this,"debug")&&console[t].apply(null,__.isArray(e)?e:[e]),this},loop:function(t,e){if(e){t=this._(t);for(var i=t.find("[this-repeat-for]");i.length;){var s=i.get(0,!0),n=s["this"]("repeat-for").trim(),a=ext.getVariableValue.call(this,n,e,!1),r=s["this"]("filter"),o=s.removeThis("muted").removeThis("filter").removeThis("repeat-for").outerHtml(),l=!1;s.html(""),a||(-1!==n.indexOf("...")?(l=!0,a=n):n.startsWith("{{")?a=ext.getVariableValue.call(this,n,e,!0):(n.startsWith("({")&&(n=n.substr(1,n.length-2)),a=ext.eval.call(this,n,e))),l||__.isObject(a,!0)?ext.doLoop.call(this,a,s,r,o,e):s.remove(),i=t.find("[this-repeat-for]")}}},modelFromStore:function(t,e){return this.tryCatch(function(){var i=ext.store.call(this,e).find(t),s=ext.record.call(this).expirationStore.find(e);return s&&s<Date.now()?null:i})},modelToStore:function(t){return this.tryCatch(function(){var e=ext.store.call(this,t.modelName);t.expireCollection&&(ext.record.call(this).expirationStore.save(Date.now(),t.modelName),ext.record.call(this).paginationStore.remove(t.modelName));var i=e.save(t.model,t.modelId||ext.getUIDValue.call(this,t.model));if(!t.ignoreDOM){var s=t.isNew?"createdStore":"updatedStore",n=ext.record.call(this,s),a=n.find(t.modelName);t.isNew?(a||(a=[]),__.removeArrayValue(a,t.modelId,!0),a.push(t.modelId)):(a||(a={}),a[t.modelId]={data:i,timestamp:Date.now()}),n.save(a,t.modelName),ext.updatePage.call(this)}return i})},notAPage:function(t){return this.error("Page ["+t+"] not found"),this.container.trigger("page.not.found",{pageId:t}),__.isString(this.notFound)?(t=this.getCached(ext.selector.call(this,this.notFound.startsWith("page#")?this.notFound:"page#"+this.notFound)),t.length?(ext.pageFound.call(this,t,!0),this):this.error("Page ["+this.notFound+"] also not found")):(delete this._params,__.callable(this.notFound).call(this,t))},pageFound:function(t,e){ext.is.call(this,"page",t)?(this.page&&(this.oldPage=this.page["this"]("dead","").trigger("page.leave"),this.oldPage["this"]("id")===t["this"]("id")&&(e=!0)),this.page=t.clone().show(),this.__proto__.modelParams=this._params||[],delete this._params,ext.loadLayouts.call(this,e)):(delete this._params,this.error("Load page failed: "+t["this"]("id")),t.trigger("page.load.failed"))},pageIDFromLink:function(t,e){this.linkAnalytics||(this.linkAnalytics={}),this.linkAnalytics[t]||(this.linkAnalytics[t]=analyzeLink(t));var i=this.linkAnalytics[t],s=i.page;if(this._params=i.url?i.url.split("/"):[],i.model&&this._params.unshift(i.model),e){var n=s.split("?");return this.params=i.params||{},this.pageAction=i.action,this.GETParams=location.search?qStrToObj(location.search.substr(1)):{},n[0]}return s},pageLoaded:function(t,e){if(this.__proto__.modelCollections)return this;var i=this;if(this.loadedPartial=!this.firstPage,delete this.linkAnalytics,e?(this.page["this"]("restored",""),ext.updatePage.call(this,!0),this.restored=!0,this.page.trigger("page.loaded"),ext.config.call(this).cacheData===!1&&this.clearPageCache()):(this.restored=!1,this.notWiths&&(ext.showNotWiths.call(this,this.page,this.notWiths),delete this.notWiths),ext.postLoad.call(this,this.container),this.page=this.container.find('[this-type="page"],page'),this.page.find('[this-type="template"]').remove(),this.page.trigger("page.loaded"),ext.store.call(this,"___cache").save(this.templates.html(),ext.getTemplatePath.call(this),!0),ext.saveState.call(this,t)),this.firstPage){e&&this.container.find('collection[this-loaded],[this-type="collection"][this-loaded],model[this-loaded],[this-type="model"][this-loaded]').each(function(){ext.watch.call(i,this)});var s=ext.record.call(this).store.find("watching");s&&__.forEach(s,function(t,e){ext.watch.call(i,i._('<div this-id="'+t+'" this-type="'+e.type+'" this-url="'+e.url+'" this-mid="'+e.mid+'" />'))}),delete this.firstPage}if(this.page["this"]("load-js")&&!loadedPageJS.last[this.page["this"]("id")]){var n=this.page["this"]("load-js").split(",");__.forEach(n,function(t,e){ext.loadAsset.call(i,"js",e,i.page)}),loadedPageJS.last[this.page["this"]("id")]=!0}return ext.record.call(this).store.save(this.watching,"watching"),this.pageIsLoaded=!0,this},parseBrackets:function(t,e,i){return i?__.tryCatch(function(){return i.match(new RegExp(t+"\\s*[^"+e+"]+\\s*"+e,"gi"))||[]}):[]},parseData:function(t,e,i,s,n){var a,r,o=this,l=!1;__.isString(e)?(e=this._("<div/>").html(e),l=!0):(e=this._(e),a=ext.checkTableContent.call(this,e),e=a.container,r=a.level),e.find("[this-reset]").each(function(){var t=o._(this);t.replaceWith(o.getCached(this))});var h=t;i&&(h={index:i,model:t}),e=ext.inLoop.call(this,h,!0,e.outerHtml(),!0),ext.loop.call(this,e,t);var c=ext.processExpressions.call(this,e.outerHtml(),h,t),d=ext.parseBrackets.call(this,"{{","}}",__.isString(c)?c:c.outerHtml());c=ext.fillVariables.call(this,d,t,c),e.replaceWith(c);var u=function(){for(l&&(e=e.children()),e.find("[this-muted]").removeThis("muted");r;)e=e.children(),r--;ext.renderSrc.call(this,e),__.callable(n).call(this,e)}.bind(this);if(s){var p=e.find('collection:not([this-loaded]):not([this-data]):not([this-loading]):not([this-ignore]),[this-type="collection"]:not([this-loaded]):not([this-data]):not([this-loading]):not([this-ignore])');if(p.length)return this.__proto__.modelCollections=p.length,void p.each(function(){var e=o._(this);t=ext.getVariableValue.call(o,e["this"]("data"),t,!0),ext.loadCollection.call(o,e,function(){e.removeThis("loading")["this"]("loaded",""),--this.__proto__.modelCollections||(delete this.__proto__.modelCollections,u())},t)})}return u(),this},postLoad:function(t,e){t=this._(t);var i=this;ext.renderSrc.call(this,t),t.find("[this-inline-code]").each(function(){var t=i._(this);t.replaceWith(i._("<code this-code />").html(t.html()))}),t.find("[this-block-code]").each(function(){var t=i._(this);t.replaceWith(i._("<pre />").html(t.html())).innerWrap("<code this-code />")}),t.find("[this-code]").each(function(){var t=i._(this),e=ext.parseBrackets.call(i,"<",">",t.html()),s=t.html();__.forEach(e,function(t,e){s=s.replace(e,"&lt;"+e.substr(1,e.length-2)+"&gt;")}),s=s.replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;"),t.html(s).removeThis("code")}),t.find('[this-hidden],[this-type="list"]').hide().removeThis("hidden");var s=ext.removeComments.call(this,t.html());t.html(s),updateLinkHrefs.call(this,t),e||(ext.loop.call(this,t,{}),t.find("[this-repeat-for]").remove(),this.pageIsLoaded||ext.config.call(this).cacheData!==!1||this.clearPageCache())},prepareDOMCache:function(){this._('[this-type="templates"][this-app="'+this.container["this"]("id")+'"]').length||this._("body").append('<div this-type="templates" this-app="'+this.container["this"]("id")+'" style="display:none"/>');var t="";this.container.children("[this-type]")["this"]("in-container","").each(function(){t&&(t+=","),t+=elemToSelector(this,{ignore:["tag"],attrs:["this-id","this-type","this-model"]})});for(var e=this.container.find("[this-default-page]").closest('layout,[this-type="layout"]');e.length&&!e.hasThis("in-container");){var i=e.clone();i.find("[this-content]").html(""),this.templates.append(i["this"]("in-container","")),t&&(t+=","),t+=elemToSelector(e,{ignore:["tag"],attrs:["this-id","this-type"]}),e=e.closest('layout,[this-type="layout"]')}var s=ext.store.call(this,"___cache").find(ext.getTemplatePath.call(this));s?(s=this._("<div>").html(s),t&&s.find(t).remove(),this.templates=this._('[this-type="templates"][this-app="'+this.container["this"]("id")+'"]').html(s.children())):this.templates=this._('[this-type="templates"][this-app="'+this.container["this"]("id")+'"]').append(this.container.find('page:not([this-default-page]),model:not([this-loaded]),collection:not([this-loaded]),layout:not([this-loaded]),list:not([this-loaded]),component:not([this-loaded]),[this-type="page"]:not([this-default-page]),[this-type="model"]:not([this-loaded]),[this-type="collection"]:not([this-loaded]),[this-type="layout"]:not([this-loaded]),[this-type="list"]:not([this-loaded]),[this-type="component"]:not([this-loaded]),[this-paginate-next],[this-paginate-previous][this-repeat-for]').hide()),this.addToCache(this.container.find('page,[this-type="page"],layout,[this-type="layout"]').removeThis("loaded").removeThis("default-page")["this"]("in-container","")),this.container.find('[this-type="templates"]').remove()},processExpressions:function(content,current,model,removeUnresolved){var app=this,exps=ext.getExpressions.call(this,content);return __.forEach(exps,function(i,v){v=v.trim(),app.tryCatch(function(){content=content.replace(v,eval(v.substr(2,v.length-4)))},function(t){ext.log.call(app,"error",t.message),removeUnresolved&&(content=content.replace(v,""))})}),content},processLink:function(t){var e=analyzeLink(t),i=e.page,s=e.url?e.url.split("/"):null;return e.model&&(this.tar["page#"+i]={model:e.model,url:e.url},e.url&&(this.tar["page#"+i].url=e.url,this.tar["page#"+i].mid=s[s.length-1]),"read"===e.action?this.tar["page#"+i].reading="":this.tar["page#"+i]["do"]=e.action),i},record:function(t,e){if(t&&void 0!==e&&this.container)return ext.records[this.container["this"]("id")][t]=e,this;var i=this.container?ext.records[this.container["this"]("id")]:{};return t?i[t]:i},regEsc:function(t){return t.replace(/[-[\]{}()*+?.,\\/^$|#\s]/g,"\\$&")},removeComments:function(t){var e=ext.getComments.call(this,t);return __.forEach(e,function(e,i){t=t.replace(i,"")}),t},renderSrc:function(t){var e=this;this._(t).find("img[this-src]").each(function(){var t=e._(this);-1===t.attr("this-src").indexOf("{{")&&t.attr("src",t.attr("this-src")).removeAttr("this-src")})},request:function(t,e,i,s){
if(t=this._(t),!t.hasThis("default-transport")&&this.dataTransport)return __.callable(this.dataTransport).call(this,__.callable(e).call(this));var n=__.callable(i).call(this);if(!n.url)return __.callable(s).call(this);var a=__.callable(n.success),r=__.callable(n.error);delete n.success,delete n.error,this.request(n).then(a)["catch"](r)},resetForm:function(t){var e=this;return this._(t).find('input:not([type="button"]):not([type="submit"]):not([type="reset"]):not([type="hidden"]),textarea,select,[this-resettable]').each(function(){var t=e._(this);t["this"]("resettable")&&styleToObj(t["this"]("resettable"),function(e,i){t.attr(e,i)}),"radio"!==this.type&&"checkbox"!==this.type||e._(this).prop("checked",!1).removeAttr("checked"),this.value="","select"===this.tagName.toLowerCase()&&e._(this).children(":nth-child(1)").prop("selected",!0).attr("selected","selected").siblings('[selected="selected"]').prop("selected",!1).removeAttr("selected")}),this},restoreState:function(t){var e=this;this.container.html(t.content),this.page=this.container.find('page[this-id="'+t.id+'"],[this-type="page"][this-id="'+t.id+'"]').removeThis("dead"),ext.config.call(this).titleContainer&&ext.config.call(this).titleContainer.html(t.title),ext.record.call(this).store.save(t.url,"last_page"),this.removedAssets={},this.container.find('[this-type="layout"]').each(function(){ext.loadAssets.call(e,e._(this))}),delete this.pageModel,this.page["this"]("mid")&&new Collection({app:this,name:this.page["this"]("model")}).then(function(t){return t.model(this.page["this"]("mid"))}.bind(this)).then(function(t){this.pageModel=t}.bind(this)),ext.loadAssets.call(this,this.page,function(){ext.pageLoaded.call(this,null,!0)}.bind(this))},saveState:function(t){if(this.page){var e="pushState";(t||this.firstPage)&&(e="replaceState");var i="#/"+this.page["this"]("id");return ext.config.call(this).keepParamsInURL&&Object.keys(this.params).length&&(i+="?"+objToQStr(this.params)),this.__proto__.modelParams&&this.__proto__.modelParams.length&&(i+="/"+crudConnectors[this.pageAction]+"/"+this.__proto__.modelParams.join("/")),history[e]({id:this.page["this"]("id"),title:this.page["this"]("title"),content:this.container.html(),url:i},this.page["this"]("title"),i),ext.record.call(this).store.save(i,"last_page"),this}},secureAPI:function(t){return ext.isRunning.call(this)?void 0:(this.secap=t,this)},selector:function(t,e){t=t.split("#"),e||(e="");var i=t[t.length-1].split("[");return t[t.length-1]=i[0],__.removeArrayIndex(i,0),i.length&&(e+="["+i.join("[")),t.length>1?'[this-type="'+t[0]+'"][this-id="'+t[1]+'"]'+e+","+t[0]+'[this-id="'+t[1]+'"]'+e:'[this-id="'+t[0]+'"]'+e},setup:function(t){return this.tryCatch(function(){var e=this;this.when("page.leave","page",function(){ext.saveState.call(e,!0)}),this._(window).on("beforeunload",function(){ext.saveState.call(e,!0)}),this.config.paths&&__.forEach(this.config.paths,function(t,i){__.isString(i)&&!i.endsWith("/")?e.config.paths[t]+="/":__.isObject(i)&&i.dir&&!i.dir.endsWith("/")&&(e.config.paths[t].dir+="/")}),this.notFound||(this.notFound=function(){if(e.firstPage){var t=ext.record.call(e).store.find("last_page");if(t)ext.record.call(e).store.remove("last_page"),e.loadPage(t);else if(e.config.startWith)this.getCached('[this-id="'+e.config.startWith+'"]',"page").length&&e.loadPage(e.config.startWith);else{var i=e._("[this-default-page]");i.length&&e.loadPage(i["this"]("id"))}}}),this.container=this.config.container?this._('[this-id="'+this.config.container+'"]'):this._("[this-app-container]"),!this.container.length||this.container.is("body")?(this._("body").append("<div this-app-container />"),this.container=this._("[this-app-container]")):this.container["this"]("id")||this.container["this"]("id",__.randomString())["this"]("auto-id",""),ext.records[this.container["this"]("id")]={running:!0,secureAPI:this.secap||function(){},uploader:this.setup||null,config:this.config,store:ext.store.call(this,"___records"),createdStore:ext.store.call(this,"___created"),updatedStore:ext.store.call(this,"___updated"),deletedStore:ext.store.call(this,"___deleted"),expirationStore:ext.store.call(this,"___expiration"),paginationStore:ext.store.call(this,"___pagination")},delete this.secap,delete this.setup,ext.record.call(this,"debug",ext.config.call(this).debug||!1),this.container.find('layout,[this-type="layout"]')["this"]("loaded",""),this.config.startWith||(this.config.startWith=this.container.find("[this-default-page]")["this"]("id")),ext.prepareDOMCache.call(this,t),ext.emptyFeatures.call(this,this.container),this.config.titleContainer&&(this.config.titleContainer=this._(this.config.titleContainer,ext.record.call(this,"debug")));var i;this.container.on("click","a",function(t){_(this).attr("href").startsWith("#")&&t.preventDefault()}).on("click","[this-reload],[this-reload-page],[this-reload-layouts]",function(t){t.preventDefault();var i=e._(this);if(i.hasThis("reload-page"))return void e.reload();if(i.hasThis("reload-layouts"))return void e.reload(!1,!0);if(!i["this"]("reload"))return void e.reload(!0);var s=i["this"]("reload"),n=e.getCached(ext.selector.call(e,s)),a=e.container.find(ext.selector.call(e,s,"[this-loaded]"));return n.length?(i["this"]("attributes")&&styleToObj(i["this"]("attributes"),function(){var t=Array.from(arguments),e=__.removeArrayIndex(t,0);t=t.join(":"),n.attr(e,t)}),a.replaceWith(n.clone()),void ext.loadCollection.call(e,a,null,null,!0)):void e.error("Reload target not found")}).on("click","[this-go-home]",function(t){e.home(),t.stop=!0}).on("click","[this-go-back]",function(t){e.back(t),t.stop=!0}).on("click","[this-go-forward]",function(t){e.forward(t),t.stop=!0}).on("click","[this-goto][this-read]",function(){var t=e._(this),i=t.closest('model,[this-type="model"],[this-model][this-binding]'),s=t["this"]("model-id")||i["this"]("mid"),n=t["this"]("model")||i["this"]("model")||i["this"]("id"),a=t["this"]("read")||i["this"]("url")||"#",r=analyzeLink(t["this"]("goto")).page,o=r.replace(/\/\\/g,"-");e.tar["page#"+o]={reading:"",url:a,model:n},e.tar["page#"+o].mid=s,t["this"]("goto",r+"/#/"+n+"/"+a)}).on("click","[this-goto][this-update]",function(){var t=e._(this),i=t.closest('model,[this-type="model"]'),s=t["this"]("model-id")||i["this"]("mid"),n=t["this"]("model")||i["this"]("id"),a=t["this"]("update")||i["this"]("url")||"#",r=analyzeLink(t["this"]("goto")).page,o=r.replace(/\/\\/g,"-");e.tar["page#"+o]={"do":"update",mid:s,action:a,model:n},t["this"]("model-id-key")?e.tar["page#"+o]["model-id-key"]=t["this"]("model-id-key"):i["this"]("id-key")&&(e.tar["page#"+o]["model-id-key"]=i["this"]("id-key")),t["this"]("goto",t.attr("href"))}).on("click","[this-goto][this-create]",function(){var t=e._(this),i=t["this"]("create")||"#",s=analyzeLink(t["this"]("goto")).page,n=s.replace(/\/\\/g,"-");e.tar["page#"+n]={"do":"create",action:i},t["this"]("model")&&(e.tar["page#"+n].model=t["this"]("model")),t["this"]("model-id-key")&&(e.tar["page#"+n]["model-id-key"]=t["this"]("model-id-key")),t["this"]("goto",t.attr("href"))}).on("click","[this-create][this-form]",function(){var t=e._(this),i='form[this-id="'+t["this"]("form")+'"]',s=e.container.find(i).removeAttr(["this-binding","this-mid","this-id-key","this-url"]),n=e.getCached(i);s.html(n.html()),ext.bindToObject.call(e,s,{},function(e){s.replaceWith(e),s.attr({"this-do":"create","this-action":t["this"]("create"),"this-model":t["this"]("model")||"","this-model-id-key":t["this"]("model-id-key")||"","this-binding":""}).show(),ext.resetForm.call(this,s.get(0)),s.trigger("create.form.cleared")}.bind(e))}).on("click","[this-goto][this-delete]",function(){var t=e._(this),i=t.closest('model,[this-type="model"]'),s=t["this"]("delete")||i["this"]("url")||"#",n=t["this"]("model")||i["this"]("id"),a=i["this"]("id-key"),r=analyzeLink(t["this"]("goto")).page,o=r.replace(/\/\\/g,"-");e.tar["page#"+o]={"do":"delete",action:s,"id-key":a},i&&(e.tar["page#"+o].model=n,t["this"]("goto",r+"/#/"+(i["this"]("mid")||t["this"]("model-id")))),t["this"]("goto",t.attr("href"))}).on("click","[this-goto]:not(form)",function(t){t.preventDefault();var i=e._(this);if(i["this"]("goto")){var s=analyzeLink(i["this"]("goto")).page,n=s.replace(/\/\\/g,"-");e.tar["page#"+n]||(e.tar["page#"+n]={}),i["this"]("page-title")&&(e.tar["page#"+n].title=i["this"]("page-title")),i["this"]("ignore-cache")&&(e.tar["page#"+n]["ignore-cache"]=i["this"]("ignore-cache")),ext.processLink.call(e,i["this"]("goto")),e.loadPage(i["this"]("goto")),t.stop=!0}}).on("click","[this-bind-to]",function(t){t.preventDefault();var i=e._(this),s=i["this"]("bind-to"),n=i.closest('model,[this-type="model"],[this-model]');if(s&&n.length){var a=e.container.find(ext.selector.call(e,s,":not([this-in-collection])"));if(a.length){a["this"]("model",n["this"]("model")||n["this"]("id"))["this"]("binding","")["this"]("id-key",n["this"]("id-key")||"")["this"]("url",n["this"]("url")||"").removeThis("action");var r=n["this"]("url")?"url:"+n["this"]("url"):"";i.hasThis("read")?(i["this"]("read")&&(r="url:"+i["this"]("read")),e.container.find('[this-model="'+(n["this"]("model")||n["this"]("id"))+'"][this-binding]').hide(),a.removeThis("do")):i.hasThis("update")?(i["this"]("update")&&(r="url:"+i["this"]("update")),r+=";do:update"):i.hasThis("delete")&&(i["this"]("delete")&&(r="url:"+i["this"]("delete")),r+=";do:delete",i["this"]("treated",""),setTimeout(function(){i.removeThis("treated")})),a["this"]("tar",r),ext.bindToElementModel.call(e,a,n,i["this"]("bind"))}}}).on("click","[this-delete]",function(t){t.preventDefault();var i=e._(this);if(!i.hasThis("treated")){var s,n=i.closest('model,[this-type="model"],[this-model]'),a=i.closest('[this-do="delete"]'),r=i["this"]("delete")||n["this"]("url")||a["this"]("action"),o=n["this"]("mid")||a["this"]("mid");ext.canContinue.call(e,"model.delete",[],n.get(0))&&new Collection({app:e,name:i["this"]("model")||n["this"]("model")||n["this"]("id")||a["this"]("model"),idKey:n["this"]("id-key")||a["this"]("id-key")}).then(function(t){return t.model(o,{url:r})}).then(function(t){return s=t,s.remove()}).then(function(t){var i=ext.config.call(e).crud.status;i&&t[i.key]===i.successValue||!i?("delete"===e.page["this"]("do")||"page"===n["this"]("type")?e.back():(e.container.find('[this-model="'+(n["this"]("model")||n["this"]("id"))+'"][this-binding]').hide(),ext.updatePage.call(e,!0)),t=getRealData.call(e,t),n.trigger("delete.success",{response:this,responseData:t,model:s})):n.trigger("delete.failed",{response:this,responseData:t,model:s}),n.trigger("delete.complete",{response:this,model:s})})["catch"](function(t){n.trigger("delete.error",{response:this,responseData:t,model:s}),n.trigger("delete.complete",{response:this,model:s})})}}).on("click","[this-toggle]",function(t){t.preventDefault(),e.container.find(ext.selector.call(e,e._(this)["this"]("toggle"))).toggle()}).on("click","[this-hide]",function(t){t.preventDefault(),__.forEach(e._(this)["this"]("hide").split(","),function(t,i){e.container.find('[this-id="'+i.trim()+'"]').hide()})}).on("click","[this-show]",function(t){t.preventDefault();var i=e._(this);__.forEach(i["this"]("show").split(","),function(t,s){var n=e.container.find(ext.selector.call(e,s.trim()));if(i["this"]("create")){var a=n.is('form[this-model="'+i["this"]("model")+'"]')?n:n.find('form[this-model="'+i["this"]("model")+'"]');a.length&&(a["this"]("do","create")["this"]("url",i["this"]("create"))["this"]("binding",""),i["this"]("model-id-key")&&a["this"]("model-id-key",i["this"]("model-id-key")),a.removeThis("mid"),ext.resetForm.call(e,a.get(0)))}n.show()})}).on("keyup","[this-autocomplete][this-list]",function(t){var s=e._(this),n=s.val().trim(),a=s["this"]("min-chars")||3,r=s["this"]("autocomplete")||s["this"]("url"),o=e.container.find('[this-type="list"][this-id="'+s["this"]("list")+'"],list[this-id="'+s["this"]("list")+'"]');if(!o.length)return void e.error("List #"+s["this"]("list")+" not found");if(n.length<a){var o=e.container.find('[this-type="list"][this-id="'+s["this"]("list")+'"],list[this-id="'+s["this"]("list")+'"]');return o.hide(),o.children().length&&o.html("").trigger("list.emptied"),s.removeThis("last-query"),ext.record.call(e).store.remove("autocompleting"),void clearTimeout(i)}return n===s["this"]("last-query")?void(13===t.keyCode&&o.children().length&&(o.children(":first-child").trigger("click"),t.preventDefault(),t.stopPropagation())):(clearTimeout(i),void(i=setTimeout(function(){s["this"]("last-query",n);var t;try{t=ext.config.call(e).crud.methods.read}catch(i){t="get"}var a=function(t){t=getRealData.call(e,t),t&&(s["this"]("id")||s["this"]("id",__.randomString()),o["this"]("autocompleting",s["this"]("id")).html("").trigger("list.emptied"),ext.fillAutocompleteList.call(e,{list:o,filter:o["this"]("filter"),data:t,dropdownList:o,ignoreIds:!0}),ext.record.call(e).store.save(t,"autocompleting"))},l={type:t,url:r,success:a,data:{}};l.data[s["this"]("query-key")||"q"]=n,ext.request.call(e,s,function(){return l},function(){return l})},s["this"]("delay")||300)))}).on("click","[this-autocompleting]>*",function(){var t=e._(this),i=t["this"]("id"),s=t["this"]("index"),n=t.parent(),a=e.container.find('[this-autocomplete][this-id="'+n["this"]("autocompleting")+'"]'),r=n["this"]("selection-list"),o=a["this"]("value-key"),l=ext.record.call(e).store.find("autocompleting")||{},h=l[s]||{};if(!r)return void(o&&(a.val(ext.getVariableValue.call(e,o,h)),n.html("").trigger("list.emptied"),ext.record.call(e).store.remove("autocompleting")));var c='[this-type="list"][this-id="'+r+'"],list[this-id="'+r+'"]',d=e.container.find(c),u=e.getCached(c).children();n["this"]("selected")||d.html(""),ext.bindToObject.call(e,u,h,function(e){e["this"]("type","listing")["this"]("id",i).show(),n["this"]("selected",(n["this"]("selected")||"")+i+","),d.append(e).show(),t.trigger("list.option.selected",{data:h,option:e.get(0),autocompleteInput:a.get(0)}),a.hasThis("multiple")?(t.remove(),n.children().length||n.trigger("list.emptied")):(a.hide(),n.hide())})}).on("click",'list [this-remove],[this-type="list"] [this-remove]',function(){var t=e._(this).closest('[this-type="listing"]'),i=t.parent(),s=e.container.find('[this-type="list"][this-selection-list="'+i["this"]("id")+'"],list[this-selection-list="'+i["this"]("id")+'"]');s["this"]("selected",s["this"]("selected").replace(t["this"]("id")+",","")).show();var n=e.container.find('[this-autocomplete][this-id="'+s["this"]("autocompleting")+'"]').show();t.trigger("list.option.removed",{option:t.get(0)}).remove(),i.children().length||i.trigger("list.emptied"),n.hasThis("multiple")&&n["this"]("last-query","").trigger("keyup")}).on("submit",'form[this-do="create"]:not([this-ignore-submit]), form[this-do="update"]:not([this-ignore-submit])',function(t){t.preventDefault();var i=e._(this),s="create"===i["this"]("do"),n=i["this"]("method")||(s?"post":"put");if(!this.reportValidity())return void i.trigger("form.invalid.submission");i.trigger("form.valid.submission");var a,r=null;i["this"]("mid")&&(r=i["this"]("mid")),new Collection({app:e,name:i["this"]("model")||i["this"]("id")||e.page["this"]("model")}).then(function(t){return t.model(r)}).then(function(t){return a=t,t.save({form:i.get(0),url:i["this"]("url")||i["this"]("action")||e.page["this"]("url")||e.page["this"]("action"),ignoreDOM:i.hasThis("ignore-dom"),method:n})}).then(function(t){var r=getRealData.call(e,t),o=ext.config.call(e).crud.status;(o&&t[o.key]===o.successValue||!o)&&r?(s&&(ext.resetForm.call(e,i.get(0)),i.hasThis("binding")||i.closest("[this-binding]").length?i.hasThis("binding")&&(i.hide(),ext.updatePage.call(e,!0)):e.back()),i.trigger("form.submission.success",{responseObject:this,responseData:t,method:n.toUpperCase(),create:s,model:a})):i.trigger("form.submission.failed",{response:this,responseData:t,method:n.toUpperCase(),create:s,model:a}),i.trigger("form.submission.complete",{response:this,method:n.toUpperCase(),create:s,model:a})})["catch"](function(t){i.trigger("form.submission.error",{response:this,responseData:t,method:n.toUpperCase(),create:s,model:a}),i.trigger("form.submission.complete",{response:this,method:n.toUpperCase(),create:s,model:a})})}).on("submit","form[this-handle-submit]:not([this-do])",function(t){t.preventDefault();var i=e._(this);if(!this.reportValidity())return void i.trigger("form.invalid.submission");i.trigger("form.valid.submission");var s=new Form(this),n={},a=ext.canContinue.call(e,"form.send",[n],this);if(a){__.isObject(a)&&s.fromObject(a);var r=function(t){i.trigger("form.submission.success",{response:this,responseData:t}),i.trigger("form.submission.complete",{response:this})},o=function(t){i.trigger("form.submission.error",{response:this,responseData:t}),i.trigger("form.submission.complete",{response:this})};ext.request.call(e,i,function(){return{type:i.attr("method"),url:i.attr("action"),data:s,success:r,error:o,headers:n,form:i.get(0)}},function(){return{url:i.attr("action"),type:i.attr("method"),dataType:i["this"]("response-type"),data:s,success:r,error:o,headers:n}})}}).on("submit",'form[this-do="search"]',function(t){t.preventDefault();var i=e._(this),s=i.find("[this-search]");if(!s["this"]("search"))return void e.error("Invalid search target");var n,a=s["this"]("search").split(":"),r='collection[this-id="'+a[0]+'"],[this-type="collection"][this-id="'+a[0]+'"]',o=a[1],l="page"===i["this"]("type")?i:i.closest('page,[this-type="page"]'),h=i.attr("goto")||l["this"]("id"),c="",d=e.page["this"]("id")===h&&e.page["this"]("query")===s.val().trim();if(o&&(o=o.split(",")),__.forEach(o,function(t,e){c&&(c+=" || "),c+="__.contains(filters.lcase(model#"+e+'),filters.lcase("'+s.val()+'"))'}),i["this"]("reload"))n=l.find(ext.selector.call(e,i["this"]("reload"))),n["this"]("filter",c)["this"]("search",o.join(",")),l["this"]("query",s.val().trim()),ext.loadCollection.call(e,n,null,null,d);else{var u=analyzeLink(h).page,p=u.replace(/\/\\/g,"-"),f=e.getCached('[this-id="'+u+'"]',"page"),g=f.find('[this-component="'+a[0]+'"]');g["this"]("filter","collection#"+a[0]+":"+c)["this"]("search","collection#"+a[0]+":"+o.join(",")),e.tar["page#"+p]={query:s.val().trim()},s["this"]("ignore-cache")&&(e.tar["page#"+p]["ignore-cache"]=s["this"]("ignore-cache")),n=f.find(r),n["this"]("filter",c)["this"]("search",o.join(",")),e.loadPage(h,d)}}).on("click","[this-paginate-next]",function(t){t.preventDefault();var i,s=e._(this);i=s["this"]("paginate-next")?e.container.find('collection[this-id="'+s["this"]("paginate-next")+'"],[this-type="collection"][this-id="'+s["this"]("paginate-next")+'"]'):s.siblings('collection,[this-type="collection"]'),i.hasThis("paginate")&&(s.attr("disabled","disabled"),e.load(i))}).on("click","[this-paginate-previous]",function(t){t.preventDefault();var i,s=e._(this);i=s["this"]("paginate-previous")?e.container.find('collection[this-id="'+s["this"]("paginate-previous")+'"],[this-type="collection"][this-id="'+s["this"]("paginate-previous")+'"]'):s.siblings('collection,[this-type="collection"]'),0!=i["this"]("pagination-page")&&i.hasThis("paginate")&&(s.attr("disabled","disabled"),i["this"]("pagination-page",parseInt(i["this"]("pagination-page"))-2),e.load(i))}).on("click","[this-clear-page-cache]",function(){e.clearPageCache("true"===e._(this)["this"]("clear-page-cache"))}),this.when("page.loaded","page",function(){e.page.hasThis("restored")||(document.scrollingElement.scrollTop=0)}).when("component.loaded","component",function(){var t=e._(this);e.pageIsLoaded&&t.find("[this-type]:not([this-loaded])").each(function(t,e){this.load(e)}.bind(e))}).when("list.emptied, list.no.data","list",function(){_(this).hide()}),this._(window).on("popstate",function(t){t.state&&(this.page&&this.page.trigger("page.leave"),location.replace(t.state.url),ext.pageIDFromLink.call(this,t.state.url,!0),this.__proto__.modelParams=this._params,delete this._params,ext.restoreState.call(this,t.state))}.bind(this)),__.forEach(this.events,function(){e.container.on(this.event,this.selector,this.callback)}),delete this.__proto__.events}),this},setUploader:function(t){return ext.isRunning.call(this)?void 0:(this.setup=t,this)},showPage:function(t){var e,i=__.callable(ext.config.call(this).transition,!0);i?e=i.call(null,this.oldPage.removeThis("current"),this.page,ext.config.call(this).transitionOptions):__.isString(ext.config.call(this).transition)&&(Transitions[ext.config.call(this).transition]||(ext.config.call(this).transition="switch"),this.oldPage=this._(this.oldPage),e=Transitions[ext.config.call(this).transition](this.oldPage.removeThis("current"),this.page,ext.config.call(this).transitionOptions)),setTimeout(function(){this.oldPage&&this.oldPage.remove(),delete this.oldPage}.bind(this),__.isNumeric(e)?e:0),ext.config.call(this).titleContainer&&ext.config.call(this).titleContainer.html(this.page["this"]("title")),ext.emptyFeatures.call(this,this.container);var s=ext.inLoop.call(this,{},!0,this.container.html());s=ext.processExpressions.call(this,s,{},{}),this.container.html(s),this.page=this.container.find('page[this-id="'+this.page["this"]("id")+'"]:not([this-dead]),[this-type="page"][this-id="'+this.page["this"]("id")+'"]:not([this-dead])'),ext.loadModels.call(this,t,!0)},showNotWiths:function(t,e){__.forEach(e,function(e,i){t.find('[this-with="'+e+'"]').replaceWith(i)})},store:function(t){return this.container.hasThis("auto-id")||(t=this.container["this"]("id")+"."+t),t?new Store(t):Store},updatePage:function(){var t=this,e=ext.record.call(this).deletedStore.find()||{},i=ext.record.call(this).createdStore.find()||{},s=ext.record.call(this).updatedStore.find()||{},n=this.container.find('collection,[this-type="collection"]'),a=this.container.find('model,[this-type="model"],page[this-model],[this-type="page"][this-model]'),r={deleted:!1,created:!1,updated:!1,back:!1,cancel:!1};return n.length&&__.forEach(i,function(e,s){var n=t.container.find('collection[this-model="'+e+'"],[this-type="collection"][this-model="'+e+'"]');if(n.length){n.children(':not([this-id="'+n["this"]("model")+'"])').remove(),r.created=!0;var a=ext.store.call(t,e);a.idKey||"";__.forEach(s,function(e,i){var r=t.getCached('[this-id="'+n["this"]("id")+'"]',"collection"),o=n["this"]("prepend-new")?"prepend":"append",l=a.find(i),h=n["this"]("id-key")||ext.config.call(t).idKey||"id",c={},d=h.split(".").reverse(),u=l,p=d.pop();$.each(d,function(t,e){t?u[e]=u:u[e]=id||index}),c[p]=u,ext.loadCollection.call(t,r,function(){__.removeArrayIndex(s,e),n[o](r.children().show()),ext.postLoad.call(t,r.children())},c)}),i[e].length?ext.record.call(t).createdStore.save(s,e,!0):(ext.record.call(t).createdStore.remove(e),ext.config.call(t).cacheData||ext.store.call(t,e).drop())}}),a.length&&(__.forEach(s,function(e,i){var n=t.container.find('model[this-id="'+e+'"],[this-type="model"][this-id="'+e+'"],collection[this-model="'+e+'"]>model,[this-type="collection"][this-model="'+e+'"]>[this-type="model"],page[this-model="'+e+'"],[this-type="page"][this-model="'+e+'"]'),a=!1;n.length&&(r.updated=!0,__.forEach(i,function(s,r){t.pageModel&&t.pageModel.name===e&&t.pageModel.id===s&&(t.pageModel.__proto__.attributes=__.extend(t.pageModel.attributes,r.data)),n.filter(function(){var e=t._(this);return e["this"]("mid")==s&&(!e.hasThis("updated")||e.hasThis("updated")&&parseInt(e["this"]("updated"))<r.timestamp)}).each(function(){var e,n=t._(this);if(n.hasThis("in-collection")){a=!0;var o=n.parent();e=t.getCached('[this-id="'+o["this"]("id")+'"]',"collection");var l=o["this"]("id-key")||ext.config.call(t).idKey||"id",h={},c=l.split(".").reverse(),d=r.data,u=c.pop();$.each(c,function(t,e){t?d[e]=d:d[e]=s||index}),h[u]=d,ext.loadCollection.call(t,e,function(){delete i[s],n.html(e.children().html()).show()["this"]("updated",r.timestamp)["this"]("url",e.children()["this"]("url")),ext.postLoad.call(t,n)},h)}else e=t.getCached('[this-id="'+n["this"]("id")+'"]',getElemType(n)),ext.loadModel.call(t,e,function(){n.html(e.html()).show()["this"]("updated",r.timestamp)["this"]("url",e["this"]("url")),ext.postLoad.call(t,n)},r.data)})}),Object.keys(s[e]).length?ext.record.call(t).updatedStore.save(i,e,!0):ext.record.call(t).updatedStore.remove(e))}),__.forEach(e,function(i,s){__.forEach(s,function(e,n){var o=t.container.find('[this-id="'+i+'"][this-mid="'+n+'"],[this-model="'+i+'"][this-mid="'+n+'"]');o.length&&(r.deleted=!0,o.each(function(){var i=t._(this),n=i.parent();if(i.hasThis("in-collection"))i.siblings().length||n.html(t.getCached('[this-id="'+n["this"]("id")+'"]',"collection").children("[this-on-emptied]").removeThis("on-emptied").removeThis("on-empty")),i.remove(),__.removeArrayIndex(s,e);else{if(i.hide(),!i.hasThis("binding")&&t.page["this"]("reading")&&1===a.length)return r.back=!0,!1;i.removeThis("url").removeThis("mid")}}))}),e[i].length?ext.record.call(t).deletedStore.save(s,i,!0):ext.record.call(t).deletedStore.remove(i)})),(r.created||r.updated||r.deleted)&&(ext.saveState.call(this,!0),this.container.trigger("dom.updated")),r.back?this.back():void 0},watch:function(t){if(t=this._(t),!t["this"]("id")||this.watching[t["this"]("id")]||!t["this"]("url"))return this;var e=ext.is.call(this,"collection",t),i=t["this"]("model")||t["this"]("id");return this.watching[t["this"]("id")]={type:e?"collection":"model",url:t["this"]("url"),mid:t["this"]("mid")},__.callable(this.watchCallback)(t["this"]("url"),function(s){switch(s.event){case"created":ext.modelToStore.call(this,{modelName:i,modelId:s.id,model:s.data,isNew:!0});break;case"updated":var n=s.data,a=s.id;if(!e&&t["this"]("mid")){var a=ext.getUIDValue.call(this,n,t["this"]("id-key"));delete n[a];var r={};r[a]=n,n=r,a=t["this"]("mid")}n=ext.modelToStore.call(this,{modelName:i,modelId:a,model:n,isNew:!1});break;case"deleted":var o=ext[s.event+"Store"],l=o.find(i)||[];ext.store.call(this,i).remove(s.id),__.removeArrayValue(l,s.id,!0),l.push(s.id),o(l,i),ext.updatePage.call(this)}}.bind(this)),this}},Filters=Object.create({__factory:function(t,e,i,s){if(__.isArray(t)){var n=[];return __.forEach(t,function(t,a){n.push(Filters.__factory(a,e,i,s))}),n}return __.isArray(t)?void 0:(e=e?this.__opts(e):null,__.tryCatch(function(){return __.callable(i).call(this,t,e)}.bind(this),function(){return __.callable(s).call(this,t,e)}.bind(this)))},__opts:function(t){t=t.replace(/\\;/g,"__fsemicolon__").replace(/\\:/g,"__fcolon__").split(";");var e;return __.forEach(t,function(t,i){if(-1!==i.indexOf(":")){if(e||(e={}),__.isArray(e)){var s={};e.forEach(function(t,e){s[e]=t}),e=s}var n=i.split(":");e[n[0].replace(/__fsemicolon__/g,";").replace(/__fcolon__/g,":")]=n[1].replace(/__fsemicolon__/g,";").replace(/__colon__/g,":")}else e||(e=[]),i=i.replace(/__fsemicolon__/g,";").replace(/__colon__/g,":"),__.isArray(e)?e.push(i):e[t]=i}),e},camelToHyphen:function(t){return this.__factory(t,null,function(t){if(!t||!__.isString(t))return t;var e=t.replace(/([A-Z])/g,function(t){return"-"+t.toLowerCase()});return this.lcfirst(e)})},camelToSnake:function(t){return this.__factory(t,null,function(t){if(!t||!__.isString(t))return t;var e=t.replace(/([A-Z])/g,function(t){return"_"+t.toLowerCase()});return this.lcfirst(e)})},capitalize:function(t,e){return this.ucwords(t,e)},date:function(t,e){if(!t)return t;var i=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],s=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],a=["January","February","March","April","May","June","July","August","September","October","November","December"],r=new Date(t);isNaN(r.getTime())&&(r=new Date(parseInt(t)));var o=r.getDate(),l=r.getDay()+1,h=r.getMonth()+1,c=r.getFullYear(),d=r.getHours(),u=d%12,p=r.getMinutes(),f=r.getSeconds(),g=r.getMilliseconds(),m=r.getTimezoneOffset()?r.getTimezoneOffset():0,_="GMT";m&&(m=-1*m/60,_+=m>0?"+"+m:"-"+m);var v="DDDD:"+s[l-1].toUpperCase()+";dddd:"+s[l-1].toLowerCase()+";Dddd:"+s[l-1]+";DDD:"+i[l-1].toUpperCase()+";ddd:"+i[l-1].toLowerCase()+";Ddd:"+i[l-1]+";DD:"+(10>l?"0"+l:l)+";dd:"+(10>o?"0"+o:o)+";D:"+l+";d:"+o+";MMMM:"+a[h-1].toUpperCase()+";Mmmm:"+a[h-1]+";mmmm:"+a[h-1].toLowerCase()+";MMM:"+n[h-1].toUpperCase()+";Mmm:"+n[h-1]+";mmm:"+n[h-1].toLowerCase()+";MM:"+(10>h?"0"+h:h)+";mm:"+(10>p?"0"+p:p)+";mer:"+(0>d-12?"am":"pm")+";MER:"+(0>d-12?"AM":"PM")+";ms:"+g+";M:"+h+";m:"+p+";YYYY:"+c+";yyyy:"+c+";YY:"+c%1e3+";yy:"+c%1e3+";HH:"+(10>d?"0"+d:d)+";H:"+d+";hh:"+(10>u?"0"+u:u)+";h:"+u+";ss:"+(10>f?"0"+f:f)+";s:"+f+";TZ:"+_+";tz:"+_.toLowerCase()+";t:"+r.getTime();return this.replace(e,v)},filter:function(t,e){var i=__.callable(e,!0);if(i){if(__.isArray(t))return t.filter(i);var s={};return __.forEach(t,function(t,e){!0===i.call(null,e,t)&&(s[t]=e)}),s}return t},join:function(t,e){return __.isArray(t)?t.join(e):t},lcase:function(t){return this.lowercase(t)},lcfirst:function(t){return this.__factory(t,null,function(t){return t&&__.isString(t)?t[0].toLowerCase()+t.substr(1):t})},length:function(t){return __.isObject(t,!0)?Object.keys(t).length:__.isString(t)?t.length:0},lowercase:function(t){return this.__factory(t,null,function(t){return t&&__.isString(t)?t.toLowerCase():t})},nl2br:function(t){return this.__factory(t,null,function(t){return t&&__.isString(t)?(t+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br />$2"):t})},or:function(t,e){return t||0===t?t:e},replace:function(str,options){return this.__factory(str,options,function(str,options){return str=str.replace(/_/g,"-u-"),forEach(options,function(search,replace){search=search.replace(/_/g,"-u-"),str=str.replace(new RegExp(eval(search),"g"),replace)}),str.replace(/-u-/g,"_")},function(t,e){return t&&__.isString(t)?(__.forEach(e,function(e,i){t=t.replace(new RegExp(e,"g"),i)}),t):t})},smallize:function(t){return this.lcfirst(t)},snakeToCamel:function(t,e){return this.__factory(t,null,function(t){if(!t||!__.isString(t))return t;var i=t.replace(/(\_\w)/g,function(t){return t&&__.isString(t)?t[1].toUpperCase():t});return e?this.ucfirst(i):i})},split:function(t,e){return this.__factory(t,null,function(t){return t&&__.isString(t)?t.split(e):t})},trim:function(t){return this.__factory(t,null,function(t){return t&&__.isString(t)?t.trim():t})},ucase:function(t){return this.uppercase(t)},ucfirst:function(t){return this.__factory(t,null,function(t){return t&&__.isString(t)?t[0].toUpperCase()+t.substr(1):t})},ucwords:function(t){return this.__factory(t,null,function(t){return t&&__.isString(t)?t.replace(/[^\s]+/g,function(t){return t&&__.isString(t)?t.replace(/^./,function(t){return t&&__.isString(t)?t.toUpperCase():t}):t}):t})},uppercase:function(t){return this.__factory(t,null,function(t){return t&&__.isString(t)?t.toUpperCase():t})}}),Transitions=Object.create({"switch":function(t,e){return e.show(),0}}),Model=function(t,e,i){var s=Object.create({app:i&&i.app?i.app:null,attributes:__.isObject(e)?e:{},id:t,collection:i&&i.collection?i.collection:null,method:i&&i.method?i.method:null,name:i&&i.name?i.name:null,idKey:i&&i.idKey?i.idKey:"",url:i&&i.url?i.url:null,bind:function(t){if(t=this.app._(t),!t.length)return this.app.error("Target element not found!"),Promise.reject("Target element not found!");this.id&&t["this"]("mid",this.id),this.idKey&&t["this"]("id-key",this.idKey),this.url&&t["this"]("url",this.url);var e=getElemType(t),i=this.app.getCached('[this-id="'+t["this"]("id")+'"]',e);return i.length&&t.html(i.html()),this.app.promise(function(e){ext.loadModel.call(this.app,t,function(){t.show();var i={"this-type":"model","this-id-key":this.idKey,"this-mid":this.id,"this-url":this.url,"this-model":this.name};if(!t.is("form")){t.attr(i);var s=t.find("form");s.length&&(t=s)}t.is("form")&&(delete i["this-type"],delete i["this-id"],t.attr(i)),e()}.bind(this),this.attributes)}.bind(this))},has:function(t){return this.attributes&&void 0!==this.attributes[t]},init:function(t){var e=Filters.snakeToCamel(t,!0);this["get"+e]=function(e){var i=this.attributes[t];if(__.isObject(i,!0)&&void 0!==e){if(__.isFunction(e)){var s=null;return __.forEach(i,function(t,i){var n=e.apply(this,arguments);return n?(s=i,
!1):void 0}),s}return i[e]||null}return i},this["set"+e]=function(e){return this.attributes[t]=e,this}},remove:function(t){return this.app.promise(function(e,i){t=__.extend({},t);var s=this;if(!this.app)return console.error("Invalid model object"),i("Invalid model object");if(!this.id)return s.app.error("Cannot delete a model without an id."),i("Cannot delete a model without an id.");var n=function(){if(this.attributes.__page){var t=ext.store.call(this.app,this.name),e=ext.record.call(this.app).paginationStore.find(this.name);if(e){for(var i=parseInt(this.attributes.__page),s=!1,n=!1,a='collection[this-model="'+this.name+'"],[this-type="collection"][this-model="'+this.name+'"]',r=this.app.container.find(a),o=this.app.getCached(a).children()["this"]("type","model");e[i];){if(s){if(i>0){var l=e[i].shift();if(!n){var h=t.find(l);!r.children('[this-mid="'+l+'"]').length&&h&&(ext.bindToObject.call(this.app,o,h,function(t){t.attr({"this-id":this.name,"this-in-collection":"","this-type":"model","this-url":this.url.replace(this.id,l),"this-mid":l,"this-id-key":this.idKey}).show(),r.append(t)}.bind(this)),n=!0)}e[i-1].push(l)}}else __.removeArrayValue(e[i],this.id),s=!0;i++}e[i-1].length||delete e[i-1],ext.record.call(this.app).paginationStore.save(e,this.name,!0),r.children().length||this.app.load(r["this"]("pagination-page",parseInt(r["this"]("pagination-page"))-1))}}}.bind(this);if(t.cacheOnly)ext.store.call(this.app,this.name).remove(this.id),n();else{if(!this.url&&!t.url)return this.app.error("Cannot remove model from server: No URL supplied."),i("Cannot remove model from server: No URL supplied.");var a=function(i){var a=ext.config.call(app).crud.status;if(a&&i[a.key]===a.successValue||!a){if(!s.app.watchCallback){ext.store.call(s.app,s.name).remove(s.id);var r=ext.record.call(s.app).deletedStore.find(s.name)||[];s.app.__.removeArrayValue(r,s.id,!0),r.push(s.id),ext.record.call(s.app).deletedStore.save(r,s.name,!0),ext.updatePage.call(s.app),n()}s.collection&&(delete s.collection.models[s.id],s.collection.length--)}__.callable(t.success).call(this,i),e(i)},r=function(e){__.callable(t.error).call(this,e),i(e)};ext.request.call(this.app,null,function(){return{type:t.method||ext.config.call(app).crud.methods["delete"],url:t.url||this.url,id:t.id||this.id,action:"delete",success:a,error:r}}.bind(this),function(){return{type:t.method||ext.config.call(app).crud.methods["delete"],url:t.url||s.url,success:a,error:r}}.bind(this))}}.bind(this))},save:function(t){return this.app.promise(function(e,i){if(!this.app)return console.error("Invalid model object"),i("Invalid model object");if(!this.name)return this.app.error("Cannot save an unnamed model."),i("Cannot save an unnamed model.");t=__.extend({},t);var s=t.data||{},n=ext.canContinue.call(this.app,this.id?"model.update":"model.create",[s],t.form);if(!1===n)return i("Canceled by a before event");if(__.isObject(n)&&(s=n),(!s||__.isObject(s)&&!Object.keys(s).length)&&!t.form)return this.app.error("No data or form to save"),__.callable(t.error).call(this.app),i("No data or form to save");var a=function(t,s,n){var a=this,r=this.id?ext.config.call(app).crud.methods.update:ext.config.call(app).crud.methods.create,o=new Form(t.form);if(o.fromObject(s),this.method&&(r=this.method),this.id&&t.cacheOnly){var l=ext.modelToStore.call(this.app,{modelName:this.name,modelId:this.id,model:o.toObject(),isNew:!this.id,ignoreDom:!!t.ignoreDOM});return e(l)}if(!this.url&&!t.url)return a.app.error("Cannot save model to server: No URL supplied."),i("Cannot save model to server: No URL supplied.");var h=function(i,s){if(i){var n=getRealData.call(a.app,i),r=ext.config.call(app).crud.status;(r&&i[r.key]===r.successValue||!r)&&n&&(a.attributes=n,s=s||ext.getUIDValue.call(a.app,n,a.idKey),a.app.watchCallback||(n=ext.modelToStore.call(a.app,{modelName:a.name,modelId:s,model:n,expireCollection:!a.id&&a.app.container.find('collection[this-model="'+a.name+'"],[this-type="collection"][this-model="'+a.name+'"]').hasThis("paginate"),isNew:!a.id,ignoreDom:!!t.ignoreDOM})),a.collection&&(a.collection.models[s]=n,a.collection.length++)),__.callable(t.success).call(this,i,s)}else __.callable(t.fail).call(this);e(i,s)},c=function(e){__.callable(n).call(this),__.callable(t.error).call(this,e),i(e)};ext.request.call(this.app,t.form,function(){return{url:t.url||this.url,id:this.id,form:t.form,data:o,type:t.method||r,success:h,error:c}}.bind(this),function(){return{type:t.method||r,url:t.url||a.url,data:o,success:h,error:c}})};if(t.form&&ext.record.call(this.app,"uploader")){var r=this.app._(t.form).find('input[type="file"]');if(r.length){s=s||{};return __.callable(ext.record.call(this.app,"uploader")).call(t.form,{modelName:this.name,files:r.items,data:__.extend(s),id:this.id,url:this.url,done:function(e,i){return e===!1?void __.callable(t.error).call(this.app):(__.isObject(e,!0)&&(s=__.extend(s,e)),void a.call(this,t,s,i))}.bind(this)}),this}}a.call(this,t,s)}.bind(this))}});return __.isObject(e)&&__.forEach(e,function(t){t.startsWith("__")||s.init(t)}),s.parent=s.__proto__,delete s.parent.init,s},Collection=function(t){t.name&&!t.ignoreCache&&(__.isObject(t.models,!0)?ext.store.call(t.app,t.name).save(t.models,t.idKey||t.ext.config.call(app).idKey):t.models=ext.store.call(t.app,t.name).find()||[]);var e=Object.create({app:t&&t.app?t.app:null,current_index:-1,models:__.isObject(t.models,!0)?t.models:{},name:t&&t.name?t.name:null,idKey:t&&t.idKey?t.idKey:"",url:t&&t.url?t.url:null,add:function(t){if(!this.name||!this.url)return void this.app.error("Collection must have a name and url");if(!t||!t.data)return void this.app.error("Collection.add() must have an object parameter with key data");var e=new Model(null,t.data,{name:this.name,app:this.app,idKey:this.idKey,url:this.url,collection:this});return e.save(t)},bind:function(t){return this.name?(t=this.app._(t),t["this"]("model",this.name),this.idKey&&t["this"]("model-id-key",this.idKey),this.url&&t["this"]("url",this.url),this.app.promise(function(e){ext.loadCollection.call(this.app,t,e)}.bind(this))):(this.app.error("Collection must have a name"),Promise.reject("Collection must have a name"))},clearCache:function(){return ext.store.call(this.app,this.name).drop(),this},current:function(){return this.get(this.parent.current_index||0)},first:function(){return this.get(0)},each:function(t){return __.forEach(this.models,function(e,i){__.callable(t).call(this,e,i)}),this},get:function(t){var e,i=Object.keys(this.models)[t];if(i)return this.parent.current_index=t,e=this.models[i],e&&delete e.__page,new Model(i,e,{name:this.name,app:this.app,idKey:this.idKey,url:this.url,collection:this})},hasNext:function(){var t=this.parent.current_index,e=this.next();return this.parent.current_index=t,null!==e},last:function(){return this.get(this.length-1)},load:function(t,e){if(t||this.url){var i=this;return this.app.promise(function(s,n){this.request(t||i.url).then(function(a){e=e||{};var r=getRealData.call(this,a,e.dataKey);return __.isObject(r,!0)?(i.name&&ext.store.call(this,i.name).saveMany(r,e.idKey||i.idKey),i.length=Object.keys(r).length,i.__proto__.models=r,i.__proto__.current_index=-1,i.__proto__.url=t||i.url,__.callable(e.success).call(this,i),void s.call(this,i)):(__.callable(e.error).call(this,r),n.call(this,r))}.bind(this))["catch"](function(){__.callable(e.error).call(this,arguments),n.call(this,arguments)})})}},model:function(t,e){var i,s=this,e=__.extend({success:function(){},error:function(){}},e);if(t){e.url?i=e.url:this.url&&(i=(s.url.endsWith("/")?s.url:s.url+"/")+t);var n=e.hasOwnProperty("ignoreCache");if((n&&!e.ignoreCache||!n&&!ext.config.call(app).cacheData==!1)&&this.models[t]){var a=__.extend(this.models[t]),r=new Model(t,a,{name:s.name,app:s.app,idKey:s.idKey,url:i,collection:this});return delete a.__page,__.callable(e.success).call(this,r),Promise.resolve(r)}if(i)return this.app.promise(function(n,a){this.app.request(i).then(function(a){a=getRealData.call(this.app,a),a&&__.isObject(a)&&delete a.__page;var r=new Model(t,a,{name:s.name,app:s.app,idKey:s.idKey,url:i,collection:this});__.callable(e.success).call(this,r),n(r)}.bind(this))["catch"](function(t){__.callable(e.error).call(this,t),a(t)}.bind(this))}.bind(this))}var r=new Model(null,null,{name:this.name,app:this.app,idKey:this.idKey,url:i,collection:this});return __.callable(e.success).call(this.app,r),Promise.resolve(r)},next:function(){return this.get(this.parent.current_index+1)},remove:function(t,e){return this.app.promise(function(i,s){var n,a=__.extend({},e);e.url?n=e.url:this.url&&(n=(_this.url.endsWith("/")?_this.url:_this.url+"/")+t),a.url=n,a.success=function(){delete this.models[t],this.length--,i(),__.callable(e.success).apply(this,arguments)}.bind(this),this.model(t,{url:n}).then(function(t){t.remove(a)}.bind(this))["catch"](s)}.bind(this))},removeAll:function(){return this.url&&this.name?config.cacheOnly?(ext.store.call(this.app,this.name).drop(),ext.record.call(this.app).paginationStore.remove(this.name),ext.record.call(this.app).expirationStore.remove(this.name),this.models={},this.length=0,Promise.resolve()):this.app.promise(function(t,e){var i=this,s=function(e){i.app.watchCallback||ext.store.call(i.name).drop(),i.models={},i.length=0,__.callable(config.success).call(i,e),t(e)},n=function(t){__.callable(config.error).call(i,t),e(t)};ext.request.call(this.app,null,function(){return{url:this.url,type:config.method||ext.config.call(app).crud.methods["delete"],success:s,error:n}}.bind(this),function(){return{url:this.url,type:config.method||ext.config.call(app).crud.methods["delete"],success:s,error:n}}.bind(this))}.bind(this)):(this.app.error("Invalid url and/or model name!"),Promise.reject())},rewind:function(){return this.parent.current_index=-1,this}});return e.length=__.isObject(t.models,!0)?Object.keys(t.models).length:0,e.parent=e.__proto__,!e.length&&t.url?e.load(t.url,t):Promise.resolve(e)},Extender=function(t){return function(){return{extend:function(e,i){return e&&i&&(t[e]=i),this},properties:function(){return{custom:Object.keys(t),initial:Object.keys(t.__proto__)}},run:function(e,i){return __.callable(t[e]).call(t,i)}}}};Filters.parent=Filters.__proto__,Transitions.parent=Transitions.__proto__,_.prototype=__.__proto__,ThisApp=function(t){return this instanceof ThisApp?(this.version="1.0",t&&__.isObject(t)&&(this.config=__.extend(this.config,t,!0)),void(this.error=function(t){return ext.log.call(this,"error",t),this})):new ThisApp(t)},ThisApp.Transitions=Extender(Transitions),ThisApp.Filters=Extender(Filters),ThisApp.extend=function(t){__.forEach(t,function(t,e){ThisApp.prototype[t]?console.error("ThisApp."+t+" already exists!"):ThisApp.prototype[t]=function(){var t=Array.from(arguments);return t.unshift(ext),__.callable(e).apply(this,t)}})},ThisApp.prototype={__:__,beforeCallbacks:{},collections:0,components:0,config:{baseURL:location.origin+location.pathname,cacheData:!0,crud:{status:{key:"status",successValue:!0},methods:{create:"POST",read:"GET",update:"PUT","delete":"DELETE"}},dataKey:"data",debug:!1,keepParamsInURL:!1,layout:null,idKey:"id",pagination:{limit:20,overwrite:!1},paths:{pages:{dir:"./pages",ext:".html"},layouts:{dir:"./layouts",ext:".html"},components:{dir:"./components",ext:".html"},js:"./assets/js",css:"./assets/css"},startWith:null,titleContainer:null,transition:"switch",transitionOptions:{}},events:[],GETParams:{},models:0,params:{},removedAssets:{},tar:{},watching:{},_:function(t,e){return _(t,e||this.config?ext.record.call(this,"debug"):!0)},addToCache:function(t){return ext.isRunning.call(this)?this.tryCatch(function(){var e=this;return this._(t).each(function(){var t=e._(this).clone().removeThis("loaded");"layout"===t["this"]("type")&&t.find("[this-content]").html(""),t.find("style").each(function(){e._(this).replaceWith('<div this-type="style">'+this.innerText+"</div>")}),e.templates.find(elemToSelector(t,{ignore:["tag"],attrs:["this-type","this-id","this-url"]})).remove(),e.templates.append(t.outerHtml())}),this.pageIsLoaded&&ext.store.call(this,"___cache").save(this.templates.html(),ext.getTemplatePath.call(this),!0),this}):(this.error("App not started yet!"),this)},back:function(t){return ext.isRunning.call(this)?this.tryCatch(function(){return t&&__.isObject(t)&&t.preventDefault&&t.preventDefault(),this.canGoBack()?(ext.canContinue.call(this,"page.leave",[],this.page.get(0))&&history.back(),this):this.home(!0)}):(this.error("App not started yet!"),this)},before:function(t,e){return this.tryCatch(function(){return __.forEach(t.split(","),function(t,i){this.page?(this.beforeCallbacks[this.page["this"]("id")]||(this.beforeCallbacks[this.page["this"]("id")]={}),this.beforeCallbacks[this.page["this"]("id")][i.trim()]=e):(this.beforeCallbacks.___common||(this.beforeCallbacks.___common={}),this.beforeCallbacks.___common[i.trim()]=e)}.bind(this)),this})},bindToObject:function(t,e,i){return ext.isRunning.call(this)?this.promise(function(s){ext.bindToObject.call(this,this._(t),e,function(e){t.replaceWith(e),s.apply(this,arguments),__.callable(i).apply(this,arguments)}.bind(this))}):(this.error("App not started yet!"),Promise.reject("App not started yet!"))},canGoBack:function(){return ext.isRunning.call(this)?history.length>2:(this.error("App not started yet!"),this)},clearPageCache:function(t){if(!ext.isRunning.call(this))return this.error("App not started yet!"),this;var e=this,i=!1;return this.container.find('collection,[this-type="collection"],model:not([this-in-collection]),[this-type="model"]:not([this-in-collection])').each(function(){var s=e._(this),n=s["this"]("model")||s["this"]("id");return ext.store.call(e,n).drop(),"page"===s["this"]("type")?void(i=!0):void(t&&!i&&e.load(s))}),i&&t?this.reload():this},collection:function(t,e){return ext.isRunning.call(this)?this.tryCatch(function(){return e=e||{},e.app=this,e.name=t,new Collection(e)}):(__.callable(e.error).call("App not started yet!"),Promise.reject("App not started yet!"))},debug:function(t){return ext.isRunning.call(this)||(this.config.debug=void 0===t?!0:t),this},fillAutocompleteList:function(t,e,i,s){if(!ext.isRunning.call(this))return this.error("App not started yet!"),[];t=__.isString(t)?this.container.find('[this-id="'+t+'"]'):this._(t);var n=t["this"]("autocompleting")?t:this.container.find('list[this-id="'+t["this"]("parent-list")+'"],[this-type="list"][this-id="'+t["this"]("parent-list")+'"]');return ext.fillAutocompleteList.call(this,{list:t,data:e,idKey:i,filter:s,dropdownList:n})},forward:function(t){return ext.isRunning.call(this)?this.tryCatch(function(){return t&&__.isObject(t)&&t.preventDefault&&t.preventDefault(),ext.canContinue.call(this,"page.leave",[],this.page.items[0])?(history.forward(),this):this}):(this.error("App not started yet!"),this)},getCached:function(t,e){return ext.isRunning.call(this)?this.tryCatch(function(){var i=this,s=this._();if(__.isObject(t)){var n=["this-id","this-type","this-model"];t.hasThis("binding")&&"page"!==t["this"]("type")&&__.arrayRemoveIndex(2),t=elemToSelector(t,{attrs:n,ignore:["class"]})}if(e){var a="";__.forEach(t.split(","),function(t,i){a&&(a+=",");var s=i.split(" "),n="";i=s.pop(),s.length&&(n+=s.join(" ")+" "),a+=n+i+'[this-type="'+e+'"],'+n+e+i}),t=a}if(this.page){t||(t='page[this-id="'+this.page["this"]("id")+'"],[this-type="page"][this-id="'+this.page["this"]("id")+'"]');var r="";if(__.forEach(t.split(","),function(t,e){r&&(r+=","),r+='page[this-id="'+i.page["this"]("id")+'"] '+e+',[this-type="page"][this-id="'+i.page["this"]("id")+'"] '+e}),s=this.templates.find(r),s.length||(s=this.templates.children('[this-type="component"]').find(t)),!s.length)for(var o=this.page.closest('layout,[this-type="layout"]');!s.length&&o.length;)s=this.templates.find("layout "+t+',[this-type="layout"] '+t),o=o.closest('layout,[this-type="layout"]')}return!s.length&&(s=this.templates.children(t),s.length||(s=this.template.find("component>"+t+',[this-type="component"]>'+t)),this.firstPage&&ext.config.call(this).debug&&!s.hasThis("in-container"))?this._():(s=s.clone(),"template"===s["this"]("type")&&s.removeThis("type"),s.find('[this-type="style"]').each(function(){i._(this).replaceWith("<style>"+this.innerText+"</style>")}),ext.emptyFeatures.call(i,s),this._(s.outerHtml()))}):(this.error("App not started yet!"),this._())},home:function(t){return ext.isRunning.call(this)?this.tryCatch(function(){return this.loadPage(ext.config.call(this).startWith||this.getCached("[this-default-page]","page")["this"]("id"),t),this}):(this.error("App not started yet!"),this)},load:function(t,e,i){return ext.isRunning.call(this)?this.tryCatch(function(){var s=this;return this._(t).each(function(){var t=getElemType(s._(this)),n="load"+t[0].toUpperCase()+t.substr(1),a=__.inArray(t.toLowerCase(),["component","collection","model"]);ext[n]&&a&&ext[n].call(s,this,i,e)}),this}):(this.error("App not started yet!"),__.callable.call(this,null,"App not started yet!"),this)},loadPage:function(t,e){return ext.isRunning.call(this)?this.tryCatch(function(){var i=ext.record.call(this).store.find("last_page");if(!t||(i===t||i==="#/"+t)&&!this.firstPage)return this;if(this.page&&!ext.canContinue.call(this,"page.leave",[],this.page.items[0]))return this;if(t=ext.pageIDFromLink.call(this,t,!0),!ext.canContinue.call(this,"page.load",[t]))return this;this.oldPage=_();var s=this.getCached('[this-id="'+t+'"]',"page");if(s.length>1)return this.error("Target page matches multiple pages!"),this;if(!s.length){var n=ext.config.call(this).paths;if(n&&n.pages){var a=this;return ext.fullyFromURL.call(this,"page",t,function(t){ext.pageFound.call(a,t,e)},function(){ext.notAPage.call(a,t)}),this}return ext.notAPage.call(this,t),this}return ext.pageFound.call(this,s,e),this}):(this.error("App not started yet!"),this)},on:function(t,e,i){return this.tryCatch(function(){if(ext.isRunning.call(this))if(__.isFunction(e)&&(i=e,e=null),this.page){var s=t.replace(/[^a-z0-9]/gi,""),n=this.page["this"]("id");if(e&&(s+=e.replace(/[^a-z0-9]/gi,"")),!containedEvents[s]){containedEvents[s]={};var a=this;e?this.container.on(t,e,function(){return ext.dispatchEvent.call(a,s,this,Array.from(arguments))}):this.container.on(t,function(){return ext.dispatchEvent.call(a,s,this,Array.from(arguments))})}containedEvents[s][n]||(containedEvents[s][n]=i)}else this.container.on(t,e,i);else this.events.push({event:t,selector:e,callback:i});return this})},onError:function(t){return ext.isRunning.call(this)||(this.error=function(e){__.callable(t,!0).call(this,e)}),this},pageNotFound:function(t){return ext.isRunning.call(this)||(this.notFound=t),this},promise:function(t){return this.tryCatch(function(){return new Promise(function(e,i){__.callable(t).call(this,e,i)}.bind(this))})},reload:function(t){return ext.isRunning.call(this)?this.tryCatch(function(){var e=ext.record.call(this).store.find("last_page");return ext.record.call(this).store.remove("last_page"),this.reloadLayouts=t||!1,this.page.hasThis("reading")&&(this.tar["page#"+this.page["this"]("id")]={reading:"",url:this.page["this"]("url"),model:this.page["this"]("model"),mid:this.page["this"]("mid")}),this.loadPage(e,!0),this}):(this.error("App not started yet!"),this)},replaceCached:function(t,e){return ext.isRunning.call(this)?(this.templates.find(t).replaceWith(this._(e).clone()),this):(this.error("App not started yet!"),this)},request:function(t){return ext.isRunning.call(this)?this.tryCatch(function(){__.isObject(t)||(t={url:t});var e=t.url;return t.api=!1,e?(__.isObject(e)&&(e=e["this"]("url")),e.startsWith("./")||e.startsWith("../")||e.startsWith("//")||-1!==e.indexOf("://")||(e=ext.config.call(this).baseURL+e,t.api=!0),t.type=t.type||"get",t.dataType=t.dataType||"json","get"===t.type.toLowerCase()&&(t.ignoreCache=ext.record.call(this,"debug")),t.url=e,this.promise(function(e,i){var s=t.success,n=t.error;t.success=function(){__.callable(s).apply(this,arguments),e.apply(this,arguments)}.bind(this),t.error=function(){__.callable(n).apply(this,arguments),i.apply(this,arguments)}.bind(this),Ajax(t,this)})):(ext.log.call(this,"error","Method request() expects parameter 1 to be string. "+typeof e+" given"),Promise.reject("Method request() expects parameter 1 to be string. "+typeof e+" given"))}):(this.error("App not started yet!"),Promise.reject("App not started yet!"))},resetAutocomplete:function(t){return ext.isRunning.call(this)?this.tryCatch(function(){if(t){var e="",i=this;__.forEach(t.split(","),function(t,i){t&&(e+=","),e+='[this-id="'+i.trim()+'"][this-autocomplete]'}),this.container.find(e).each(function(){var t=_(this),e=i.container.find('[this-id="'+t["this"]("list")+'"][this-type="list"],list[this-id="'+t["this"]("list")+'"]'),s=i.container.find('[this-id="'+e["this"]("selection-list")+'"][this-type="list"],list[this-id="'+e["this"]("selection-list")+'"]');s.html("").hide().trigger("list.emptied"),e.removeThis("selected").html("").hide().trigger("list.emptied"),t.val("").trigger("keyup").show()})}return this}):(this.error("App not started yet!"),this)},secureAPI:function(t){return ext.secureAPI.call(this,t),this},setBaseURL:function(t){return this.config.baseURL=t,this},setComponentsPath:function(t,e){return this.config.paths||(this.config.paths={}),this.config.paths.components={dir:t,ext:e||".html"},this},setCSSPath:function(t){return this.config.paths||(this.config.paths={}),this.config.paths.css=t,this},setDataKey:function(t){return this.config.dataKey=t,this},setDataTransport:function(t){return t&&(this.dataTransport=t),this},setDefaultLayout:function(t){return this.config.layout=t,this},setJSPath:function(t){return this.config.paths||(this.config.paths={}),this.config.paths.js=t,this},setLayoutsPath:function(t,e){return this.config.paths||(this.config.paths={}),this.config.paths.layouts={dir:t,ext:e||".html"},this},setPagesPath:function(t,e){return this.config.paths||(this.config.paths={}),this.config.paths.pages={dir:t,ext:e||".html"},this},setStore:function(t){if(!ext.isRunning.call(this))if(__.isFunction(t)){var e=t("___test");__.isObject(e)?__.isFunction(e.find)&&__.isFunction(e.save)&&__.isFunction(e.saveMany)&&__.isFunction(e.remove)&&__.isFunction(e.drop)||this.error("Returned collections object must have methods find, save, saveMany, remove and drop which are all functions."):this.error("Store must return a collections object"),e.drop(),Store=t}else this.error("Store must be funtion which returns a store object on the given collection name.");return this},setTitleContainer:function(t){return this.config.titleContainer=this._(t),this},setTransition:function(t,e){return this.config.transition=t,this.config.transitionOptions=e,this},setUploader:function(t){return this.setup=t,ext.setUploader.call(this,t),this},start:function(t,e){if(ext.isRunning.call(this))return this;t&&(this.config.startWith=t);var i=location.hash,s=ext.processLink.call(this,i),n=this.config.startWith||_("[this-default-page]")["this"]("id"),a=s?s:n;return this._("body").find('page[this-id="'+n+'"],[this-type="page"][this-id="'+n+'"]')["this"]("default-page",""),this.firstPage=!0,ext.setup.call(this,a),e||this.config.debug||!history.state||a!==ext.recordsStore.find("last_page")?this.loadPage(i&&"#"!==i&&"#/"!==i?i:a):ext.restoreState.call(this,history.state),this},store:function(t){return ext.isRunning.call(this)?this.tryCatch(function(){return ext.store.call(this,t)}):this.error("App is not started yet!")},tryCatch:function(t,e){return __.tryCatch(function(){return __.callable(t).call(this)}.bind(this),function(t){return this.error(t),e&&__.callable(e).call(this,t),this}.bind(this))},watch:function(t){return ext.isRunning.call(this)||(this.watchCallback=t),this},when:function(t,e,i){return this.tryCatch(function(){return when.call(this,t,e,i)})}},__.forEach(ThisApp.prototype,function(t,e){__.isFunction(e)&&(e.toString=function(){return"See https://this-js.github.com/#/methods?lookup="+t})}),ThisApp.toString=function(){return"See https://this-js.github.com"},__.forEach(["Transitions","Filters","extend","toString"],function(t,e){ThisApp[e].toString=function(){return"toString"===e?"toString() { [custom code] }":"See https://this-js.github.com/#/advanced?lookup="+e}}),__.forEach(__.__proto__,function(t,e){e.toString=function(){return"See https://this-js.github.com/#/__util?lookup="+t}})}();