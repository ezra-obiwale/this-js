// ThisJS version 1.0.0 (http://thisjs.com) | License (http://thisjs.com/#license) | (c) 2016 Ezra Obiwale
(function(){var Ajax=function(config,__){var __this=__||this;function parseData(data){if(!__this.isObject(data))
return data;var str='';__this.forEach(data,function(i,v){if(str)
str+='&';if(__this.isObject(v,true)){var isArray=__this.isArray(v);__this.forEach(v,function(j,w){if(j)
str+='&';if(isArray)
j=null;if(__this.isObject(w,true))
str+=i+'['+j+']='+parseData(w);else
str+=i+'['+j+']='+encodeURIComponent(w);});}
else
str+=i+'='+encodeURIComponent(v);});return str;}
config=__this.extend({type:'get',url:location.href,data:null,dataType:'json',success:function(){},error:function(){},complete:function(){},progress:function(e,loaded,total){},crossDomain:true,async:true,clearCache:false},config);var httpRequest=new XMLHttpRequest();httpRequest.onreadystatechange=function(){if(httpRequest.readyState===XMLHttpRequest.DONE){if(httpRequest.status>=200&&httpRequest.status<400){__this.callable(config.success).call(httpRequest,httpRequest.response);}
else{__this.callable(config.error).call(httpRequest);}
__this.callable(config.complete).call(httpRequest);}};if(config.clearCache){config.url+=((/\?/).test(config.url)?"&":"?")+(new Date()).getTime();}
if(config.type.toLowerCase()==='get'&&config.data&&__this.isObject(config.data)&&Object.keys(config.data).length){config.url+=((/\?/).test(config.url)?"&":"?")+parseData(config.data);config.data=null;}
httpRequest.open(config.type.toUpperCase(),config.url,config.async);httpRequest.responseType=config.dataType;httpRequest.withCredentials=config.crossDomain;httpRequest.setRequestHeader('X-Requested-With','XMLHttpRequest');httpRequest.setRequestHeader('Requested-With','XMLHttpRequest');if(config.data)
httpRequest.setRequestHeader('Content-Type','application/x-www-form-urlencoded');__this.tryCatch(function(){httpRequest.upload.onprogress=function(e){if(e.lengthComputable){__this.callable(config.progress).call(httpRequest,e,e.loaded,e.total);}};});httpRequest.send(__this.isObject(config.data)?JSON.stringify(config.data):config.data);return httpRequest;},__=Object.create({items:[],debug:true,contains:function(item,str,all){var _this=this;return this.tryCatch(function(){if(_this.isObject(item,true)){var found=false;_this.forEach(item,function(i,v){if(_this.contains(v,str,all)){found=true;return false;}});return found;}
if(this.isString(str))
return _this.isString(item)&&item.indexOf(str)!==-1;else if(this.isArray(str)){var found=true;this.forEach(str,function(i,v){found=_this.contains(item,v,all);if(!all&&found){return false;}
else if(all){return found;}});return found;}});},callable:function(callback,nullable){if(this.isFunction(callback)){return callback;}
else if(this.isString(callback)){var split=callback.split('.'),func=window;for(var i=0;i<split.length;i++){if(!func[split[i]]){return this.callable(null,true);}
func=func[split[i]];}
return func===window?this.callable(null,true):this.callable(func);}
else if(!nullable){return function(){};}},each:function(callback){return this.forEach(this.items,callback);},forEach:function(items,callback){return this.tryCatch(function(){if(this.isObject(items)&&items instanceof _)
items=items.items;if(this.isArray(items))
items.every(function(v,i){return false!==this.callable(callback).call(v,i,v);}.bind(this));else{for(var a in items){if(!items.hasOwnProperty(a))
continue;if(false===this.callable(callback).call(items[a],a,items[a]))
break;}}
return this;});return this;},isObject:function(item,allowArray){return typeof item==='object'&&(allowArray||!Array.isArray(item));},isArray:function(item){return typeof item==='object'&&Array.isArray(item);},isString:function(item){return typeof item==='string';},isBoolean:function(item){return item===true||item===false;},isFunction:function(item){return typeof item==='function';},arrayRemoveValue:function(array,item,all){return this.tryCatch(function(){var index=array.indexOf(item);if(index<0){index=array.indexOf(parseInt(item));}
if(!all){return index>-1?[this.arrayRemoveIndex(array,index)]:[];}
else{while(index>-1){this.arrayRemoveIndex(array,index);index=array.indexOf(item);if(index<0)
index=array.indexOf(parseInt(item));}}
return array;});},arrayRemoveIndex:function(array,index){return this.tryCatch(function(){return array.splice(index,1)[0];});},inObject:function(item,object){var is=false;this.forEach(object,function(i,v){if(v===item){is=true;return false;}});return is;},keyExists:function(key,object){return object.hasOwnProperty(key);},show:function(){return this.each(function(){if(this.style.display==='none')
this.style.display='inherit';});},hide:function(){return this.each(function(){this.style.display='none';});},toggle:function(){var _this=this;this.each(function(){if(this.style.display==='none'){_(this,_this.debug).show();}
else{_(this,_this.debug).hide();}});return this;},hasAttr:function(attr){return this.tryCatch(function(){return this.attr(attr)!==null;});},attr:function(attr,val){return this.tryCatch(function(){if(val!==undefined){this.each(function(){this.setAttribute(attr,val);});return this;}
if(!this.items.length)
return null;return attr?this.items[0].getAttribute(attr):Array.from(this.items[0].attributes);});},removeAttr:function(attr){var _this=this;return this.each(function(){var __this=this;if(!attr){_this.forEach(Array.from(this.attributes),function(){__this.removeAttribute(this.name);});return;}
this.removeAttribute(attr);});},data:function(key,value){if(value){this.each(function(){if(this.dataset)
this.dataset[key]=value;});return this;}
if(!this.items.length||!this.items[0].dataset)
return null;value=this.items[0].dataset[key];return this.tryCatch(function(){return eval(value);},function(){return value;});},extend:function(object,_,deep){var args=Array.from(arguments),newObject={},_this=this;this.forEach(args,function(i,o){if(_this.isArray(o))
o=o.reduce(function(o,v,i){o[i]=v;return o;},{});if(_this.isObject(o)){_this.forEach(o,function(i,v){if(newObject[i]&&_this.isObject(newObject[i],true)&&_this.isObject(v,true)&&deep)
newObject[i]=_this.extend(newObject[i],v,deep);else
newObject[i]=v;});}});return newObject;},ajax:function(config){config=this.extend({type:'get',url:location.href,data:{},success:function(data){},error:function(){},complete:function(){}},config);return Ajax(config,this);},on:function(event,selector,callback){if(arguments.length===2){callback=selector;selector=null;}
var _this=this;return this.each(function(){var target=this;_this.forEach(event.split(','),function(i,v){target.addEventListener(v.trim(),function(e){if(selector&&e.target&&!e.target.matches(selector)){return;}
_this.callable(callback).apply(e.target,Array.from(arguments));},false);});});return this;},trigger:function(event,detail){var data={detail:detail,cancelable:true,bubbles:true},ev=new CustomEvent(event,data);return this.each(function(){this.dispatchEvent(ev);});},children:function(selector){var result=[];this.each(function(){if(selector){var id=false;if(!this.id){this.id='rANd'+Math.ceil(Math.random()*100);id=true;}
result=result.concat(Array.from(document.querySelectorAll('#'
+this.id+'>'+selector)));if(id)
this.removeAttribute('id');return;}
result=result.concat(Array.from(this.children));});return _(result,this.debug);},before:function(elem){if(!elem){var siblings=[];this.each(function(){if(this.previousElementSibling)
siblings.push(this.previousElementSibling);});return _(siblings,this.debug);}
if(!(elem instanceof _))
elem=_(elem,this.debug);if(!elem.length)
return this;return this.each(function(){var _this=this;elem.each(function(){_this.insertAdjacentElement('beforeBegin',this);});});},after:function(elem){if(!elem){var siblings=[];this.each(function(){if(this.nextElementSibling)
siblings.push(this.nextElementSibling);});return _(siblings,this.debug);}
if(!(elem instanceof _))
elem=_(elem,this.debug);if(!elem.length)
return this;return this.each(function(){var _this=this;elem.each(function(){_this.insertAdjacentElement('afterEnd',this);});});},wrap:function(elem){var _this=this,elem=_(elem,this.debug);return this.each(function(){_(this,_this.debug).before(elem).before().html(this);});},innerWrap:function(elem){var _this=this;return this.each(function(){var __this=_(this);__this.html(_(elem,_this.debug).html(__this.html()));});},outerHtml:function(){return this.tryCatch(function(){return this.items.length?this.items[0].outerHTML:'';});},text:function(content){if(content===undefined){return this.tryCatch(function(){return this.items.length?this.items[0].innerText:'';});}
return this.each(function(){this.innerText=content;});},html:function(content){if(content===undefined){return this.tryCatch(function(){return this.items.length?this.items[0].innerHTML:'';});}
var _this=this;if(content instanceof _||(_this.isObject(content)&&content['outerHTML'])){this.html('').append(content);return this;}
return this.each(function(){this.innerHTML=content;});},prepend:function(content){if(!content)
return this;var _content=content;if(!(content instanceof _))
_content=_(content,this.debug);if(!_content.length&&this.isString(content))
_content=this.createElement(null,'span').items[0].innerHTML=content;if(!_content.length)
return this;return this.each(function(){this.insertAdjacentElement('afterBegin',_content.items[0]);});},append:function(content){if(!content)
return this;var _content=content;if(!(content instanceof _))
_content=_(content,this.debug);if(!_content.length&&this.isString(content))
_content=this.createElement(null,'span').items[0].innerHTML=content;if(!_content.length)
return this;return this.each(function(){this.insertAdjacentElement('beforeEnd',_content.items[0]);});},remove:function(){var removed=[];this.each(function(){if(this.parentElement)
removed.push(this.parentElement.removeChild(this));});return _(removed,this.debug);},clone:function(){return this.tryCatch(function(){return _(this.items.length?this.items[0].cloneNode(true):[],this.debug);});},find:function(selector){var result=[],_this=this;this.each(function(){if(_this.items.length>1){result=result.concat(Array.from(this.querySelectorAll(selector)));}
else
result=Array.from(this.querySelectorAll(selector));});return _(result,this.debug);},filter:function(func){var _this=this,filtered=this.items.filter(function(v,i){func=_this.callable(func);return func?func.call(v,i,v):true;});return _(filtered,this.debug);},closest:function(selector){return this.tryCatch(function(){return _(this.items.length?this.items[0].closest(selector):[],this.debug);});},parent:function(){var parents=[];this.each(function(){parents.push(this.parentElement);});return _(parents,this.debug);},get:function(index){return this.items[index];},replaceWith:function(content){var replaced=[];content=_(content,this.debug);this.each(function(){var _content=content.items[0];if(!_content)
return;this.replaceWith(_content);replaced.push(_content);});this.items=replaced;return this;},error:function(message){if(this.debug)
console.error(message);return this;},toJSONObject:function(string){return this.tryCatch(function(){return JSON.parse(string);});},toJSONString:function(object){return this.tryCatch(function(){return JSON.stringify(object);});},createElement:function(str,tag){var d=document.createElement(tag||'div');if(!str)
return _(d,this.debug);d.innerHTML=str;return _(Array.from(d.children),this.debug);},is:function(selector){if(!this.items.length)
return false;var el=this.items[0];return(el.matches||el.matchesSelector||el.msMatchesSelector||el.mozMatchesSelector||el.webkitMatchesSelector||el.oMatchesSelector).call(el,selector);},val:function(value){var val;this.each(function(){if(value){this.value=value;return;}
val=this.value;});return value?this:val;},prop:function(prop,value){return this.tryCatch(function(){if(value){this.each(function(i,v){v[prop]=value;});return this;}
return prop&&this.items.length?this.items[0][prop]:null;});},addClass:function(className){var _this=this;return this.each(function(){var __this=this;_this.forEach(className.split(' '),function(i,v){__this.classList.add(v);});});},removeClass:function(className){var _this=this;return this.each(function(){var __this=this;_this.forEach(className.split(' '),function(i,v){__this.classList.remove(v);});});},hasClass:function(className){var has=true,_this=this;this.each(function(){if(!this.classList.length||!_this.contains(Array.from(this.classList),className)){has=false;return false;}});return has;},toggleClass:function(className){return this.each(function(){var _this=_(this);if(_this.hasClass(className))
_this.removeClass(className);else
_this.addClass(className);});return this;},siblings:function(selector){var siblings=[];this.each(function(){var rId=false;if(!this.id){this.id='rANd'+Math.ceil(Math.random()*100);rId=true;}
siblings=siblings.concat(_(this.parentElement,this.debug).children((selector||'')+':not(#'+this.id+')').items);if(rId)
this.removeAttribute('id');});return _(siblings,this.debug);},tryCatch:function(tryCallback,catchCallback){try{return this.callable(tryCallback).call(this);}
catch(e){if(!catchCallback)
this.error(e.message);else
return this.callable(catchCallback).call(this,e);}}}),_=function(selector,debug){if(!(this instanceof _)){return new _(selector,debug);}
else if(selector instanceof _){return selector;}
else if(!selector){this.items=[];}
else if(this.isObject(selector)){this.items=selector instanceof HTMLCollection?Array.from(selector):[selector];}
else if(this.isArray(selector)){this.items=selector;}
else if(this.isString(selector)){var _this=this.createElement(selector);if(_this.length)
return _this;this.items=Array.from(document.querySelectorAll(selector));}
else{this.error('Invalid selector');}
this.__proto__.debug=debug!==false?true:false;this.length=this.items.length;return this;},internal=Object.create({canContinue:function(action,params){var response=this.__.callable(this.beforeCallbacks[action]).apply(this,params);if(response)
return response;else
return response!==false;},setup:function(){this.tryCatch(function(){var _this=this;this.__.__proto__.debug=this.config.debug;if(this.config.paths){this.__.forEach(this.config.paths,function(i,v){if(_this.__.isString(v)&&!v.endsWith('/'))
_this.config.paths[i]+='/';else if(_this.__.isObject(v))
if(v.dir&&!v.dir.endsWith('/'))
_this.config.paths[i].dir+='/';});}
if(!this.notFound)
this.notFound=function(){if(_this.firstPage){if(_this.store('last_page')){var last_page=_this.store('last_page');_this.store('last_page',null);_this.loadPage(last_page);}
else if(_this.config.startWith){if(this._('page[this-id="'+_this.config.startWith
+'"]:not([this-current]):not([this-dead]),'
+'[this-type="pages"]>[this-id="'
+_this.config.startWith+'"]').length)
_this.loadPage(_this.config.startWith);}
else{var startWith=_this._('[this-default-page]');if(startWith.length)
_this.loadPage(startWith.attr('this-id'));}}};this.container=this._('[this-app-container]');if(!this.container.length)
this.container=this._('body');if(!this._('[this-type="pages"]').length){this._('body').append('<div this-type="pages" style="display:none"/>').find('[this-type="pages"]').append(this._('[this-type="page"]:not([this-loaded])').hide());}
if(this._('[this-type="component"]').length&&!this._('[this-type="components"]').length){this._('body').append('<div this-type="components" style="display:none"/>').find('[this-type="components"]').append(this._('[this-type="component"]').hide());}
if(this._('[this-type="layout"]').length&&!this._('[this-type="layouts"]').length){this._('body').append('<div this-type="layouts" style="display:none"/>').find('[this-type="layouts"]').append(this._('[this-type="layout"]:not([this-loaded])').hide());}
this._('page:not([this-loaded]),model:not([this-loaded]),'
+'collection:not([this-loaded]),layout:not([this-loaded]),'
+'component:not([this-loaded]),[this-type]:not([this-loaded])').hide();if(this.config.titleContainer)
this.config.titleContainer=this._(this.config.titleContainer,this.config.debug);this.container.on('click','[this-reload]',function(e){e.preventDefault();var __this=_this._(this);if(!__this.attr('this-reload')){_this.error('What to reload isn\'t specified.');return;}
var reload=__this.attr('this-reload'),toReload=_this._(internal.selector.call(_this,reload,':not([this-loaded])')),_reload=_this.page.find(internal.selector.call(_this,reload,'[this-loaded]'));if(!toReload.length){_this.error('Reload target not found');return;}
if(__this.attr('this-attributes'))
_this.__.forEach(__this.attr('this-attributes').split(';'),function(i,v){var attr=v.split(':'),name=_this.__.arrayRemoveIndex(attr,0);attr=attr.join(':');toReload.attr(name,attr);});_reload.replaceWith(toReload.clone().removeAttr('this-cache'));internal.loadCollection.call(_this,_reload,true);}).on('click','[this-go-home]',function(e){_this.home();e.stop=true;}).on('click','[this-go-back]',function(e){_this.back(e);e.stop=true;}).on('click','[this-go-forward]',function(e){_this.forward(e);e.stop=true;}).on('click','[this-goto][this-read]',function(e){var __this=_this._(this),_model=__this.closest('model,[this-type="model"]'),model_id=_model.attr('this-mid'),url=__this.attr('this-read')||_model.attr('this-url')||'#',goto=internal.pageIDFromLink.call(this,__this.attr('this-goto'));_this.tar['page#'+goto]={reading:true,url:url};if(__this.attr('this-read')){var split=__this.attr('this-read').split('/');model_id=split[split.length-1];}
_this.tar['page#'+goto]['mid']=model_id;}).on('click','[this-goto][this-update]',function(){var __this=_this._(this),model=__this.closest('model,[this-type="model"]'),model_id=model.attr('this-mid'),model_name=__this.attr('this-model')||model.attr('this-id'),url=__this.attr('this-update')||model.attr('this-url')||'#',goto=internal.pageIDFromLink.call(this,__this.attr('this-goto'));_this.tar['page#'+goto]={"do":"update",mid:model_id,action:url,model:model_name};if(model.attr('this-uid'))
_this.tar['page#'+goto]['model-uid']=model.attr('this-uid');}).on('click','[this-goto][this-create]',function(){var __this=_this._(this),url=__this.attr('this-create')||'#',goto=internal.pageIDFromLink.call(this,__this.attr('this-goto'));_this.tar['page#'+goto]={"do":"create",action:url};if(__this.attr('this-model'))
_this.tar['page#'+goto]['model']=__this.attr('this-model');if(__this.attr('this-model-uid'))
_this.tar['page#'+goto]['model-uid']=__this.attr('this-model-uid');}).on('click','[this-goto][this-delete]',function(){var __this=_this._(this),model=__this.closest('model,[this-type="model"]'),url=__this.attr('this-delete')||model.attr('this-url')||'#',model_name=__this.attr('this-model')||model.attr('this-id'),uid=model.attr('this-uid'),goto=internal.pageIDFromLink.call(this,__this.attr('this-goto'));_this.tar['page#'+goto]={"do":"delete",action:url,uid:uid};if(model)
_this.tar['page#'+goto]['model']=model_name;}).on('click','[this-goto]',function(e){e.preventDefault();var __this=_this._(this);if(!__this.attr('this-goto'))
return;_this.page.trigger('page.leave');var goto=internal.pageIDFromLink.call(this,__this.attr('this-goto'));if(!_this.tar['page#'+goto])
_this.tar['page#'+goto]={};if(__this.attr('this-page-title'))
_this.tar['page#'+goto]['title']=__this.attr('this-page-title');if(__this.attr('this-run'))
_this.tar['page#'+goto]['run']=__this.attr('this-run');if(__this.attr('this-ignore-cache'))
_this.tar['page#'+goto]['ignore-cache']=__this.attr('this-ignore-cache');_this.loadPage(goto);e.stop=true;}).on('click','[this-delete]',function(e){if(e.stop)
return;e.preventDefault();var __this=_this._(this);var _model=__this.closest('model,[this-type="model"]'),_do=__this.closest('[this-do="delete"]'),__model=new Model(_model.attr('this-mid'),{},{app:_this,name:__this.attr('this-model')||_model.attr('this-id')||_do.attr('this-model'),uid:_model.attr('this-uid')||_do.attr('this-uid')||'id',url:__this.attr('this-delete')||_model.attr('this-url')||_do.attr('this-action')});if(!internal.canContinue.call(this,'model.delete',[__model,_model.items[0]])){_model.trigger('delete.canceled');return;}
__model.remove(false,function(data){var model=_this.config.dataKey?data[_this.config.dataKey]:data;if(model){if(_this.page.attr('this-do')==='delete')
_this.back();else{_this.page.find('[this-binding]').hide();}
__this.trigger('delete.success',{response:this,responseData:data});}
else
__this.trigger('delete.failed',{response:this,responseData:data});},function(){__this.trigger('delete.error',{response:this});},function(){__this.trigger('delete.complete',{response:this});});}).on('click','[this-bind]',function(e){e.preventDefault();var __this=_this._(this),bind=__this.attr('this-bind'),_model=__this.closest('model,[this-type="model"],'
+'[this-model]');if(!bind)
return;var _target=_this.page.find(internal.selector.call(_this,bind,':not([this-in-collection]):not([this-cache])'));if(!_target.length)
return;_target.attr('this-model',(_model.attr('this-model')||_model.attr('this-id'))).attr('this-binding','');if(__this.hasAttr('this-read'))
_this.page.find('[this-model="'+(_model.attr('this-model')||_model.attr('this-id'))+'"][this-binding]').hide();if(__this.hasAttr('this-update'))
_target.attr('this-tar','do:update');if(__this.hasAttr('this-create'))
_target.attr('this-tar','do:create');internal.bindToModel.call(_this,_target,_model,__this.attr('this-cache'));}).on('click','[this-toggle]',function(e){e.preventDefault();_this.container.find(internal.selector.call(_this,_this._(this).attr('this-toggle'))).toggle();internal.saveState.call(_this,true);}).on('click','[this-hide]',function(e){e.preventDefault();_this.container.find(internal.selector.call(_this,_this._(this).attr('this-hide'))).hide();internal.saveState.call(_this,true);}).on('click','[this-show]',function(e){e.preventDefault();var __this=_this._(this),_target=_this.container.find(internal.selector.call(_this,__this.attr('this-show')));if(__this.attr('this-create')){_this.page.find('[this-binding]').hide();var form=_target.is('form[this-model="'
+__this.attr('this-model')+'"]')?_target:_target.find('form[this-model="'
+__this.attr('this-model')+'"]');form.attr('this-do','create').attr('this-url',__this.attr('this-create')).attr('this-binding','');if(__this.attr('this-model-uid'))
form.attr('this-model-uid',__this.attr('this-model-uid'));form.removeAttr('this-mid');if(form.length)
form.get(0).reset();}
_target.show();internal.saveState.call(_this,true);}).on('submit','form[this-do="create"]:not([this-ignore-submit]),'
+' form[this-do="update"]:not([this-ignore-submit])',function(e){e.preventDefault();var data={},__this=_this._(this),creating=__this.attr('this-do')==='create',method=creating?'post':'put';if(!this.reportValidity()){__this.trigger('form.invalid.submission');return;}
__this.trigger('form.valid.submission');_this.__.forEach(Array.from(this.elements),function(){if(!this.name)
return;if(this.name.indexOf('[]')!==-1){var name=this.name.replace('[]','');if(!data[name]){data[name]=[];}
data[name].push(this.value);}
else if(this.name.indexOf('[')!==-1){var exp=this.name.replace(']','').split('['),_data=data,lastKey=exp.pop();_this.__.forEach(exp,function(i,v){if(!_data[v])
_data[v]={};_data=_data[v];});_data[lastKey]=this.value;}
else{data[this.name]=this.value;}});var id=null;if(__this.attr('this-mid'))
id=__this.attr('this-mid');else if(_this.page.attr('this-mid'))
id=_this.page.attr('this-mid');var _model=new Model(id,data,{app:_this,name:__this.attr('this-model')||_this.page.attr('this-model'),uid:__this.attr('this-uid')||__this.attr('this-model-uid')||_this.page.attr('this-model-uid'),url:__this.attr('this-action')||__this.attr('this-url')||_this.page.attr('this-action')||_this.page.attr('this-url'),method:method});if(!internal.canContinue.call(this,creating?'model.create':'model.update',[_model])){__this.trigger(creating?'model.create.canceled':'model.update.canceled');return;}
_model.save(_model.url===null,function(data){var model=_this.config.dataKey?data[_this.config.dataKey]:data;if(model){if(creating){__this.items[0].reset();if(!__this.hasAttr('this-binding')&&!__this.closest('[this-binding]').length)
_this.back();else if(__this.hasAttr('this-binding'))
__this.hide();}
__this.trigger('form.submission.success',{response:this,responseData:data,method:method.toUpperCase()});}
else{__this.trigger('form.submission.failed',{response:this,responseData:data,method:method.toUpperCase()});}},function(){__this.trigger('form.submission.error',{response:this,method:method.toUpperCase()});},function(){__this.trigger('form.submission.complete',{response:this,method:method.toUpperCase()});});}).on('submit','form[this-do="search"]',function(e){e.preventDefault();var _form=_this._(this),_search=_form.find('[this-search]');if(!_search.attr('this-search')){_this.error('Invalid search target');return;}
var exp=_search.attr('this-search').split(':'),selector='collection[this-id="'+exp[0]
+'"],[this-type="collection"][this-id="'+exp[0]+'"]',keys=exp[1],page=_form.attr('this-type')==='page'?_form:_form.closest('page,[this-type="page"]'),goto=_form.attr('goto')||page.attr('this-id'),filter='',_collection,replaceState=_this.page.attr('this-id')===goto&&_this.page.attr('this-query')===_search.val().trim();if(keys)
keys=keys.split(',');_this.__.forEach(keys,function(i,key){if(filter)
filter+=' || ';filter+='_this.__.contains(filters.lcase(model#'+key
+'),filters.lcase("'+_search.val()+'"))';});if(_form.attr('this-reload')){_collection=page.find(internal.selector.call(_this,_form.attr('this-reload'),':not([this-cache])'));_collection.attr('this-filter',filter).attr('this-search',keys.join(','));page.attr('this-query',_search.val().trim());internal.loadCollection.call(_this,_collection,replaceState);}
else{goto=internal.pageIDFromLink.call(this,goto);var _page=_this._('page[this-id="'+goto
+'"]:not([this-current]):not([this-dead]),'
+'[this-type="page"][this-id="'
+goto+'"]:not([this-current]):not([this-dead])'),_component=_page.find('[this-component="'
+exp[0]+'"]');_component.attr('this-filter','collection#'+exp[0]+':'
+filter).attr('this-search','collection#'
+exp[0]+':'+keys.join(','));_this.tar['page#'+goto]={query:_search.val().trim()};if(_search.attr('this-ignore-cache'))
_this.tar['page#'+goto]['ignore-cache']=_search.attr('this-ignore-cache');_collection=_page.find(selector);_collection.attr('this-filter',filter).attr('this-search',keys.join(','));_this.loadPage(goto,replaceState);}});this._('[this-go-home]').on('click',function(e){_this.home();});this._('[this-go-back]').on('click',function(e){if(!e.stop)
_this.back(e);});this._('[this-go-forward]').on('click',function(e){if(!e.stop)
_this.forward(e);});this._(window).on('popstate',function(e){if(e.state)
internal.restoreState.call(_this,e.state);});this.__.forEach(this.events,function(){_this.container.on(this.event,this.selector,this.callback);});});this.__proto__.running=true;return this;},watch:function(elem){elem=this._(elem);if(!elem.attr('this-id')||this.watching[elem.attr('this-id')]||!elem.attr('this-url'))
return this;var isCollection=internal.is.call(this,'collection',elem),model_name=elem.attr('this-model')||elem.attr('this-id');this.watching[elem.attr('this-id')]={type:isCollection?'collection':'model',url:elem.attr('this-url'),mid:elem.attr('this-mid')};this.__.callable(this.watchCallback)(elem.attr('this-url'),function(resp){var action=this.store(resp.event)||{};switch(resp.event){case'created':internal.modelToStore.call(this,model_name,resp.id,resp.data,elem.attr('this-uid')||elem.attr('this-model-uid'));if(!action[model_name])
action[model_name]=[];action[model_name]=this.__.arrayRemoveValue(action[model_name],resp.id,true);action[model_name].push(resp.id);break;case'updated':var data=resp.data,id=resp.id;if(!isCollection&&elem.attr('this-mid')){delete data[elem.attr('this-uid')||'id'];var _data={};_data[id]=data;data=_data;id=elem.attr('this-mid');}
data=internal.modelToStore.call(this,model_name,id,data,elem.attr('this-uid')||elem.attr('this-model-uid'));if(!action[model_name])
action[model_name]={};action[model_name][id]=data;break;case'deleted':internal.removeModelFromStore.call(this,model_name,resp.id);if(!action[model_name])
action[model_name]=[];action[model_name]=this.__.arrayRemoveValue(action[model_name],resp.id,true);action[model_name].push(resp.id);break;}
this.store(resp.event,action);internal.updatePage.call(this);elem.trigger('updated',{event:resp.event,response:resp});}.bind(this));return this;},pageIDFromLink:function(link){if(link.startsWith('#'))
link=link.substr(1);var parts=link.split('&');if(parts.length>1)
this.target_on_page=parts[1];return parts[0];},resolveTargetOnPage:function(){if(!this.target_on_page)
return this;this._('#'+this.target_on_page).trigger('click');delete this.target_on_page;},bindToModel:function(_target,_model,ignoreCache){var model_name=_model.is('model')||_model.attr('this-type')==='model'?_model.attr('this-id'):_model.attr('this-model'),model;if(!_model.attr('this-mid')){this.error('Model to bind to does not have an id');return;}
if(!ignoreCache)
model=this.collection(model_name).model(_model.attr('mid'));if(model){model.bind(_target);_target.trigger('variables.binded',{data:model});internal.saveState.call(this,true);}
else{var _this=this;this.request(_model,function(data){data=_this.config.dataKey?data[_this.config.dataKey]:data;model=new Model(_model.attr('mid'),data,{name:_model.attr('this-id'),app:_this,uid:_model.attr('this-uid')||'id',url:_model.attr('this-url')});model.bind(_target);_target.trigger('variables.binded',{data:data});internal.saveState.call(_this,true);});}
return this;},cache:function(type,id,data,update){if(!type)
return this.store();var __data=this.store(type.toLowerCase())||{};if(!data){if(!id)
return __data;return __data?__data[id]:[];}
if(update){if(__data[id])
if(__data[id].data)
data.data=this.__.extend(__data[id].data,data.data,true);__data[id]=data;}
else
__data[id]=data;__data[id].length=Object.keys(__data[id].data).length;this.store(type.toLowerCase(),__data);return this;},clearCache:function(type,id){if(!type){localStorage.clear();return this;}
if(!id){localStorage.removeItem(type.toLowerCase());return this;}
var data=internal.cache.call(this,type.toLowerCase());delete data[id];return this.store(type.toLowerCase(),data);},modelFromStore:function(model_id,model_name){return this.tryCatch(function(){var _collection=internal.cache.call(this,'model',model_name);return _collection&&_collection.length&&((_collection.expires&&_collection.expires>Date.now())||!_collection.expires)?_collection.data[model_id]:null;});},modelToStore:function(model_name,model_id,model,uid){return this.tryCatch(function(){var collection=internal.cache.call(this,'model',model_name)||{data:{},uid:uid,length:0};if(!model_id)
model_id=model[collection.uid||uid];model=this.__.extend(collection.data[model_id],model,true);collection.data[model_id]=model;internal.cache.call(this,'model',model_name,collection,false);return model;});},removeModelFromStore:function(model_name,model_id){this.tryCatch(function(){var collection=internal.cache.call(this,'model',model_name);delete collection.data[model_id];internal.cache.call(this,'model',model_name,collection);return this;});},fullyFromURL:function(type,id,success,error){if(!this.config.paths){this.__.callable(error).call(this);return;}
var _this=this,pathConfig=this.config.paths[type+'s'],url=pathConfig.dir+id+pathConfig.ext;this.request(url,function(data){var elem=_this.__.createElement(data);if(type!=='component'){if(!elem.length||elem.length>1||(!elem.is(type)&&elem.attr('this-type')!==type))
{elem=_this._('<div this-type="'+type+'" this-id="'
+id+'" />').html(data);}
elem.attr('this-id',id);}
_this.__.callable(success).call(this,elem);},function(e){_this.__.callable(error).call(this,e);},{},'text');},notAPage:function(page){this.error('Page ['+page+'] not found');if(this.__.isString(this.notFound)){page=this._(internal.selector.call(this,this.notFound.startsWith('page#')?this.notFound:'page#'+this.notFound,':not([this-current]):not([this-dead])'));if(!page.length){return this.error('Page ['+this.notFound+'] also not found');}
internal.pageFound.call(this,page,true);return this;}
else
return this.__.callable(this.notFound).call(this,page);},pageFound:function(page,replaceInState){if(internal.is.call(this,'page',page)){if(!internal.canContinue.call(this,'page.load',[page.items[0]])){page.trigger('page.load.canceled');return this;}
if(this.page){this.oldPage=this.page.attr('this-dead','');if(this.oldPage.attr('this-id')===page.attr('this-id'))
replaceInState=true;}
if(this.store('last_page')===page.attr('this-id'))
replaceInState=true;this.page=page.clone();internal.loadLayouts.call(this,replaceInState);}
else{this.error('Load page failed: '+page.attr('this-id'));page.trigger('page.load.failed');}},loadLayouts:function(replaceInState){var _layout=_(),_this=this;if(this.config.layout||this.page.attr('this-layout')){var layout=this.page.attr('this-layout')||this.config.layout;_layout=this.container.find('layout[this-id="'+layout
+'"],[this-type="layout"][this-id="'+layout+'"]');_layout.find('[this-content]').html(this.page.show());if(!_layout.length){_layout=this._('[this-type="layouts"] layout[this-id="'+layout+'"],'
+'[this-type="layouts"] [this-type="layout"][this-id="'
+layout+'"]').clone();if(!_layout.length){internal.fullyFromURL.call(this,'layout',layout,function(_layout){_layout.removeAttr('this-url').find('[this-content]').html(_this.page);if(_layout.attr('this-extends'))
internal.extendLayout.call(_this,_layout,replaceInState);else
internal.finalizePageLoad.call(_this,_layout,replaceInState);},function(){this.error('Layout ['+layout+'] not found!');internal.finalizePageLoad.call(_this,_layout,replaceInState);});}
else{if(_layout.attr('this-url')){this.request(_layout.attr('this-url'),function(data){_layout.removeAttr('this-url').html(data).find('[this-content]').html(_this.page);if(_layout.attr('this-extends'))
internal.extendLayout.call(_this,_layout,replaceInState);else
internal.finalizePageLoad.call(_this,_layout,replaceInState);},function(){},{},'text');}
else{_layout.find('[this-content]').html(_this.page);internal.extendLayout.call(this,_layout,replaceInState);}}}
else
internal.finalizePageLoad.call(this,_layout,replaceInState);}
else{internal.finalizePageLoad.call(this,_layout,replaceInState);}},extendLayout:function(_layout,replaceInState){var __layout=_layout.clone(),_this=this;_layout.removeAttr('this-extends');_layout=this.container.find('layout[this-id="'
+__layout.attr('this-extends')
+'"],[this-type="layout"][this-id="'
+__layout.attr('this-extends')+'"]');if(!_layout.length)
_layout=this._('[this-type="layouts"] layout[this-id="'
+__layout.attr('this-extends')+'"],'
+'[this-type="layouts"] [this-type="layout"][this-id="'
+__layout.attr('this-extends')+'"]').clone();if(!_layout.length){internal.fullyFromURL.call(this,'layout',__layout.attr('this-extends'),function(_layout){_layout.removeAttr('this-url').find('[this-content]').html(__layout);if(_layout.attr('this-extends'))
internal.extendLayout.call(_this,_layout,replaceInState);else
internal.finalizePageLoad.call(_this,_layout,replaceInState);},function(){this.error('Layout ['+__layout.attr('this-extends')
+'] not found!');internal.finalizePageLoad.call(_this,_layout,replaceInState);});}
else{if(_layout.attr('this-url')){this.request(_layout.attr('this-url'),function(data){_layout.removeAttr('this-url').html(data).find('[this-content]').html(__layout.show());if(_layout.attr('this-extends')){internal.extendLayout.call(_this,_layout,replaceInState);}
else{internal.finalizePageLoad.call(_this,_layout,replaceInState);}},function(){},{},'text');}
else{_layout.find('[this-content]').html(__layout.removeAttr('this-extends').show());if(_layout.attr('this-extends')){internal.extendLayout.call(this,_layout,replaceInState);}
else{internal.finalizePageLoad.call(this,_layout,replaceInState);}}}},finalizePageLoad:function(_layout,replaceInState){var _this=this;if(_layout&&_layout.length){if(!this.container.find('layout[this-id="'
+_layout.attr('this-id')
+'"],[this-type="layout"][this-id="'
+_layout.attr('this-id')+'"]').length)
this.container.html(_layout.show());}
else
this.container.html(this.page);this.page=this.container.find('page[this-id="'+this.page.attr('this-id')
+'"]:not([this-dead]),'
+'[this-type="page"][this-id="'
+this.page.attr('this-id')
+'"]:not([this-dead])').attr('this-current','').removeAttr('this-layout').show();this._('link[this-page]:not([this-page="'+this.page.attr('this-id')
+'"])').remove();if(this.page.attr('this-load-css')){var url=this.config.paths.css+this.page.attr('this-load-css').trim();if(!url.endsWith('.css'))
url+='.css';if(this.config.debug)
url+='?'+Math.round(Math.random()*99999);var link=this.__.createElement(null,'link').attr('type','text/css').attr('rel','stylesheet').attr('this-page',this.page.attr('this-id')).attr('href',url);this.page.prepend(link);}
internal.loadComponents.call(this,function(){this.page=internal.doTar.call(this,this.page);var transit=this.__.callable(this.config.transition,true),wait;if(transit)
wait=transit.call(null,_this.oldPage.removeAttr('this-current'),this.page,this.config.transitionOptions);else if(this.__.isString(this.config.transition)){if(!Transitions[this.config.transition])
this.config.transition='show';wait=Transitions[this.config.transition](_this.oldPage.removeAttr('this-current'),this.page,this.config.transitionOptions);}
setTimeout(function(){_this.oldPage.remove();delete _this.oldPage;},wait);if(this.config.titleContainer)
this.config.titleContainer.html(this.page.attr('this-title'));if(this.page.attr('this-url')){this.request(this.page.attr('this-url'),function(data){_this.page.html(data);internal.loadModels.call(_this,replaceInState,true);},function(){},{},'text');}
else{internal.loadModels.call(this,replaceInState,true);}}.bind(this));},doTar:function(__this,noShow){__this=this._(__this);var type=__this.attr('this-type')||__this.items[0].tagName.toLowerCase(),tar=type+'#'+__this.attr('this-id');if(this.tar[tar]){if(type==='page'&&this.tar[tar].reading){__this.attr('this-reading',true);delete this.tar[tar].reading;this.tar['model#'+__this.find('model,[this-type="model"]').attr('this-id')]=this.tar[tar];}
else{this.__.forEach(this.tar[tar],function(i,v){__this.attr('this-'+i,v);});}
delete this.tar[tar];}
if(__this.attr('this-tar')){var tar=__this.attr('this-tar').split(';');this.__.forEach(tar,function(i,v){var split=v.split(':');if(split.length<2)
return;__this.attr('this-'+split[0],split[1]);});}
if(!noShow)
__this.show();return __this.removeAttr('this-tar');},loadComponents:function(callback){var _this=this,components=this.page.find('[this-component]');this.__proto__.components+=components.length;if(!components.length)
this.__.callable(callback).call(this);components.each(function(){var __this=_this._(this);if(__this.attr('this-url')){internal.fullyFromURL.call(_this,'component',__this.attr('this-url'),function(data){var component=_this._(data);if(component.length>1)
component=component.wrap('<div/>').parent();internal.loadComponent.call(_this,__this,_this._(data),callback);},function(){_this.__.callable(callback).call(_this);});}
else{var component=_this._('component[this-id="'
+__this.attr('this-component')
+'"]:not([this-loaded]),[this-type="component"][this-id="'
+__this.attr('this-component')
+'"]:not([this-loaded]),[this-type="components"]>[this-id="'
+__this.attr('this-component')+'"]').clone();internal.loadComponent.call(_this,__this,component,callback);}});return this;},loadComponent:function(__this,component,callback){var _this=this,collection_id;this.__.forEach(__this.attr(),function(i,attr){if(attr.name==='this-component'||attr.name==='this-url')
return;if((attr.name==='this-filter'||attr.name==='this-search')&&_this.__.contains(attr.value,':')){var split=attr.value.split(':'),target=_this.__.arrayRemoveIndex(split,0),value=split.join(':'),selector='[this-id="'+target+'"]';if(_this.__.contains(target,'#')){split=target.split('#');selector=split[0]+'[this-id="'+split[1]
+'"],[this-type="'+split[0]
+'"][this-id="'+split[1]+'"]';collection_id=split[1];}
component.find(selector).attr(attr.name,value);return;}
component.attr(attr.name,attr.value);});if(!component.attr('this-type')&&!component.is('collection')&&!component.is('model'))
component.attr('this-type','component');if(component.attr('this-type')==='component'||component.is('component')){component.attr('this-loaded','').show();}
else{component.hide();}
__this.replaceWith(component).trigger('component.loaded');this.__proto__.components--;if(!this.__proto__.components)
this.__.callable(callback).call(this);},loadModels:function(replaceState,chain){var _this=this;if(this.components){setTimeout(function(){internal.loadModels.call(_this,replaceState);},300);return;}
var models=this.page.find('model:not([this-in-collection]),'
+'[this-type="model"]:not([this-in-collection])');this.__proto__.models+=models.length;if(chain&&!models.length)
internal.loadCollections.call(this,replaceState,chain);models.each(function(){internal.loadModel.call(_this,this,null,replaceState,chain,true);});return this;},loadModel:function(target,data,replaceState,chain,looping){var __this=this._(target),content=__this.hide().outerHtml(),_this=this;__this=internal.doTar.call(this,__this,true);if(!data&&!__this.attr('this-url')){this.__proto__.models--;if(chain&&!this.models)
internal.loadCollections.call(this,replaceState,chain);return;}
if(__this.siblings('[this-cache="'+__this.attr('this-id')
+'"]').length){content=__this.siblings('[this-cache="'+__this.attr('this-id')+'"]').html().hide();}
else{var cache=_this._(content.replace(/\(\{/g,'__obrace2__').replace(/\}\)/g,'__cbrace2__')).attr('this-cache',__this.attr('this-id'));__this.parent().append(cache.hide());}
var success=function(data){internal.loadData.call(_this,__this,data,content,true,true);__this.attr('this-loaded','').trigger('model.loaded');_this.__proto__.models--;if(chain&&!this.models)
internal.loadCollections.call(_this,replaceState,chain);},error=function(){_this.__proto__.models--;if(chain&&!this.models)
internal.loadCollections.call(_this,replaceState,chain);};internal.loadOrRequestData.call(this,{elem:__this,content:content,data:data,success:success,error:error,looping:looping,chain:chain,replaceState:replaceState});},loadOrRequestData:function(config){var _this=this,isCollection=internal.is.call(this,'collection',config.elem),type=isCollection?'collection':'model',ignore=_this.page.attr('this-ignore-cache')||'',cached=internal.cache.call(_this,'model',config.elem.attr('this-id')),cache=cached&&cached.length?cached.data:null,cache_expired=cached&&((cached.expires&&cached.expires<Date.now())||!cached.expires),fromCache=false;if(!isCollection&&cache)
cache=cache[config.elem.attr('this-mid')];if(!config.data&&config.elem.attr('this-url')&&(!cache||(cache&&cache_expired))&&!_this.__.contains(ignore,type+'#'
+config.elem.attr('this-id'))&&this.dataTransport&&this.transporterOnline){if(!config.elem.hasAttr('this-no-updates')&&this.watchCallback)
internal.watch.call(this,config.elem);config.elem.removeAttr('this-no-updates');this.__.callable(this.dataTransport).call(this,{action:'read',id:config.elem.attr('this-mid'),url:config.elem.attr('this-url'),isCollection:isCollection,success:function(){_this.__.callable(config.success).apply(config.elem,Array.from(arguments));config.elem.trigger('load.content.success');config.elem.trigger('load.content.complete');},error:function(){_this.__.callable(config.error).apply(config.elem,Array.from(arguments));config.elem.trigger('load.content.error');config.elem.trigger('load.content.complete');}});return this;}
else if(!config.data&&cache){if(config.looping)
this.__proto__[type+'s']--;config.data=cache;fromCache=true;}
if(config.data){var _data={};if(_this.config.dataKey){_data[_this.config.dataKey]=config.data;config.data=_data;}
internal.watch.call(this,config.elem);internal.loadData.call(this,config.elem,config.data,config.content,!isCollection,false);config.elem.attr('this-loaded','');if(fromCache){if(cache_expired)
config.elem.trigger('expired.'+type+'.cache.loaded');else
config.elem.trigger(type+'.cache.loaded');}
if(config.chain){if(isCollection&&!this.collections)
internal.loadForms.call(this,null,null,config.replaceState,config.chain);else if(!isCollection&&!this.models)
internal.loadCollections.call(this,config.replaceState,config.chain);}}
else if(config.elem.attr('this-url'))
_this.request(config.elem.attr('this-url'),config.success,config.error,config.requestData);else{config.elem.trigger(type+'.load.failed');if(config.looping)
this.__proto__[type+'s']--;if(config.chain){if(isCollection&&!this.collections)
internal.loadForms.call(this,null,null,config.replaceState,config.chain);else if(!isCollection&&!this.models)
internal.loadCollections.call(this,config.replaceState,config.chain);}}},loadCollections:function(replaceState,chain){var _this=this;var collections=this.page.find('collection:not([this-loaded])'
+':not([this-cache]):not([this-data]),'
+'[this-type="collection"]:not([this-loaded]):not([this-cache])'
+':not([this-data])');this.__proto__.collections+=collections.length;if(chain&&!collections.length)
internal.loadForms.call(this,null,null,replaceState,chain);collections.each(function(){var __this=_this._(this).addClass('loading');if(!__this.attr('this-model'))
__this.attr('this-model',__this.attr('this-id'));if(__this.children().length>1)
__this.innerWrap('<div/>');if(!_this._('collection[this-id="'+__this.attr('this-id')+'"]:not(.loading),[this-type="collection"][this-id="'
+__this.attr('this-id')+'"]:not(.loading)').length){var cache=__this.removeAttr('this-loaded').removeClass('loading').attr('this-cache','').hide().outerHtml().replace(/\(\{/g,'__obrace2__').replace(/\}\)/g,'__cbrace2__');_this.page.append(cache);}
__this.removeClass('loading');internal.loadCollection.call(_this,__this,replaceState,true,chain);});return this;},loadCollection:function(__this,replaceState,looping,chain,data){__this=this._(__this).addClass('loading');var _this=this,content=__this.html(),model_name=__this.attr('this-model'),model_to_bind=_this.page.find('model[this-id="'+model_name
+'"],[this-type="model"][this-id="'+model_name
+'"]');__this=internal.doTar.call(this,__this,true);__this.html(__this.children().attr('this-cache',__this.attr('this-model')||'').hide().outerHtml().replace(/\(\{/g,'__obrace2__').replace(/\}\)/g,'__cbrace2__'));if(model_name&&model_to_bind.length)
model_to_bind.attr('this-bind',true);var requestData={},save=true,success,error;if(_this.page.attr('this-query')){requestData['query']=_this.page.attr('this-query');save=false;}
if(__this.attr('this-search'))
requestData['keys']=__this.attr('this-search');success=function(data,uid){if(uid)
__this.attr('this-model-uid',uid);internal.loadData.call(_this,__this,data,content,false,save);__this.attr('this-loaded','').trigger('collection.loaded');if(looping)
_this.__proto__.collections--;if(chain&&!_this.collections)
internal.loadForms.call(_this,null,null,replaceState,chain);},error=function(){if(looping)
_this.__proto__.collections--;if(chain&&!_this.collections)
internal.loadForms.call(_this,null,null,replaceState,chain);};internal.loadOrRequestData.call(this,{elem:__this,content:content,data:data,success:success,error:error,looping:looping,chain:chain,replaceState:replaceState,requestData:requestData});return this;},loadForms:function(forms,model,replaceState,chain){var _this=this,isPage=false;if(!forms){isPage=this.page.is('form');forms=isPage?this.page:this.page.find('form');}
forms.each(function(i){var __this=_this._(this),elements=Array.from(this.elements);if(!__this.hasAttr('this-do')&&_this.page.attr('this-do'))
__this.attr('this-do',_this.page.attr('this-do'));if((__this.attr('this-do')==='search'||_this.page.attr('this-do')==='search')&&_this.page.attr('this-query')){__this.find('[this-search]').attr('value',_this.page.attr('this-query'));return;}
internal.doTar.call(_this,__this,true);var mid=__this.attr('this-mid')||_this.page.attr('this-mid'),model_name=__this.attr('this-model')||_this.page.attr('this-model');if(!mid)
return;if(!model)
model=internal.modelFromStore.call(_this,mid,model_name);if(model)
internal.loadFormElements.call(_this,elements,model);__this.attr('this-loaded','').trigger('form.loaded');});if(chain)
internal.pageLoaded.call(this,replaceState);return this;},loadFormElements:function(elements,model){if(!model)
return;var _this=this;this.__.forEach(elements,function(){var __this=_this._(this),key=__this.attr('this-is');if(!key)
return;var data=_this.__.extend({},model,true),keys=_this.__.contains(key,'.')?keys=key.split('.'):keys=[key];_this.__.forEach(keys,function(i,v){data=data[v];});if(__this.attr('type')==='radio'||__this.attr('type')==='checkbox'){if(__this.attr('value')==data||data==on)
__this.attr('checked','checked');return;}
else if(__this.is('select')){__this.children().each(function(){var val=_this._(this).attr('value')||_this._(this).html().trim();if(val==data)
_this._(this).attr('selected','selected');else
_this._(this).removeAttr('selected');});return;}
__this.attr('value',data);});return this;},pageLoaded:function(replaceState,restored){if(this.__proto__.collections||this.__proto__.models||this.__proto__.components)
return this;var _this=this;if(!restored){this.container.find('[this-inline-code]').each(function(){var __this=_this._(this);__this.replaceWith(_this._('<code this-code />').html(__this.html()));});this.container.find('[this-block-code]').each(function(){var __this=_this._(this);__this.replaceWith(_this._('<pre />').html(__this.html())).innerWrap('<code this-code />');});this.container.find('[this-code]').each(function(){var __this=_this._(this),tags=internal.parseBrackets.call(_this,'<','>',__this.html()),content=__this.html();_this.__.forEach(tags,function(i,v){content=content.replace(v,'&lt;'+v.substr(1,v.length-2)+'&gt;');});content=content.replace(/\n/g,'<br/>').replace(/\s/g,'&nbsp;');__this.html(content).removeAttr('this-code');});this.container.html(internal.processExpressions.call(this,this.container.html(),null,true));this.page.attr('this-loaded','');this.page=this.container.find('page[this-id="'+this.page.attr('this-id')
+'"]:not([this-dead]), [this-type="page"][this-id="'
+this.page.attr('this-id')+'"]:not([this-dead])');internal.resolveTargetOnPage.call(this);internal.saveState.call(this,replaceState);}
else{this.page.attr('this-restored','');}
if(this.firstPage){if(restored)
this.page.find('collection[this-loaded],[this-type="collection"]'
+'[this-loaded],model[this-loaded],[this-type="model"]'
+'[this-loaded]').each(function(){internal.watch.call(_this,this);});var watching=this.store('watching');if(watching)
this.__.forEach(watching,function(id,obj){internal.watch.call(_this,_this._('<div this-id="'+id
+'" this-type="'+obj.type+'" this-url="'
+obj.url+'" this-mid="'+obj.mid+'" />'));});delete this.firstPage;}
this.store('watching',this.watching);this.page.trigger('page.loaded');internal.updatePage.call(this);this._('script[this-page]:not([this-page="'+this.page.attr('this-id')
+'"])').remove();if(this.page.attr('this-load-js')&&!this._('script[this-page="'
+this.page.attr('this-id')+'"][this-id="'
+this.page.attr('this-load-js')+'"]').length){var url=this.config.paths.js+this.page.attr('this-load-js');if(!url.endsWith('.js'))
url+='.js';if(this.config.debug)
url+='?'+Math.round(Math.random()*99999);var script=this.__.createElement(null,'script').attr('type','application/javascript').attr('src',url).attr('this-id',this.page.attr('this-load-js')).attr('this-page',this.page.attr('this-id'));this._('body').append(script);}
return this;},loadData:function(container,data,content,isModel,save){container=this._(container);if(!data){container.trigger('invalid.response');return;}
var variables=internal.parseBrackets.call(this,'{{','}}',content),save_as=container.attr('this-model')||container.attr('this-id'),_data={data:{},expires:new Date().setMilliseconds(1000*3600*24)};if(this.config.dataKey){if(!isNaN(data.expires))
_data.expires=new Date().setMilliseconds(1000*data.expires);else if(this.__isString(data.expires))
_data.expires=new Date(data.expires).getTime();data=data[this.config.dataKey];}
if(this.__.isArray(data)||isModel===false){var __data=internal.canContinue.call(this,'collection.render',[data,container]);if(!__data){container.trigger('collection.render.canceled');return this;}
else if(this.__.isObject(__data,true))
data=__data;var _this=this,filter=container.attr('this-filter'),level=0,child=container.children().get(0),uid=container.attr('this-model-uid')||'id',url=container.attr('this-url');if(child){switch(child.tagName.toLowerCase()){case"td":level=3;content=_this._('<table />').html(content).outerHtml();break;case"tr":level=2;content=_this._('<table />').html(content).outerHtml();break;}}
this.__.forEach(data,function(index,model){if(save!==false)
_data.data[model[uid]||index]=model;var _content=internal.inLoop.call(_this,{index:index,model:model},filter,content.replace(/{{_index}}/g,index));if(!_content)
return;_content=_this._(internal.processExpressions.call(_this,_content,{index:index,model:model}));if(!model[uid])
model[uid]=index;internal.doLoad.call(_this,container,model,_content,variables,false,level);});if(save!==false){_data.uid=container.attr('this-model-uid')||'id';_data.url=url;}}
else if(data&&isModel){var __data=internal.canContinue.call(this,'model.render',[data,container]);if(!__data){container.trigger('model.render.canceled');return this;}
else if(this.__.isObject(__data))
data=__data;if(save!==false){save_as=container.attr('this-id');_data.data[data[container.attr('this-uid')||'id']]=data;var _url=container.attr('this-url').split('/');this.__.arrayRemoveIndex(_url,_url.length-1);_data.url=_url.join('/')+'/';}
data['_url']=container.attr('this-url');internal.doLoad.call(this,container,data,content,variables,true);}
container.removeAttr('this-filter').show();if(save!==false)
internal.cache.call(this,'model',save_as,_data,true);return this;},doLoad:function(container,data,content,variables,isModel,level){if(isModel)
content=internal.processExpressions.call(this,content,data);container=this._(container).hide();var _temp=internal.parseData.call(this,data,content,variables,false,isModel),id=container.attr('this-model-uid')||container.attr('this-uid')||'id';while(level){_temp=_temp.children();level--;}
if(!isModel){_temp.attr('this-mid',(data[id]||data[id]==0?data[id]:'')).attr('this-uid',id).attr('this-type','model').attr('this-in-collection','').attr('this-url',container.attr('this-url')
+(data[id]||data[id]==0?data[id]:''));if(container.attr('this-model'))
_temp.attr('this-id',container.attr('this-model'));container.append(_temp.show()).removeAttr('this-cache').removeClass('loading');}
else{container.attr('this-uid',id).attr('this-mid',data[id]);container.html(_temp.html());}
return this;},eval:function(content,data){var variables=internal.parseBrackets.call(this,'{{','}}',content);content=internal.fillVariables.call(this,variables,data,content);return eval(content);},parseBrackets:function(oBrace,cBrace,content){return this.__.tryCatch(function(){return content.match(new RegExp(oBrace+'\\s*[^'+cBrace+']+\\s*'
+cBrace,'gi'))||[];});},regEsc:function(str){return str.replace(/[-[\]{}()*+?.,\\/^$|#\s]/g,"\\$&");},getExpressions:function(content){var exps=[];this.__.forEach(content.split('({'),function(i,v){if(!i)
return;exps.push('({'+v.split('})')[0]+'})');});return exps;},processExpressions:function(content,current,removeUnresolved){var _this=this,exps=internal.getExpressions.call(this,content);this.__.forEach(exps,function(i,v){_this.tryCatch(function(){content=content.replace(v,eval(v.trim().substr(2,v.trim().length-4)));},function(e){_this.console('error',e.message);if(removeUnresolved)
content=content.replace(v,'');});});return content;},parseData:function(data,content,variables,forCollection,isModel){if(!variables)
variables=internal.parseBrackets.call(this,'{{','}}',content);var _temp,_this=this,custom=false;if(this.__.isString(content)){content=content.replace(/__obrace2__/g,'({').replace(/__cbrace2__/g,'})');_temp=this._('<div/>').html(content);custom=true;}
else{_temp=content;}
_temp.find('[this-each]').each(function(){var __this=_this._(this),_data=data[__this.attr('this-each')],filter=__this.attr('this-filter'),each=__this.attr('this-each').trim(),content=__this.removeAttr('this-muted').html().replace(/__obrace__/g,'{{').replace(/__cbrace__/g,'}}').replace(/__obrace2__/g,'({').replace(/__cbrace2__/g,'})'),level=0,child=__this.children().get(0);if(child){switch(child.tagName.toLowerCase()){case"td":level=3;content=_this._('<table />').html(content).outerHtml();break;case"tr":level=2;content=_this._('<table />').html(content).outerHtml();break;}}
__this.removeAttr('this-filter').html('');if(!_data){if(each.startsWith('{(')){_data=internal.eval.call(_this,each.substr(1,each.length-2),data);}
else if(each.startsWith('{{')){_data=internal.getVariableValue.call(_this,each,data,true);}}
if(!_this.__.isObject(_data,true))
return;_this.__.forEach(_data,function(key,value){var __data={key:key,value:value},_content=internal.inLoop.call(_this,__data,filter,content);if(!_content)
return;_content=internal.processExpressions.call(_this,_content,__data);var _variables=internal.parseBrackets.call(_this,'{{','}}',_content),_content=_this._(internal.fillVariables.call(_this,_variables,__data,_content).replace(/{{key}}/g,key));while(level){_content=_content.children();level--;}
__this.append(_content);});__this.removeAttr('this-each');});if(isModel){_temp.find('collection[this-data],[this-type="collection"][this-data]').each(function(){_this._(this).html(this.innerHTML.replace(/{{/g,'__obrace__').replace(/}}/g,'__cbrace__').replace(/\({/g,'__obrace2__').replace(/}\)/g,'__cbrace2__'));});}
if(forCollection){content=internal.inLoop.call(this,{index:forCollection,model:data},'true',_temp.outerHtml());content=internal.processExpressions.call(this,content,{index:forCollection,model:data});}
else{content=internal.inLoop.call(this,data,'true',_temp.outerHtml());content=internal.processExpressions.call(this,content,data);}
content=internal.fillVariables.call(this,variables,data,content);_temp.replaceWith(content);if(isModel){_temp.find('collection[this-data],[this-type="collection"][this-data]').each(function(){var __this=_this._(this).html(this.innerHTML.replace(/__obrace__/g,'{{').replace(/__cbrace__/g,'}}').replace(/__obrace2__/g,'({').replace(/__cbrace2__/g,'})'));internal.loadCollection.call(_this,__this,false,false,false,internal.getVariableValue.call(_this,__this.attr('this-data'),data,true));});}
if(custom)
_temp=_temp.children();return _temp.show();},inLoop:function(current,filter,content){if(filter&&!eval(filter.trim()))
return;content=this._(document.createElement('div')).html(content);var _this=this,level=0,matched={};content.find('[this-each]').each(function(){var __this=_this._(this).attr('this-muted','');__this.html(__this.html().replace(/\{\{/g,'__obrace__').replace(/\}\}/g,'__cbrace__').replace(/\(\{/g,'__obrace2__').replace(/\}\)/g,'__cbrace2__')).find('[this-if], [this-else-if], [this-else]').attr('this-ignore','');});content.find('[this-if],[this-else-if],[this-else]').each(function(){var __this=_this._(this);if(__this.attr('this-if')&&!__this.hasAttr('this-ignore')){level++;if(eval(__this.attr('this-if').trim())){__this.removeAttr('this-if');matched[level]=true;}
else{matched[level]=false;__this.remove();}
if(__this.hasAttr('this-end-if')){__this.removeAttr('this-end-if');delete matched[level];level--;}}
else if(__this.attr('this-else-if')&&!__this.hasAttr('this-ignore')){if(!__.isBoolean(matched[level])){_this.error('Branching error: Else-if without If!');return;}
if(matched[level]||!eval(__this.attr('this-else-if').trim()))
__this.remove();else{__this.removeAttr('this-else-if');matched[level]=true;}
if(__this.hasAttr('this-end-if')){__this.removeAttr('this-end-if');delete matched[level];level--;}}
else if(__this.hasAttr('this-else')&&!__this.hasAttr('this-ignore')){if(!__.isBoolean(matched[level])){_this.error('Branching error: Else without If!');return;}
if(matched[level])
__this.remove();else
__this.removeAttr('this-else');if(__this.hasAttr('this-end-if'))
__this.removeAttr('this-end-if');delete matched[level];level--;}});content.find('[this-ignore]').removeAttr('this-ignore');return content.html();},getVariableValue:function(variable,data,raw){var _this=this,vars=variable.replace(/{*}*/g,'').replace(/\\\|/g,'__fpipe__').split('|'),key=this.__.arrayRemoveIndex(vars,0),value=this.__.contains(key,'.')?internal.getDeepValue.call(null,key,data):data[key];if(value||value==0)
this.__.forEach(vars,function(i,v){v=v.replace(/__fpipe__/g,'|');var exp=v.split(':'),filter=_this.__.arrayRemoveIndex(exp,0);if(Filters[filter])
value=Filters[filter](value,exp.join(':'));if(!value)
return false;});if(!value&&value!=0)
return;return value;},fillVariables:function(variables,data,content){var _this=this;this.__.forEach(variables,function(i,v){var value=internal.getVariableValue.call(_this,v,data);content=content.replace(v,value||value==0?value:v);});return content;},getDeepValue:function(variable,data){var value=data,vars=__.isObject(variable,true)?variable:variable.split('.');__.forEach(vars,function(i,v){if(!value)
return false;value=value[v];});return value||value==0?value:'';},saveState:function(replace){var action='pushState';if(replace||this.firstPage)
action='replaceState';history[action]({id:this.page.attr('this-id'),title:this.page.attr('this-title'),content:this.container.html()},this.page.attr('this-title'),'#'
+this.page.attr('this-id'));this.store('last_page',this.page.attr('this-id'));return this;},restoreState:function(state){if(this.page){this.page.trigger('page.leave');}
this.container.html(state.content);this.page=this.container.find('page[this-id="'+state.id
+'"]:not([this-dead]),[this-type="page"][this-id="'+state.id
+'"]:not([this-dead])');if(this.config.titleContainer)
this.config.titleContainer.html(state.title);this.store('last_page',state.id);this.__proto__.components=0;this.__proto__.collections=0;this.__proto__.models=0;internal.pageLoaded.call(this,null,true);},updatePage:function(){var deleted=internal.cache.call(this,'deleted')||{},created=internal.cache.call(this,'created')||{},updated=internal.cache.call(this,'updated')||{},collection=internal.cache.call(this,'model')||{},_this=this,_collections=this.page.find('collection[this-loaded],'
+'[this-type="collection"][this-loaded]'),_models=this.page.find('model:not([this-cache]),'
+'[this-type="model"]:not([this-cache])'),touched={deleted:{},created:false,updated:false,back:false,cancel:false};if(_collections.length){this.__.forEach(created,function(model_name,arr){var _collection=_this.page.find('collection[this-model="'+model_name
+'"][this-loaded],[this-type="collection"][this-model="'
+model_name+'"][this-loaded]');if(!_collection.length)
return;var __collection=collection[model_name],uid=__collection.uid;_this.__.forEach(arr,function(i,v){var data=__collection.data[v],__data=internal.canContinue.call(_this,'collection.model.render',[data]);if(!__data){_collection.trigger('collection.model.render.canceled');return;}
else if(_this.__.isObject(__data))
data=__data;var tmpl=internal.parseData.call(_this,data,_collection.children('[this-cache]').clone().removeAttr('this-cache').outerHtml(),null,v),action=_collection.attr('this-prepend-new')?'prepend':'append';_collection[action](tmpl.attr('this-mid',v).attr('this-uid',uid).attr('this-type','model').attr('this-id',model_name).attr('this-url',_collection.attr('this-url')+v).attr('this-in-collection','').outerHtml());_this.__.arrayRemoveIndex(arr,i);});if(!created[model_name].length)
delete created[model_name];touched.created=true;});}
if(_models.length){this.__.forEach(updated,function(model_name,arr){var _model=_this.page.find('model[this-id="'+model_name
+'"]:not([this-cache]),[this-type="model"][this-id="'
+model_name+'"]:not([this-cache]),'
+'collection[this-model="'+model_name
+'"]>[this-type="model"],'
+'[this-type="collection"][this-model="'+model_name
+'"]>[this-type="model"]'),in_collection=false;if(!_model.length)
return;_this.__.forEach(arr,function(id,v){_model.filter(function(){return this.getAttribute('this-mid')==id;}).each(function(){var __model=_this._(this);if(__model.hasAttr('this-in-collection'))
in_collection=true;var data=v,__data=internal.canContinue.call(_this,in_collection?'collection.model.render':'model.render',[data]);if(!__data){if(in_collection)
_model.parent().trigger('collection.model.render.canceled');else
_model.trigger('model.render.canceled');return;}
else if(_this.__.isObject(__data))
v=__data;var tmpl=internal.parseData.call(_this,v,__model.siblings('[this-cache]').clone().removeAttr('this-cache').outerHtml(),null,id);__model.html(tmpl.html()).show();});});if(in_collection)
delete updated[model_name];touched.updated=true;});this.__.forEach(deleted,function(model_name,arr){_this.__.forEach(arr,function(i,mid){var _model=_this.page.find('model[this-id="'+model_name
+'"][this-mid="'+mid+'"]:not([this-cache]),'
+'[this-type="model"][this-id="'
+model_name+'"][this-mid="'+mid+'"]:not([this-cache]),'
+'collection[this-model="'+model_name
+'"]>[this-type="model"][this-mid="'+mid+'"],'
+'[this-type="collection"][this-model="'+model_name
+'"]>[this-type="model"][this-mid="'+mid+'"]');if(!_model.length)
return;_model.each(function(){var __model=_this._(this);__model.hide();if(__model.hasAttr('this-in-collection')){if(!touched.deleted[model_name]){touched.deleted[model_name]=[];}
touched.deleted[model_name].push(mid);__model.remove();}
else{if(!__model.hasAttr('this-binding')&&_this.page.attr('this-reading')&&_models.length===1){touched.back=true;return false;}
else{__model.removeAttr('this-url').removeAttr('this-mid').html('');}}});});});}
if(touched.cancel)
return;if(touched.updated)
this.store('updated',updated);if(touched.created)
this.store('created',created);var del=false;this.__.forEach(touched.deleted,function(mod,arr){_this.__.forEach(arr,function(i,v){_this.__.arrayRemoveValue(deleted[mod],v);del=true;});if(!deleted[mod].length)
delete deleted[mod];if(!Object.keys(deleted).length)
deleted=null;});if(del)
this.store('deleted',deleted);if(touched.back)
return this.back();else if(touched.created||touched.updated||touched.deleted){if(touched.updated)
internal.loadForms.call(this);internal.saveState.call(this,true);}},is:function(type,container){return this._(container).attr('this-type')===type||this._(container).is(type);},selector:function(id,append){id=id.split('#');if(!append)
append='';var attrs=id[id.length-1].split('[');id[id.length-1]=attrs[0];this.__.arrayRemoveIndex(attrs,0);if(attrs.length)
append+='['+attrs.join('[');return id.length>1?'[this-type="'+id[0]+'"][this-id="'+id[1]+'"]'+append+','+id[0]+'[this-id="'+id[1]+'"]'+append:'[this-id="'+id[0]+'"]'+append;},groupConsoleOutput:function(name,func,isMethod){if(isMethod)
name+='(...)';if(internal.debugLevel.call(this)>=2)
this.console('group',name);var result=this.tryCatch(this.__.callable(func));if(internal.debugLevel.call(this)>=2)
this.console('groupEnd');return result;},debugLevel:function(){if(this.__.isBoolean(this.config.debug))
return this.config.debug?3:0;return this.config.debug;}}),Transitions=Object.create({show:function(pageOff,pageOn){pageOff.remove();pageOn.show();return this;}}),Filters=Object.create({lowercase:function(item){var _this=this;if(__.isArray(item)){var arr=[];__.forEach(item,function(i,v){var _item=_this.lcase(v);if(_item)
arr.push(_item);});return arr;}
else if(__.isString(item))
return item.toLowerCase();},uppercase:function(item){var _this=this;if(__.isArray(item)){var arr=[];__.forEach(item,function(i,v){var _item=_this.ucase(v);if(_item)
arr.push(_item);});return arr;}
else if(__.isString(item))
return item.toUpperCase();},capitalize:function(item,options){return this.ucwords(item,options);},smallize:function(item){return this.lcfirst(item);},lcase:function(item){return this.lowercase(item);},ucase:function(item){return this.uppercase(item);},ucfirst:function(item){var _this=this;if(__.isArray(item)){var arr=[];__.forEach(item,function(i,v){var _item=_this.ucfirst(v);if(_item)
arr.push(_item);});return arr;}
else if(__.isString(item))
return item[0].toUpperCase()+item.substr(1);},lcfirst:function(item){var _this=this;if(__.isArray(item)){var arr=[];__.forEach(item,function(i,v){var _item=_this.lcfirst(v);if(_item)
arr.push(_item);});return arr;}
else if(__.isString(item))
return item[0].toLowerCase()+item.substr(1);},ucwords:function(item,options){var _this=this;if(__.isArray(item)){var arr=[];__.forEach(item,function(i,v){var _item=_this.ucwords(v,options);arr.push(_item);});return arr;}
else if(__.isString(item))
return item.replace(options==='-'?/[^-'\s]+/g:/[^\s]+/g,function(word){return word.replace(/^./,function(first){return first.toUpperCase();});});},snakeToCamel:function(item,ucfirst){var _this=this;if(__.isArray(item)){var arr=[];__.forEach(item,function(i,v){var _item=_this.snakeToCamel(v,ucfirst);if(_item)
arr.push(_item);});return arr;}
else if(__.isString(item)){var _item=item.replace(/(\_\w)/g,function(w){return w[1].toUpperCase();});return ucfirst?this.ucfirst(_item):_item;}},camelToSnake:function(item){var _this=this;if(__.isArray(item)){var arr=[];__.forEach(item,function(i,v){var _item=_this.camelToSnake(v);if(_item)
arr.push(_item);});return arr;}
else if(__.isString(item)){var _item=item.replace(/([A-Z])/g,function(i){return'_'+i.toLowerCase();});return this.lcfirst(_item);}},camelToHyphen:function(item){var _this=this;if(__.isArray(item)){var arr=[];__.forEach(item,function(i,v){var _item=_this.camelToSnake(v);if(_item)
arr.push(_item);});return arr;}
else if(__.isString(item)){var _item=item.replace(/([A-Z])/g,function(i){return'-'+i.toLowerCase();});return this.lcfirst(_item);}},contains:function(val,options){if(__.isObject(val,true)){options=options.split(',');return this.filter(val,function(v){var search=options[0];if(options.length>1){v=internal.getDeepValue.call(null,options[0],v);search=options[1];}
return v&&(__.isString(v)||__.isArray(v))&&__.contains(v,search);});}
else if(__.isString(val)){return __.contains(val,options)?val:null;}
return null;},filter:function(obj,func){func=__.callable(func,true);if(func){if(__.isArray(obj)){return obj.filter(func);}
else{var newObj={};__.forEach(obj,function(i,v){if(true===func.call(null,v,i)){newObj[i]=v;}});return newObj;}}
return obj;},trim:function(str){if(__.isArray(str)){var _this=this,arr=[];__.forEach(str,function(i,v){arr.push(_this.trim(v));});return arr;}
else if(__.isString(str))
return str.trim();},split:function(str,separator){return this.__(str,separator,function(str,separator){return str.split(separator);});},join:function(str,separator){if(!__.isArray(str))
return str;return str.join(separator);},replace:function(str,options){return this.__(str,options,function(str,search,replace){search=search.replace(/_/g,'-u-');str=str.replace(/_/g,'-u-');var res=str.replace(new RegExp(eval(search),'g'),replace);return res.replace(/-u-/g,'_');},function(str,search,replace){return str.replace(new RegExp(search,'g'),replace);});},__:function(str,options,funcA,funcB){if(__.isArray(str)){var arr=[],_this=this;__.forEach(str,function(i,v){arr.push(_this.__(v,options,funcA,funcB));});return arr;}
else if(__.isString(str)){options=this.__opts(options);options.unshift(str);return __.tryCatch(function(){return __.callable(funcA).apply(this,options);}.bind(this),function(){return __.callable(funcB).apply(this,options);}.bind(this));}},__opts:function(options){options=options.replace(/\\,/g,'__fcomma__').split(',');__.forEach(options,function(i,v){options[i]=v.replace(/__fcomma__/g,',');});return options;}}),Model=function(id,attributes,props){function toURL(attributes,_key){var url='';__.forEach(attributes,function(key,value){if(_key)
key=__.isString(key)?_key+'['+key+']':_key+'[]';if(url)
url+='&';if(__.isObject(value,true)){url+=toURL(value,key);}
else{url+=encodeURIComponent(key)+'='+encodeURIComponent(value);}});return url;}
var _Model=Object.create({name:props&&props.name?props.name:null,app:props&&props.app?props.app:null,uid:props&&props.uid?props.uid:'id',url:props&&props.url?props.url:null,id:id,collection:props&&props.collection?props.collection:null,method:props&&props.method?props.method:null,attributes:__.isObject(attributes)?attributes:{},init:function(attr){this['get'+Filters.snakeToCamel(attr,true)]=function(){return this.attributes[attr];};this['set'+Filters.snakeToCamel(attr,true)]=function(val){this.attributes[attr]=val;return this;};},toURL:function(){return toURL(this.attributes);},save:function(config){config=this.app.__.extend({},config);var _this=this,method=this.id?'PUT':'POST';if(!this.app){console.error('Invalid model object');return false;}
else if(!this.name){_this.app.error('Cannot save an unnamed model.');return false;}
if(this.method)
method=this.method;if(this.id&&config.cacheOnly)
internal.modelToStore.call(this.app,this.name,this.id,this.attributes,this.uid);else if(_this.url){var _success=function(data,id){var model=_this.app.config.dataKey?data[_this.app.config.dataKey]:data;if(model){if(!_this.app.watchCallback){internal.modelToStore.call(_this.app,_this.name,_this.id,model,_this.uid);var _action=_this.id?'updated':'created',action=_this.app.store(_action)||{};}
if(_this.collection)
_this.collection.models[_this.id]=model;if(_this.id){if(!_this.app.watchCallback){if(!action[_this.name])
action[_this.name]={};action[_this.name][_this.id]=model;_this.app.store(_action,action);}}
else{if(!_this.app.watchCallback){_this.id=id||model[_this.uid];_this.url+=_this.id;if(!action[_this.name])
action[_this.name]=[];action[_this.name]=_this.app.__.arrayRemoveValue(action[_this.name],_this.id,true);action[_this.name].push(_this.id);_this.app.store(_action,action);}
if(_this.collection)
_this.collection.length++;}
_this.attributes=model;if(!_this.app.watchCallback)
internal.updatePage.call(_this.app);}
_this.app.__.callable(config.success).call(_this.app,data);_this.app.__.callable(config.complete).call(_this.app);},_error=function(e){_this.app.__.callable(config.error).call(this,e);_this.app.__.callable(config.complete).call(this,e);};if(this.app.dataTransport)
this.app.__.callable(this.app.dataTransport).call(this.app,{url:this.url,id:this.id,data:this.attributes,action:this.id?'update':'create',success:_success,error:_error});else
this.app.ajax({type:config.method||method,url:_this.app.config.baseURL?_this.app.config.baseURL+
_this.url:_this.url,data:this.toURL(),success:_success,error:_error});return true;}
else{_this.app.error('Cannot save model to server: No URL supplied.');}
return false;},remove:function(config){config=this.app.__.extend({},config);var _this=this;if(!this.app){console.error('Invalid model object');return false;}
else if(!this.name){_this.app.error('Cannot delete an unnamed model.');return false;}
else if(!this.id){_this.app.error('Cannot delete a model without an id.');return false;}
if(config.cacheOnly)
internal.removeModelFromStore.call(this.app,this.name,this.id);else if(this.url){var _success=function(data,id){var model=_this.app.config.dataKey?data[_this.app.config.dataKey]:data;if(model){_this.id=id||model[_this.uid];_this.attributes=model;if(!_this.app.watchCallback){internal.removeModelFromStore.call(_this.app,_this.name,_this.id);var deleted=_this.app.store('deleted')||{};if(!deleted[_this.name])
deleted[_this.name]=[];deleted[_this.name]=_this.app.__.arrayRemoveValue(deleted[_this.name],_this.id,true);deleted[_this.name].push(_this.id);_this.app.store('deleted',deleted);internal.updatePage.call(_this.app);}
if(_this.collection){delete _this.collection.models[_this.id];_this.collection.length--;}}
_this.app.__.callable(config.success).call(this,data);_this.app.__.callable(config.complete).call(this);},_error=function(e){_this.app.__.callable(config.error).call(this,e);_this.app.__.callable(config.complete).call(this,e);};if(this.app.dataTransport)
this.app.__.callable(this.app.dataTransport).call(this.app,{url:this.url,id:this.id,action:'delete',success:_success,error:_error});else
this.app.ajax({type:config.method||'delete',url:_this.app.config.baseURL+_this.url,success:_success,error:_error});}
else{this.app.error('Cannot remove model from server: No URL supplied.');return false;}
return true;},bind:function(elem){elem=this.app._(elem);elem.attr('this-mid',this.id).attr('this-uid',this.uid).attr('this-url',this.url);internal.loadModel.call(this.app,elem,this.attributes,true);internal.loadForms.call(this.app,elem.is('form')?elem:elem.find('form'),this.attributes);return this;}});if(__.isObject(attributes)){__.forEach(attributes,function(key){_Model.init(key);});}
_Model.parent=_Model.__proto__;delete _Model.init;return _Model;},Collection=function(models,props){var _Collection=Object.create({name:props&&props.name?props.name:null,app:props&&props.app?props.app:null,uid:props&&props.uid?props.uid:'id',url:props&&props.url?props.url:null,current_index:-1,models:__.isObject(models)?models:{},get:function(index){var key=Object.keys(this.models)[index];if(key)
this.parent.current_index=index;return this.model(key);},first:function(){return this.get(0);},last:function(){return this.get(this.length-1);},current:function(){return this.get(this.parent.current_index||0);},next:function(){return this.get(this.parent.current_index+1);},rewind:function(){this.parent.current_index=-1;return this;},hasNext:function(){var current_index=this.parent.current_index,model=this.next();this.parent.current_index=current_index;return model!==null;},model:function(model_id){var _this=this;return model_id&&this.models[model_id]?new Model(model_id,this.models[model_id],{name:_this.name,app:_this.app,uid:_this.uid,url:_this.url+model_id,collection:this}):null;},add:function(attributes,config){var model=new Model(null,attributes,{name:this.name,app:this.app,uid:this.uid,url:this.url,collection:this});if(model.save(config))
return model;return false;},remove:function(model_id,config){config=this.app.__.extend({},config);if(model_id===undefined){if(config.cacheOnly){this.app.store(this.name,null);this.models={};this.length=0;}
else{var _this=this,_success=function(data){if(!_this.app.watchCallback)
_this.app.clearCache('model',_this.name);_this.models={};_this.length=0;_this.app.__.callable(config.success).call(_this,data);_this.app.__.callable(config.complete).call(_this);},_error=function(e){_this.app.__.callable(config.error).call(_this,e);_this.app.__.callable(config.complete).call(_this);};if(this.app.dataTransport)
this.__.callable(this.app.dataTransport).call(this,{url:this.url,action:'delete',success:_success,error:_error});else
this.app.ajax({url:this.app.config.baseURL+this.url,type:config.method||'delete',success:_success,error:_error});}
return true;}
var model=this.model(model_id);if(!model)
return false;model.remove(config);delete this.models[model_id];this.length--;return model;}});_Collection.length=props&&props.length?props.length:0;_Collection.parent=_Collection.__proto__;return _Collection;};_.prototype=__.__proto__;ThisApp=function(config){if(!(this instanceof ThisApp))
return new ThisApp(config);this.version='1.0';if(config&&__.isObject(config))
this.config=this.__.extend(this.config,config,true);this.debug(this.config.debug);};ThisApp.Transitions={add:function(name,func){if(name&&func&&!Transitions[name]){Transitions[name]=func;}
return this;},overwrite:function(name,func){if(name&&func){Transitions[name]=func;}
return this;},exists:function(name){return Transitions[name]!==undefined;}};ThisApp.Filters={add:function(name,func){if(name&&func&&!Filters[name]){Filters[name]=func;}
return this;},overwrite:function(name,func){if(name&&func){Filters[name]=func;}
return this;},exists:function(name){return Transitions[name]!==undefined;}};ThisApp.extend=function(obj){__.forEach(obj,function(i,v){if(!ThisApp.prototype[i])
ThisApp.prototype[i]=function(){var args=Array.from(arguments);args.unshift(internal);return __.callable(v).apply(this,args);};else
console.error('ThisApp.'+i+' already exists!');});};ThisApp.prototype={transporterOnline:false,watching:{},beforeCallbacks:{},events:[],config:{startWith:null,baseURL:location.origin+location.pathname,debug:false,dataKey:'data',titleContainer:null,transition:'show',transitionOptions:{},layout:null,paths:{pages:{dir:'./pages',ext:'.html'},layouts:{dir:'./layouts',ext:'.html'},components:{dir:'./components',ext:'.html'},js:'./assets/js',css:'./assets/css'}},tar:{},components:0,collections:0,models:0,__:__,_:function(selector,debug){return _(selector,debug||this.config.debug);},setBaseUrl:function(url){return internal.groupConsoleOutput.call(this,'setBaseUrl',function(){this.config.baseURL=url;return this;},true);},debug:function(debug){return internal.groupConsoleOutput.call(this,'debug',function(){this.config.debug=debug||false;this.__.__proto__.debug=this.config.debug;return this;},true);},setDataKey:function(key){return internal.groupConsoleOutput.call(this,'setDataKey',function(){this.config.dataKey=key;return this;},true);},setTitleContainer:function(container){return internal.groupConsoleOutput.call(this,'setTitleContainer',function(){this.config.titleContainer=this.running?this._(container):container;return this;},true);},setTransition:function(transition,options){return internal.groupConsoleOutput.call(this,'setTransition',function(){this.config.transition=transition;this.config.transitionOptions=options;return this;},true);},getAvailableTransitions:function(){return internal.groupConsoleOutput.call(this,'getAvailableTransitions',function(){return Object.keys(Transitions);},true);},getAvailableFilters:function(){return internal.groupConsoleOutput.call(this,'getAvailableFilters',function(){return Object.keys(Filters);},true);},setLayout:function(layout){return internal.groupConsoleOutput.call(this,'setLayout',function(){this.config.layout=layout;return this;},true);},setPagesPath:function(path,ext){return internal.groupConsoleOutput.call(this,'setPagesPath',function(){if(!this.config.paths)
this.config.paths={};this.__proto__.config.paths.pages={dir:path,ext:ext||'.html'};return this;},true);},setLayoutsPath:function(path,ext){return internal.groupConsoleOutput.call(this,'setLayoutsPath',function(){if(!this.config.paths)
this.config.paths={};this.__proto__.config.paths.layouts={dir:path,ext:ext||'.html'};return this;},true);},setComponentsPath:function(path,ext){return internal.groupConsoleOutput.call(this,'setComponentsPath',function(){if(!this.config.paths)
this.config.paths={};this.__proto__.config.paths.components={dir:path,ext:ext||'.html'};return this;},true);},setJSPath:function(path){return internal.groupConsoleOutput.call(this,'setJSPath',function(){if(!this.config.paths)
this.config.paths={};this.__proto__.config.paths.js=path;return this;},true);},setCSSPath:function(path){return internal.groupConsoleOutput.call(this,'setCSSPath',function(){if(!this.config.paths)
this.config.paths={};this.__proto__.config.paths.css=path;return this;},true);},start:function(page,fromState){return internal.groupConsoleOutput.call(this,'start',function(){if(this.running)
return this;if(page)
this.config.startWith=page;this.container=this._(this.config.container).html('');this.firstPage=true;internal.setup.call(this);var target_page=internal.pageIDFromLink.call(this,location.hash);if(fromState!==false&&history.state&&target_page===this.store('last_page')){internal.restoreState.call(this,history.state);}
else{this.loadPage(target_page||this.config.startWith||this._('page[this-default-page]:not([this-current]):not([this-dead]),'
+'[this-type="pages"] [this-default-page]').attr('this-id'));}
return this;},true);},before:function(event,callback){return internal.groupConsoleOutput.call(this,'before',function(){this.beforeCallbacks[event]=callback;return this;},true);},loadPage:function(page,replaceInState){return internal.groupConsoleOutput.call(this,'loadPage',function(){if(!page)
return;this.oldPage=_();var newPage=this._('page[this-id="'+page
+'"]:not([this-current]):not([this-dead]),'
+'[this-type="pages"]>[this-id="'+page+'"]');if(newPage.length>1){this.error('Target page matches multiple pages!');return this;}
if(!newPage.length){if(this.config.paths&&this.config.paths.pages){var _this=this;internal.fullyFromURL.call(this,'page',page,function(elem){internal.pageFound.call(_this,elem,replaceInState);},function(){internal.notAPage.call(_this,page);});return this;}
internal.notAPage.call(this,page);return this;}
this.__proto__.components=0;this.__proto__.collections=0;this.__proto__.models=0;internal.pageFound.call(this,newPage,replaceInState);return this;},true);},pageNotFound:function(callback){return internal.groupConsoleOutput.call(this,'pageNotFound',function(){this.notFound=callback;return this;},true);},home:function(){return internal.groupConsoleOutput.call(this,'home',function(){this.loadPage(this.config.startWith||this._('page[this-default-page]:not([this-current]):not([this-dead]),'
+'[this-type="pages"] [this-default-page]').attr('this-id'));return this;},true);},back:function(e){return internal.groupConsoleOutput.call(this,'back',function(){if(e&&this.__.isObject(e)&&e['preventDefault'])
e.preventDefault();if(history.length<=2){this.home();return;}
history.back();return this;},true);},forward:function(e){return internal.groupConsoleOutput.call(this,'forward',function(){if(e&&this.__.isObject(e)&&e['preventDefault'])
e.preventDefault();history.forward();return this;},true);},when:function(event,target,callback){return internal.groupConsoleOutput.call(this,'when',function(){var selector="",targets=target.split(',');if(selector)
selector+=', ';this.__.forEach(targets,function(i,v){switch(target){case"page":selector+='page,[this-type="page"]';break;case"collection":selector+='collection,[this-type="collection"]';break;case"model":selector+='model,[this-type="model"]';break;case"component":selector+='component,[this-type="component"]';break;default:var exp=v.split('#');if(exp.length>1&&exp[0]){selector+='[this-type="'+exp[0]+'"][this-id="'+exp[1]+'"]';}
else{selector+='[this-id="'+v+'"]';}}});return this.on(event,selector,callback);},true);},on:function(event,selector,callback){return internal.groupConsoleOutput.call(this,'on',function(){if(this.running)
this.container.on(event,selector,callback);else
this.events.push({event:event,selector:selector,callback:callback});return this;},true);},onError:function(callback){return internal.groupConsoleOutput.call(this,'onError',function(){this.error=function(message){this.__proto__.error(message);this.__.callable(callback,true).call(this,message);};return this;},true);},ajax:function(config){return internal.groupConsoleOutput.call(this,'ajax',function(){if(!this.__.isObject(config)){this.console('error','Method ajax() expects an object parameter. '
+typeof config+' given');return this;}
return this.__.ajax(config);},true);},request:function(url,success,error,data,responseType){return internal.groupConsoleOutput.call(this,'request',function(){if(!url){this.console('error','Method request() expects parameter 1 to be string. '
+typeof url+' given');return this;}
if(!url.startsWith('./')&&!url.startsWith('../')&&url.indexOf('://')===-1)
url=this.config.baseURL+url;return this.ajax({type:'get',url:url,dataType:responseType||'json',data:data||{},clearCache:this.config.debug,success:success,error:error});},true);},watch:function(callback){return internal.groupConsoleOutput.call(this,'watch',function(){this.watchCallback=callback;return this;},true);},error:function(msg){this.console('warn',msg);return this;},console:function(method,param){if(this.config.debug)
console[method].apply(null,this.__.isArray(param)?param:[param]);return this;},store:function(key,value){return internal.groupConsoleOutput.call(this,'store',function(){if(!key)
return localStorage;if(!value){if(value===null){localStorage.removeItem(key);return this;}
var data=localStorage.getItem(key),_data=this.__.toJSONObject(data);return _data||data;}
if(this.__.isObject(value,true))
value=this.__.toJSONString(value);if(value)
localStorage.setItem(key,value);return this;},true);},tryCatch:function(tryFunc,catchFunc){return this.__.tryCatch(function(){return this.__.callable(tryFunc).call(this);}.bind(this),function(e){if(catchFunc)
this.__.callable(catchFunc).call(this,e);else
this.error(e);}.bind(this));},reload:function(){return internal.groupConsoleOutput.call(this,'reload',function(){location.reload();return this;},true);},collection:function(model_name,url,data,success,error){return internal.groupConsoleOutput.call(this,'collection',function(){if(!model_name)
return new Collection([],{app:this});if(!data){var collection=internal.cache.call(this,'model',model_name);if(collection&&collection.data)
data=collection.data;}
else if(data){if(this.config.dataKey&&!data[this.config.dataKey]){var _data={};_data[this.config.dataKey]=data;data=_data;}
internal.cache.call(this,'model',model_name,data);}
if(data)
return new Collection(data,{name:model_name,app:this,uid:collection.uid||'id',url:collection.url||null,length:collection.length||0});else if(this.dataTransport){var _collection=this._('collection[this-model="'+model_name
+'"][this-loaded],[this-type="collection"][this-model="'+model_name
+'"][this-loaded]');if(!_collection.length)
_collection=this._('collection[this-id="'+model_name
+'"][this-loaded],[this-type="collection"][this-id="'+model_name+'"][this-loaded]');if(!_collection.length)
_collection=this._('<collection this-model="'+model_name+'" this-url="'
+(url||model_name)+'" />');_collection.attr('this-no-updates');var _this=this;return this.request(_collection,function(data,uid){return _this.__.callable(success).call(_this,new Collection(data,{name:model_name,app:_this,uid:_collection.attr('this-model-uid')||uid||'id',url:_collection.attr('this-url'),length:Object.keys(data).length||0}));},error);}},true);},setDataTransport:function(callback){return internal.groupConsoleOutput.call(this,'setDataTranport',function(){if(callback)
this.dataTransport=callback;return this;},true);}};})();